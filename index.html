<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi·ªát ƒê·ªôi Giao Th√¥ng Xanh - TH Nam H√† test 1.1.0 </title>
    
    <!-- Google Fonts: Baloo 2 & Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['"Baloo 2"', 'cursive', 'sans-serif'],
                    },
                    colors: {
                        traffic: {
                            red: '#FF5252',
                            yellow: '#FFD740', 
                            green: '#00E676',
                            dark: '#2C3E50',
                            light: '#ECEFF1',
                        },
                        brand: {
                            blue: '#448AFF',
                        }
                    },
                    boxShadow: {
                        'cartoon': '0 6px 0 rgba(0,0,0,0.15)',
                        'cartoon-hover': '0 3px 0 rgba(0,0,0,0.15)',
                        'soft': '0 10px 25px -5px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #f0f4f8; 
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Map Custom Styles */
        .custom-div-icon { background: transparent; border: none; }
        .leaflet-popup-content-wrapper { border-radius: 1rem; border: 3px solid #FFD740; box-shadow: 0 6px 0 rgba(0,0,0,0.1); }
        .leaflet-popup-content { font-family: 'Nunito', sans-serif; font-weight: 700; margin: 0.8rem; }
        .cursor-crosshair { cursor: crosshair !important; }
        
        /* Interactive Elements */
        .btn-cartoon { transition: all 0.1s; }
        .btn-cartoon:active { transform: translateY(3px); box-shadow: 0 0 0 rgba(0,0,0,0.15) !important; }

        /* Rich Text Styles */
        .rte-content h1, .rte-content h2 { font-family: 'Baloo 2', cursive; color: #2C3E50; }
        .rte-content img { border: 4px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; max-width: 100%; height: auto; }
        
        /* User Location Pulse */
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .user-location-icon {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            animation: pulse-blue 2s infinite;
        }
        
        /* Leaflet Z-Index fixes */
        .leaflet-pane { z-index: 10; }
        .leaflet-top, .leaflet-bottom { z-index: 20; }
    </style>
</head>
<body class="text-slate-700 antialiased selection:bg-traffic-yellow selection:text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        // ƒê·ªïi t√™n Map th√†nh MapIcon ƒë·ªÉ tr√°nh xung ƒë·ªôt v·ªõi object Map c·ªßa JS ho·∫∑c Leaflet
        import { 
          Map as MapIcon, AlertTriangle, FileText, Megaphone, Shield, 
          Award, LogIn, Plus, Trash2, Save, Menu, X, Edit,
          Navigation, Info, User, Layout, MapPin, CheckSquare, XCircle,
          Eye, EyeOff, MousePointer2, Undo2, ArrowLeft, Calendar,
          Bold, Italic, Underline, Search, MessageSquare, CheckCircle, HelpCircle, LocateFixed,
          GraduationCap, BookOpen, Star, Heart, Camera, Flag, Siren, Layers, Video,
          Settings, Database, List
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
          getFirestore, collection, addDoc, getDocs, 
          deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, limit, where, setDoc, getDoc 
        } from 'firebase/firestore';
        import { 
          getAuth, signInWithEmailAndPassword, signOut, 
          onAuthStateChanged 
        } from 'firebase/auth';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return (
                    <div className="p-8 text-center text-red-500 font-bold bg-white rounded-xl shadow-cartoon m-4">
                        √îi h·ªèng r·ªìi! G·ªçi ƒë·ªôi c·ª©u h·ªô th√¥i! üöë <br/>
                        <button onClick={() => window.location.reload()} className="mt-4 bg-traffic-blue text-white px-4 py-2 rounded-full">Th·ª≠ l·∫°i</button>
                    </div>
                );
                return this.props.children;
            }
        }

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyA7A_VxnEqlYMebteU76Om0FnrkVH8Pdl4",
          authDomain: "atgt-6c132.firebaseapp.com",
          projectId: "atgt-6c132",
          storageBucket: "atgt-6c132.firebasestorage.app",
          messagingSenderId: "386224446840",
          appId: "1:386224446840:web:1fbb428b3c4799260d7c8d",
          measurementId: "G-D6EZ3CFQRF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Constants ---
        const MAP_LAYERS = [
            { id: 'A', label: 'Tr∆∞·ªùng TH Nam H√†', color: 'text-brand-blue', bg: 'bg-blue-100', icon: <MapPin className="w-4 h-4" /> },
            { id: 'B', label: 'Tuy·∫øn ƒë∆∞·ªùng HS ƒëi', color: 'text-slate-600', bg: 'bg-slate-100', icon: <Navigation className="w-4 h-4" /> },
            { id: 'C', label: 'ƒêi·ªÉm Nguy c∆°/√ôn t·∫Øc', color: 'text-red-500', bg: 'bg-red-100', icon: <AlertTriangle className="w-4 h-4" /> },
            { id: 'D', label: 'Khu v·ª±c An to√†n', color: 'text-traffic-green', bg: 'bg-green-100', icon: <Shield className="w-4 h-4" /> },
            { id: 'E', label: 'Ch·ªët tr·ª±c (CA/ƒêo√†n)', color: 'text-traffic-yellow', bg: 'bg-yellow-100', icon: <User className="w-4 h-4" /> },
        ];

        // --- Header ---
        const Header = ({ setCurrentPage, user, onLogout }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const navItems = [
                { id: 'home', label: 'Trang ch·ªß', icon: <Star className="w-4 h-4"/>, color: 'hover:bg-traffic-green' },
                { id: 'news', label: 'Tin t·ª©c', icon: <Megaphone className="w-4 h-4"/>, color: 'hover:bg-brand-blue' },
                { id: 'skills', label: 'K·ªπ nƒÉng', icon: <BookOpen className="w-4 h-4"/>, color: 'hover:bg-traffic-yellow' },
                { id: 'quiz', label: 'ƒê·ªë vui', icon: <Award className="w-4 h-4"/>, color: 'hover:bg-traffic-red' }, 
                { id: 'reporter', label: 'Ph√≥ng vi√™n', icon: <Camera className="w-4 h-4"/>, color: 'hover:bg-purple-500' }, 
                { id: 'map', label: 'B·∫£n ƒë·ªì', icon: <MapIcon className="w-4 h-4"/>, color: 'hover:bg-traffic-dark' },
            ];

            return (
                <header className="bg-white border-b-4 border-traffic-dark sticky top-0 z-50">
                    <div className="container mx-auto px-4 py-2 flex justify-between items-center">
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setCurrentPage('home')}>
                            <div className="relative">
                                <div className="w-12 h-12 bg-traffic-dark rounded-xl flex items-center justify-center border-2 border-white shadow-lg group-hover:rotate-12 transition-transform">
                                    <Shield className="text-traffic-yellow w-8 h-8" />
                                </div>
                                <div className="absolute -top-1 -right-1 w-4 h-4 bg-traffic-red rounded-full border-2 border-white animate-pulse"></div>
                            </div>
                            <div>
                                <h1 className="font-display font-black text-xl md:text-2xl text-traffic-dark uppercase tracking-tight leading-none">Bi·ªát ƒê·ªôi <span className="text-traffic-green">Giao Th√¥ng</span></h1>
                                <p className="text-xs font-bold text-slate-400 bg-slate-100 inline-block px-2 py-0.5 rounded-full mt-1">Tr∆∞·ªùng TH Nam H√†</p>
                            </div>
                        </div>

                        <nav className="hidden xl:flex items-center gap-2">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setCurrentPage(item.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold text-slate-600 transition-all hover:text-white btn-cartoon shadow-cartoon hover:shadow-cartoon-hover ${item.color}`}>
                                    {item.label}
                                </button>
                            ))}
                            {user ? (
                                <button onClick={() => setCurrentPage('admin')} className="ml-4 bg-traffic-red text-white px-5 py-2 rounded-full font-bold shadow-cartoon btn-cartoon flex items-center gap-2">
                                    <User className="w-4 h-4"/> Admin
                                </button>
                            ) : (
                                <button onClick={() => setCurrentPage('login')} className="ml-4 bg-traffic-yellow text-traffic-dark px-5 py-2 rounded-full font-black shadow-cartoon btn-cartoon flex items-center gap-2 border-2 border-traffic-dark">
                                    <LogIn className="w-4 h-4" /> ƒêƒÉng nh·∫≠p
                                </button>
                            )}
                        </nav>
                        <button className="xl:hidden p-2 bg-slate-100 rounded-lg" onClick={() => setIsMenuOpen(!isMenuOpen)}>{isMenuOpen ? <X /> : <Menu />}</button>
                    </div>
                    {isMenuOpen && (
                        <div className="xl:hidden bg-white border-t-2 border-slate-100 p-4 absolute w-full shadow-xl">
                            <div className="grid grid-cols-2 gap-3">
                                {navItems.map(item => (<button key={item.id} onClick={() => { setCurrentPage(item.id); setIsMenuOpen(false); }} className="flex flex-col items-center justify-center p-4 bg-slate-50 rounded-xl hover:bg-slate-100 font-bold text-slate-700"><div className={`p-2 rounded-full text-white mb-2 ${item.color.replace('hover:', '')}`}>{item.icon}</div>{item.label}</button>))}
                            </div>
                            <div className="mt-4 pt-4 border-t border-dashed">
                                {user ? <button onClick={() => setCurrentPage('admin')} className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold">Trang Qu·∫£n tr·ªã</button> : <button onClick={() => {setCurrentPage('login'); setIsMenuOpen(false);}} className="w-full bg-traffic-yellow text-traffic-dark py-3 rounded-xl font-bold shadow-cartoon btn-cartoon">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</button>}
                            </div>
                        </div>
                    )}
                </header>
            );
        };

        // --- Simple Rich Text Editor ---
        const SimpleRichTextEditor = ({ value, onChange }) => {
            const editorRef = useRef(null);
            useEffect(() => { if (editorRef.current && editorRef.current.innerHTML !== value) editorRef.current.innerHTML = value || ''; }, [value]);
            const execCmd = (command, val = null) => { document.execCommand(command, false, val); editorRef.current.focus(); };
            return (
                <div className="border-2 border-slate-200 rounded-xl bg-white overflow-hidden">
                    <div className="flex gap-1 p-2 bg-slate-50 border-b border-slate-200">
                        {['bold', 'italic', 'underline'].map(cmd => (
                            <button key={cmd} type="button" onClick={() => execCmd(cmd)} className="p-2 hover:bg-white rounded font-bold capitalize">{cmd[0]}</button>
                        ))}
                    </div>
                    <div ref={editorRef} contentEditable suppressContentEditableWarning={true} className="p-4 min-h-[150px] focus:outline-none rte-content" onInput={() => onChange(editorRef.current.innerHTML)}></div>
                </div>
            );
        };

        // --- Leaflet Map Component ---
        const LeafletMap = ({ markers, activeLayers, onMapClick, drawingData, userLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);
            const drawingLayerRef = useRef(null);
            const userLocationMarkerRef = useRef(null);

            useEffect(() => { 
                if (window.L && !mapInstanceRef.current) initMap(); 
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, []);

            const initMap = () => {
                if (!mapContainerRef.current || window.L === undefined) return;
                const map = window.L.map(mapContainerRef.current).setView([18.336241, 105.902037], 16);
                window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
                mapInstanceRef.current = map;
                updateLayers(map);
            };

            // Drawing logic
            useEffect(() => {
                if (!mapInstanceRef.current || !window.L) return;
                const map = mapInstanceRef.current;
                if (drawingLayerRef.current) drawingLayerRef.current.forEach(l => { try { map.removeLayer(l); } catch(e) {} });
                drawingLayerRef.current = [];
                if (!drawingData) return;
                const { type, points } = drawingData;
                if (points && points.length > 0 && points.every(p => !isNaN(p[0]) && !isNaN(p[1]))) {
                    points.forEach(pt => {
                        const m = window.L.marker(pt, { icon: window.L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color: #ec4899; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>` }) }).addTo(map);
                        drawingLayerRef.current.push(m);
                    });
                    if (points.length > 1) {
                        const shape = type === 'polyline' ? window.L.polyline(points, { color: '#ec4899', dashArray: '5, 10', weight: 3 }) : window.L.polygon(points, { color: '#ec4899', dashArray: '5, 10', weight: 3, fillOpacity: 0.2 });
                        shape.addTo(map);
                        drawingLayerRef.current.push(shape);
                    }
                }
            }, [drawingData]);

            // Click Handler
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;
                const clickHandler = (e) => { if (onMapClick) onMapClick({ lat: e.latlng.lat, lng: e.latlng.lng }); };
                if (onMapClick) { map.getContainer().classList.add('cursor-crosshair'); map.on('click', clickHandler); }
                else { map.getContainer().classList.remove('cursor-crosshair'); map.off('click', clickHandler); }
                return () => { map.off('click', clickHandler); };
            }, [onMapClick]);

            // User Location
            useEffect(() => {
                if (!mapInstanceRef.current || !window.L || !userLocation) return;
                const map = mapInstanceRef.current;
                if (!userLocationMarkerRef.current) {
                    const userIcon = window.L.divIcon({ className: 'custom-div-icon', html: '<div class="user-location-icon" style="width: 24px; height: 24px;"></div>', iconSize: [24, 24], iconAnchor: [12, 12] });
                    userLocationMarkerRef.current = window.L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup("V·ªã tr√≠ c·ªßa b·∫°n");
                } else { userLocationMarkerRef.current.setLatLng([userLocation.lat, userLocation.lng]); }
                map.setView([userLocation.lat, userLocation.lng], 16);
            }, [userLocation]);

            // Markers Update
            useEffect(() => { if (mapInstanceRef.current && window.L) updateLayers(mapInstanceRef.current); }, [markers, activeLayers]);

            const updateLayers = (map) => {
                layersRef.current.forEach(layer => { try { map.removeLayer(layer); } catch(e) {} });
                layersRef.current = [];
                markers.forEach(feature => {
                    if (activeLayers.includes(feature.type) && feature.isVisible !== false) {
                        try {
                            if (!feature.geometryType || feature.geometryType === 'point') {
                                const m = window.L.marker([feature.lat, feature.lng], { icon: window.L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${feature.type === 'C' ? '#FF5252' : (feature.type === 'E' ? '#FFD740' : '#448AFF')}; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>` }) }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(m);
                            } else if (feature.geometryType === 'polygon' && feature.coordinates) {
                                const p = window.L.polygon(feature.coordinates, { color: '#00E676', fillColor: '#69F0AE', fillOpacity: 0.4, weight: 3 }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(p);
                            } else if (feature.geometryType === 'polyline' && feature.coordinates) {
                                const l = window.L.polyline(feature.coordinates, { color: '#2C3E50', weight: 5, dashArray: '10, 10', opacity: 0.8 }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(l);
                            }
                        } catch(e) { }
                    }
                });
            };
            return <div ref={mapContainerRef} className="w-full h-full z-0" />;
        };

        // --- Interactive Map Container ---
        const InteractiveMap = ({ isAdmin, onMapClick, drawingData }) => {
            const [activeLayers, setActiveLayers] = useState(['A', 'B', 'C', 'D', 'E']);
            const [markers, setMarkers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [userLocation, setUserLocation] = useState(null);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const q = query(collection(db, 'map_markers'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMarkers(data.length ? data : []);
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, []);

            const toggleLayer = (id) => activeLayers.includes(id) ? setActiveLayers(activeLayers.filter(l => l !== id)) : setActiveLayers([...activeLayers, id]);
            
            const locateUser = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => { setUserLocation({ lat: position.coords.latitude, lng: position.coords.longitude }); },
                        () => alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠."), { enableHighAccuracy: true }
                    );
                } else alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£.");
            };

            return (
                <div className="bg-white p-6 rounded-3xl shadow-cartoon border-4 border-slate-200">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 className="font-display text-2xl font-black text-slate-800 flex items-center gap-2">
                                <span className="bg-blue-100 p-2 rounded-xl text-brand-blue"><MapIcon className="w-6 h-6" /></span> B·∫£n ƒë·ªì Giao th√¥ng s·ªë
                            </h2>
                            <p className="text-sm font-bold text-slate-400 mt-1 ml-1">D·ªØ li·ªáu th·ª±c t·∫ø khu v·ª±c Ph∆∞·ªùng Th√†nh Sen</p>
                        </div>
                        <div className="flex flex-wrap gap-3 items-center">
                            {isAdmin && <span className="text-xs bg-yellow-100 text-yellow-800 px-3 py-1.5 rounded-full font-black flex items-center border-2 border-yellow-200 animate-pulse"><MousePointer2 className="w-3 h-3 mr-1"/> Click b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn</span>}
                            <button onClick={locateUser} className="bg-sky-100 text-brand-blue px-4 py-2 rounded-full hover:bg-sky-200 font-bold flex items-center gap-2 btn-cartoon border-2 border-sky-200" title="V·ªã tr√≠ c·ªßa t√¥i"><LocateFixed className="w-4 h-4"/> V·ªã tr√≠ c·ªßa t√¥i</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 space-y-3 bg-slate-50 p-5 rounded-2xl border-2 border-slate-200 h-fit">
                            <h3 className="font-display font-bold text-slate-700 mb-3 flex items-center gap-2"><Layers className="w-4 h-4"/> L·ªõp d·ªØ li·ªáu</h3>
                            {MAP_LAYERS.map(layer => (
                                <div key={layer.id} className={`flex items-center gap-3 cursor-pointer group p-3 rounded-xl transition-all border-2 ${activeLayers.includes(layer.id) ? 'bg-white border-brand-blue shadow-sm' : 'border-transparent hover:bg-white'}`} onClick={() => toggleLayer(layer.id)}>
                                    <div className={`w-6 h-6 rounded-lg flex items-center justify-center transition-colors ${activeLayers.includes(layer.id) ? 'bg-brand-blue text-white' : 'bg-slate-200 text-slate-400'}`}>
                                        {activeLayers.includes(layer.id) && <CheckSquare className="w-3.5 h-3.5" />}
                                    </div>
                                    <span className={`text-sm font-bold flex items-center gap-2 ${layer.color}`}>{layer.icon} {layer.label}</span>
                                </div>
                            ))}
                        </div>
                        <div className="lg:col-span-3 bg-indigo-50 h-[500px] rounded-2xl border-4 border-slate-200 shadow-inner relative overflow-hidden group z-0">
                            {loading ? <div className="absolute inset-0 flex items-center justify-center font-bold text-brand-blue animate-pulse">ƒêang t·∫£i b·∫£n ƒë·ªì...</div> : <LeafletMap markers={markers} activeLayers={activeLayers} onMapClick={onMapClick} drawingData={drawingData} userLocation={userLocation} />}
                        </div>
                    </div>
                </div>
            );
        };

        // --- News Feed Component ---
        const NewsFeed = () => {
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const q = query(collection(db, 'news'), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setNews(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="text-center p-10 font-bold text-slate-400">ƒêang t·∫£i tin t·ª©c...</div>;

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <h2 className="font-display text-3xl font-black text-slate-800 text-center mb-8">
                        <span className="bg-brand-blue text-white px-4 py-2 rounded-xl shadow-cartoon transform -rotate-2 inline-block">Tin T·ª©c</span> & S·ª± Ki·ªán
                    </h2>
                    <div className="grid gap-6">
                        {news.map(item => (
                            <div key={item.id} className="bg-white rounded-3xl p-6 border-b-8 border-r-8 border-slate-200 border-t-2 border-l-2 border-slate-100 shadow-xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                                 <div className="absolute top-0 right-0 bg-traffic-yellow px-4 py-2 rounded-bl-2xl font-black text-xs text-slate-800 uppercase tracking-wider">{item.category || 'Tin t·ª©c'}</div>
                                 <div className="mb-2 text-slate-400 text-xs font-bold flex items-center gap-1">
                                    <Calendar className="w-3 h-3"/> {item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'M·ªõi c·∫≠p nh·∫≠t'}
                                 </div>
                                 <h3 className="font-display text-2xl font-black text-slate-800 mb-3 group-hover:text-brand-blue transition-colors">{item.title}</h3>
                                 <div className="text-slate-600 prose prose-slate max-w-none font-medium" dangerouslySetInnerHTML={{ __html: item.content }} />
                            </div>
                        ))}
                        {news.length === 0 && <div className="text-center font-bold text-slate-400 py-10 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">Ch∆∞a c√≥ tin t·ª©c n√†o ƒë∆∞·ª£c ƒëƒÉng.</div>}
                    </div>
                </div>
            );
        };

        // --- Skills Page Component ---
        const SkillsPage = () => {
            const [skills, setSkills] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const q = query(collection(db, 'skills'), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setSkills(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="text-center p-10 font-bold text-slate-400">ƒêang t·∫£i k·ªπ nƒÉng...</div>;

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <h2 className="font-display text-3xl font-black text-slate-800 text-center mb-8">
                        <span className="bg-traffic-yellow text-slate-900 px-4 py-2 rounded-xl shadow-cartoon transform rotate-2 inline-block">G√≥c K·ªπ NƒÉng</span> An To√†n
                    </h2>
                    <div className="grid md:grid-cols-2 gap-6">
                        {skills.map(item => (
                            <div key={item.id} className="bg-white rounded-3xl p-6 border-b-8 border-traffic-yellow border-t-2 border-x-2 border-slate-200 shadow-xl relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                                 <div className="mb-2 text-slate-500 text-xs font-bold flex items-center gap-2 uppercase tracking-wider">
                                    <BookOpen className="w-4 h-4 text-traffic-yellow"/> {item.category || 'K·ªπ nƒÉng chung'}
                                 </div>
                                 <h3 className="font-display text-xl font-black text-slate-800 mb-3 group-hover:text-yellow-600 transition-colors">{item.title}</h3>
                                 <div className="text-slate-600 prose prose-slate max-w-none text-sm font-medium" dangerouslySetInnerHTML={{ __html: item.content }} />
                            </div>
                        ))}
                        {skills.length === 0 && <div className="col-span-2 text-center font-bold text-slate-400 py-10 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">Ch∆∞a c√≥ b√†i h·ªçc k·ªπ nƒÉng n√†o.</div>}
                    </div>
                </div>
            );
        };

        // --- Admin Dashboard ---
        const AdminDashboard = ({ onLogout }) => {
            const [activeTab, setActiveTab] = useState('news'); 
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [category, setCategory] = useState('Tin t·ª©c');
            const [status, setStatus] = useState('');
            const [editingId, setEditingId] = useState(null);
            
            // Map logic variables
            const [geometryType, setGeometryType] = useState('point'); 
            const [lat, setLat] = useState('');
            const [lng, setLng] = useState('');
            const [coordString, setCoordString] = useState('');
            const [markerType, setMarkerType] = useState('C');
            const [isVisible, setIsVisible] = useState(true); 

            // Quiz Management States
            const [quizSubTab, setQuizSubTab] = useState('questions'); // 'categories', 'questions', 'settings'
            const [quizCategories, setQuizCategories] = useState([]);
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [quizSettings, setQuizSettings] = useState({ quizLimit: 10 });
            
            // Quiz Form States
            const [qText, setQText] = useState('');
            const [qImg, setQImg] = useState('');
            const [optA, setOptA] = useState('');
            const [optB, setOptB] = useState('');
            const [optC, setOptC] = useState('');
            const [optD, setOptD] = useState('');
            const [correctOpt, setCorrectOpt] = useState('0'); // Index 0-3
            const [targetCat, setTargetCat] = useState(''); // ID of category
            const [catName, setCatName] = useState(''); // For category form
            const [quizLimitInput, setQuizLimitInput] = useState(10);

            // Lists
            const [adminPosts, setAdminPosts] = useState([]);
            const [adminDocs, setAdminDocs] = useState([]);
            const [adminSkills, setAdminSkills] = useState([]);
            const [mapItems, setMapItems] = useState([]);
            const [reports, setReports] = useState([]);

            useEffect(() => {
                let unsubscribe = () => {};
                if (activeTab === 'news') { const q = query(collection(db, 'news'), orderBy('createdAt', 'desc'), limit(50)); unsubscribe = onSnapshot(q, (s) => setAdminPosts(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'docs') { const q = query(collection(db, 'documents'), orderBy('createdAt', 'desc'), limit(50)); unsubscribe = onSnapshot(q, (s) => setAdminDocs(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'skills') { const q = query(collection(db, 'skills'), orderBy('createdAt', 'desc'), limit(50)); unsubscribe = onSnapshot(q, (s) => setAdminSkills(s.docs.map(d => ({id: d.id, ...d.data()})))); } 
                else if (activeTab === 'map') { const q = query(collection(db, 'map_markers'), orderBy('createdAt', 'desc')); unsubscribe = onSnapshot(q, (s) => setMapItems(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'reports') { const q = query(collection(db, 'reports'), orderBy('createdAt', 'desc'), limit(50)); unsubscribe = onSnapshot(q, (s) => setReports(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'quiz') {
                    // Load Quiz Data based on subtab or load all initially
                    const unsubCats = onSnapshot(query(collection(db, 'quiz_categories'), orderBy('createdAt', 'desc')), (s) => setQuizCategories(s.docs.map(d => ({id: d.id, ...d.data()}))));
                    const unsubQs = onSnapshot(query(collection(db, 'quiz_questions'), orderBy('createdAt', 'desc')), (s) => setQuizQuestions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                    const unsubSettings = onSnapshot(doc(db, 'quiz_settings', 'config'), (doc) => {
                         if (doc.exists()) { setQuizSettings(doc.data()); setQuizLimitInput(doc.data().quizLimit); }
                    });
                    unsubscribe = () => { unsubCats(); unsubQs(); unsubSettings(); };
                }
                return () => unsubscribe();
            }, [activeTab]);

            const resetForm = () => { 
                setTitle(''); setContent(''); setCategory(activeTab === 'skills' ? 'ƒêi b·ªô an to√†n' : 'Tin t·ª©c'); 
                setLat(''); setLng(''); setCoordString(''); setIsVisible(true); setEditingId(null);
                // Quiz reset
                setQText(''); setQImg(''); setOptA(''); setOptB(''); setOptC(''); setOptD(''); setCorrectOpt('0'); setTargetCat(''); setCatName('');
            };
            
            const handleEdit = (item) => {
                setEditingId(item.id); 
                if (activeTab === 'map') {
                    setTitle(item.label); setMarkerType(item.type); setGeometryType(item.geometryType || 'point'); setIsVisible(item.isVisible !== false);
                    if (item.geometryType === 'point' || !item.geometryType) { setLat(item.lat); setLng(item.lng); setCoordString(''); }
                    else { setCoordString(item.coordinates?.map(p => p.join(',')).join('; ') || ''); setLat(''); setLng(''); }
                } else if (activeTab === 'quiz') {
                    if (quizSubTab === 'categories') { setCatName(item.name); }
                    if (quizSubTab === 'questions') {
                         setQText(item.question); setQImg(item.image || ''); setOptA(item.options[0]); setOptB(item.options[1]); setOptC(item.options[2]); setOptD(item.options[3]);
                         setCorrectOpt(item.correctOption.toString()); setTargetCat(item.categoryId);
                    }
                } else { 
                    setTitle(item.title || item.label); setContent(item.content); setCategory(item.category || (activeTab === 'skills' ? 'ƒêi b·ªô an to√†n' : 'Tin t·ª©c')); 
                }
            };

            const handleMapClick = (coords) => {
                if (activeTab !== 'map') return;
                if (geometryType === 'point') { setLat(coords.lat.toFixed(6)); setLng(coords.lng.toFixed(6)); }
                else { const pt = `${coords.lat.toFixed(6)},${coords.lng.toFixed(6)}`; setCoordString(prev => prev ? `${prev}; ${pt}` : pt); }
            };

            const handleSubmit = async (e) => {
                e.preventDefault(); setStatus('ƒêang x·ª≠ l√Ω...');
                try {
                    let col;
                    let data;
                    if (activeTab === 'map') { col = 'map_markers'; data = { label: title, type: markerType, geometryType, isVisible };
                        if (geometryType === 'point') { data.lat = parseFloat(lat); data.lng = parseFloat(lng); }
                        else { data.coordinates = coordString.split(';').map(p => { const [la, lo] = p.trim().split(','); return [parseFloat(la), parseFloat(lo)]; }); }
                    }
                    else if (activeTab === 'news') { col = 'news'; data = { title, content, category }; }
                    else if (activeTab === 'docs') { col = 'documents'; data = { title, content, category }; }
                    else if (activeTab === 'skills') { col = 'skills'; data = { title, content, category }; }

                    if (!editingId) data.createdAt = serverTimestamp();
                    editingId ? await updateDoc(doc(db, col, editingId), data) : await addDoc(collection(db, col), data);
                    setStatus('Th√†nh c√¥ng!'); resetForm(); setTimeout(() => setStatus(''), 2000);
                } catch (err) { setStatus('L·ªói: ' + err.message); }
            };

            // Specific Quiz Handlers
            const handleQuizSubmit = async (e) => {
                e.preventDefault(); setStatus('ƒêang l∆∞u...');
                try {
                    if (quizSubTab === 'categories') {
                        const data = { name: catName, createdAt: serverTimestamp() };
                        editingId ? await updateDoc(doc(db, 'quiz_categories', editingId), data) : await addDoc(collection(db, 'quiz_categories'), data);
                    } else if (quizSubTab === 'questions') {
                         const data = {
                            question: qText, image: qImg, options: [optA, optB, optC, optD], correctOption: parseInt(correctOpt), categoryId: targetCat, createdAt: serverTimestamp()
                         };
                         editingId ? await updateDoc(doc(db, 'quiz_questions', editingId), data) : await addDoc(collection(db, 'quiz_questions'), data);
                    } else if (quizSubTab === 'settings') {
                        await setDoc(doc(db, 'quiz_settings', 'config'), { quizLimit: parseInt(quizLimitInput) });
                    }
                    setStatus('Th√†nh c√¥ng!'); resetForm(); setTimeout(() => setStatus(''), 2000);
                } catch (err) { setStatus('L·ªói: ' + err.message); }
            };

            const handleDelete = async (col, id) => { if(window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) { await deleteDoc(doc(db, col, id)); } };
            const handleUpdateReport = async (id, val) => { await updateDoc(doc(db, 'reports', id), { status: val }); };

            const drawingData = useMemo(() => {
                if (activeTab !== 'map') return null;
                if (geometryType === 'point') return (lat && lng && !isNaN(lat) && !isNaN(lng)) ? { type: 'point', points: [[parseFloat(lat), parseFloat(lng)]] } : null;
                if (!coordString) return null;
                try {
                    const points = coordString.split(';').map(p => { const [la, lo] = p.trim().split(','); return [parseFloat(la), parseFloat(lo)]; }).filter(p => !isNaN(p[0]) && !isNaN(p[1]));
                    return { type: geometryType, points };
                } catch(e) { return null; }
            }, [activeTab, geometryType, lat, lng, coordString]);

            // Helper to get list for display
            const getListToRender = () => {
                if (activeTab === 'map') return mapItems;
                if (activeTab === 'news') return adminPosts;
                if (activeTab === 'skills') return adminSkills;
                return adminDocs;
            };

            return (
                <div className="bg-white p-6 rounded-3xl border-4 border-slate-200 shadow-xl mt-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6 border-b-2 border-slate-100 pb-4">
                        <h2 className="font-display text-2xl font-black text-slate-800 flex items-center gap-2"><User className="w-8 h-8 bg-slate-800 text-white p-1 rounded-lg"/> Trung t√¢m Ch·ªâ huy Admin</h2>
                        <button onClick={onLogout} className="text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded">ƒêƒÉng xu·∫•t</button>
                    </div>
                    
                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onClick={() => {setActiveTab('news'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'news' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500'}`}>üì∞ Tin t·ª©c</button>
                        <button onClick={() => {setActiveTab('skills'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'skills' ? 'bg-orange-100 border-orange-500 text-orange-700' : 'border-slate-200 text-slate-500'}`}>üéì K·ªπ nƒÉng</button>
                        <button onClick={() => {setActiveTab('docs'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'docs' ? 'bg-yellow-100 border-yellow-500 text-yellow-700' : 'border-slate-200 text-slate-500'}`}>üìÇ VƒÉn b·∫£n</button>
                        <button onClick={() => {setActiveTab('map'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'map' ? 'bg-traffic-dark border-slate-800 text-white' : 'border-slate-200 text-slate-500'}`}>üó∫Ô∏è B·∫£n ƒë·ªì (GIS)</button>
                        <button onClick={() => {setActiveTab('quiz'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'quiz' ? 'bg-green-100 border-green-500 text-green-700' : 'border-slate-200 text-slate-500'}`}>‚ùì Qu·∫£n l√Ω ƒê·ªë vui</button>
                        <button onClick={() => {setActiveTab('reports'); resetForm();}} className={`px-4 py-2 rounded-xl font-bold border-2 transition-all whitespace-nowrap ${activeTab === 'reports' ? 'bg-purple-100 border-purple-500 text-purple-700' : 'border-slate-200 text-slate-500'}`}>üì° B√°o c√°o MƒÉng non</button>
                    </div>

                    {activeTab === 'quiz' && (
                        <div>
                             <div className="flex gap-4 mb-4 border-b border-slate-100 pb-2">
                                <button onClick={() => setQuizSubTab('questions')} className={`font-bold flex items-center gap-2 ${quizSubTab === 'questions' ? 'text-brand-blue underline' : 'text-slate-400'}`}><Database size={16}/> Ng√¢n h√†ng c√¢u h·ªèi</button>
                                <button onClick={() => setQuizSubTab('categories')} className={`font-bold flex items-center gap-2 ${quizSubTab === 'categories' ? 'text-brand-blue underline' : 'text-slate-400'}`}><List size={16}/> Danh m·ª•c ch·ªß ƒë·ªÅ</button>
                                <button onClick={() => setQuizSubTab('settings')} className={`font-bold flex items-center gap-2 ${quizSubTab === 'settings' ? 'text-brand-blue underline' : 'text-slate-400'}`}><Settings size={16}/> C·∫•u h√¨nh thi</button>
                             </div>

                             {quizSubTab === 'settings' && (
                                 <div className="bg-slate-50 p-6 rounded-2xl border-2 border-slate-200 max-w-lg">
                                     <h3 className="font-bold text-slate-700 mb-4">C·∫•u h√¨nh b√†i thi chung</h3>
                                     <div className="mb-4">
                                        <label className="block text-sm font-bold text-slate-600 mb-2">S·ªë l∆∞·ª£ng c√¢u h·ªèi hi·ªÉn th·ªã m·ªói l·∫ßn thi</label>
                                        <input type="number" className="w-full p-3 rounded-xl border-2 border-slate-200 font-bold" value={quizLimitInput} onChange={(e) => setQuizLimitInput(e.target.value)} />
                                     </div>
                                     <button onClick={handleQuizSubmit} className="bg-brand-blue text-white px-6 py-2 rounded-xl font-bold shadow-cartoon btn-cartoon">L∆∞u c·∫•u h√¨nh</button>
                                     {status && <span className="ml-3 font-bold text-green-600">{status}</span>}
                                 </div>
                             )}

                             {quizSubTab === 'categories' && (
                                 <div className="grid md:grid-cols-3 gap-6">
                                     <div className="md:col-span-1">
                                         <form onSubmit={handleQuizSubmit} className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                                            <h3 className="font-bold text-slate-700 mb-3">{editingId ? 'S·ª≠a' : 'Th√™m'} Danh m·ª•c</h3>
                                            <input required className="w-full p-3 rounded-xl border-2 border-slate-200 font-bold mb-3" placeholder="T√™n danh m·ª•c (VD: Bi·ªÉn b√°o)" value={catName} onChange={e=>setCatName(e.target.value)}/>
                                            <div className="flex gap-2">
                                                <button className="flex-1 bg-brand-blue text-white py-2 rounded-xl font-bold shadow-cartoon btn-cartoon">{editingId ? 'C·∫≠p nh·∫≠t' : 'Th√™m'}</button>
                                                {editingId && <button type="button" onClick={resetForm} className="px-4 bg-slate-200 rounded-xl font-bold">H·ªßy</button>}
                                            </div>
                                         </form>
                                     </div>
                                     <div className="md:col-span-2 space-y-2">
                                         {quizCategories.map(cat => (
                                             <div key={cat.id} className="flex justify-between items-center p-3 bg-white border-2 border-slate-100 rounded-xl">
                                                 <span className="font-bold text-slate-700">{cat.name}</span>
                                                 <div className="flex gap-2">
                                                     <button onClick={() => handleEdit(cat)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Edit size={16}/></button>
                                                     <button onClick={() => handleDelete('quiz_categories', cat.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16}/></button>
                                                 </div>
                                             </div>
                                         ))}
                                         {quizCategories.length === 0 && <p className="text-slate-400 italic">Ch∆∞a c√≥ danh m·ª•c n√†o.</p>}
                                     </div>
                                 </div>
                             )}

                             {quizSubTab === 'questions' && (
                                <div className="grid lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-1">
                                         <form onSubmit={handleQuizSubmit} className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 space-y-3">
                                            <h3 className="font-bold text-slate-700 mb-2">{editingId ? 'S·ª≠a c√¢u h·ªèi' : 'Th√™m c√¢u h·ªèi m·ªõi'}</h3>
                                            <select required className="w-full p-2 rounded-xl border-2 border-slate-200 font-bold text-sm" value={targetCat} onChange={e=>setTargetCat(e.target.value)}>
                                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                                                {quizCategories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                            <textarea required className="w-full p-3 rounded-xl border-2 border-slate-200 font-bold text-sm h-24" placeholder="N·ªôi dung c√¢u h·ªèi..." value={qText} onChange={e=>setQText(e.target.value)}></textarea>
                                            <input className="w-full p-2 rounded-xl border-2 border-slate-200 text-sm" placeholder="Link ·∫£nh minh h·ªça (n·∫øu c√≥)" value={qImg} onChange={e=>setQImg(e.target.value)}/>
                                            
                                            <div className="space-y-2">
                                                <label className="text-xs font-bold text-slate-500">Nh·∫≠p 4 ƒë√°p √°n & Ch·ªçn ƒë√°p √°n ƒë√∫ng:</label>
                                                {[optA, optB, optC, optD].map((opt, idx) => (
                                                    <div key={idx} className="flex gap-2 items-center">
                                                        <input type="radio" name="correctOpt" checked={correctOpt == idx} onChange={() => setCorrectOpt(idx.toString())} className="w-4 h-4 text-brand-blue accent-brand-blue"/>
                                                        <input required className={`flex-1 p-2 rounded-lg border-2 text-sm ${correctOpt == idx ? 'border-brand-blue bg-blue-50' : 'border-slate-200'}`} placeholder={`ƒê√°p √°n ${String.fromCharCode(65+idx)}`} value={idx===0?optA:idx===1?optB:idx===2?optC:optD} onChange={e => {
                                                            if(idx===0) setOptA(e.target.value);
                                                            if(idx===1) setOptB(e.target.value);
                                                            if(idx===2) setOptC(e.target.value);
                                                            if(idx===3) setOptD(e.target.value);
                                                        }}/>
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="flex gap-2 pt-2">
                                                <button className="flex-1 bg-brand-blue text-white py-2 rounded-xl font-bold shadow-cartoon btn-cartoon">{editingId ? 'C·∫≠p nh·∫≠t' : 'L∆∞u l·∫°i'}</button>
                                                {editingId && <button type="button" onClick={resetForm} className="px-4 bg-slate-200 rounded-xl font-bold">H·ªßy</button>}
                                            </div>
                                            {status && <p className="text-center text-sm font-bold text-green-600">{status}</p>}
                                         </form>
                                    </div>
                                    <div className="lg:col-span-2 space-y-3 h-[600px] overflow-y-auto pr-2">
                                        {quizQuestions.map(q => (
                                            <div key={q.id} className="bg-white border-2 border-slate-100 rounded-xl p-4 hover:shadow-md transition-shadow relative">
                                                <div className="absolute top-2 right-2 flex gap-1">
                                                     <button onClick={() => handleEdit(q)} className="text-blue-500 hover:bg-blue-50 p-1 rounded"><Edit size={16}/></button>
                                                     <button onClick={() => handleDelete('quiz_questions', q.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 size={16}/></button>
                                                </div>
                                                <span className="bg-slate-100 text-slate-500 text-xs font-bold px-2 py-0.5 rounded-full mb-2 inline-block">
                                                    {quizCategories.find(c => c.id === q.categoryId)?.name || 'Ch∆∞a ph√¢n lo·∫°i'}
                                                </span>
                                                <h4 className="font-bold text-slate-800 mb-2 pr-16">{q.question}</h4>
                                                {q.image && <img src={q.image} className="h-20 object-cover rounded-lg mb-2 border border-slate-200" alt="Minh h·ªça"/>}
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    {q.options.map((opt, i) => (
                                                        <div key={i} className={`p-2 rounded border ${i === q.correctOption ? 'bg-green-100 border-green-500 text-green-800 font-bold' : 'bg-slate-50 border-slate-100 text-slate-500'}`}>
                                                            {String.fromCharCode(65+i)}. {opt}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                        {quizQuestions.length === 0 && <div className="text-center py-10 text-slate-400 font-bold border-2 border-dashed rounded-xl">Ch∆∞a c√≥ c√¢u h·ªèi n√†o trong ng√¢n h√†ng.</div>}
                                    </div>
                                </div>
                             )}
                        </div>
                    )}

                    {activeTab === 'reports' ? (
                        <div className="space-y-4">
                            {reports.map(item => (
                                <div key={item.id} className="border-2 border-slate-100 rounded-2xl p-4 hover:border-purple-200 transition-colors flex flex-col md:flex-row gap-4">
                                    {item.image && <img src={item.image} className="w-24 h-24 object-cover rounded-xl border-2 border-slate-200 bg-slate-100" alt="Evidence" />}
                                    <div className="flex-1">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1"><span className={`px-2 py-0.5 rounded text-xs font-black uppercase text-white ${item.urgency === 'high' ? 'bg-traffic-red' : item.urgency === 'medium' ? 'bg-traffic-yellow' : 'bg-traffic-green'}`}>{item.urgency === 'high' ? 'Nguy hi·ªÉm' : item.urgency === 'medium' ? 'C·∫ßn ch√∫ √Ω' : 'B√¨nh th∆∞·ªùng'}</span><span className="text-xs font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-500">{item.type}</span></div>
                                                <h3 className="font-bold text-lg text-slate-800">{item.name} b√°o c√°o</h3>
                                                <p className="text-slate-600 mt-1">{item.content}</p>
                                            </div>
                                            <button onClick={() => handleDelete('reports', item.id)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-5 h-5"/></button>
                                        </div>
                                        <div className="mt-4 flex items-center gap-2 bg-slate-50 p-2 rounded-lg w-fit"><span className="text-xs font-bold text-slate-400">Tr·∫°ng th√°i:</span><select value={item.status || 'pending'} onChange={(e) => handleUpdateReport(item.id, e.target.value)} className="bg-white border border-slate-200 rounded px-2 py-1 text-sm font-bold outline-none cursor-pointer"><option value="pending">‚è≥ ƒêang ch·ªù</option><option value="processing">üõ†Ô∏è ƒêang x·ª≠ l√Ω</option><option value="done">‚úÖ ƒê√£ xong</option></select></div>
                                    </div>
                                </div>
                            ))}
                            {reports.length === 0 && <p className="text-center text-slate-400 font-bold py-10">Ch∆∞a c√≥ b√°o c√°o n√†o!</p>}
                        </div>
                    ) : activeTab !== 'quiz' && (
                        <div className="grid lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                <form onSubmit={handleSubmit} className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                                    <h3 className="font-bold text-slate-700 mb-3">{editingId ? 'S·ª≠a' : 'Th√™m'} {activeTab === 'map' ? 'ƒêi·ªÉm' : (activeTab === 'skills' ? 'B√†i h·ªçc K·ªπ nƒÉng' : 'Tin/VƒÉn b·∫£n')}</h3>
                                    <div className="space-y-3">
                                        <input required className="w-full p-3 rounded-xl border-2 border-slate-200 font-bold" placeholder="Ti√™u ƒë·ªÅ / T√™n b√†i" value={title} onChange={e=>setTitle(e.target.value)}/>
                                        
                                        {activeTab === 'map' ? (
                                            <>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <select className="p-2 rounded-xl border-2 font-bold" value={geometryType} onChange={e=>{setGeometryType(e.target.value); setCoordString(''); setLat(''); setLng('');}}><option value="point">ƒêi·ªÉm</option><option value="polyline">ƒê∆∞·ªùng</option><option value="polygon">V√πng</option></select>
                                                    <select className="p-2 rounded-xl border-2 font-bold" value={markerType} onChange={e=>setMarkerType(e.target.value)}><option value="A">Tr∆∞·ªùng</option><option value="B">ƒê∆∞·ªùng</option><option value="C">Nguy c∆°</option><option value="D">An to√†n</option><option value="E">Ch·ªët tr·ª±c</option></select>
                                                </div>
                                                {geometryType === 'point' ? (
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input type="number" step="any" className="p-2 rounded-xl border-2 font-bold" placeholder="Vƒ© ƒë·ªô" value={lat} onChange={e=>setLat(e.target.value)}/>
                                                        <input type="number" step="any" className="p-2 rounded-xl border-2 font-bold" placeholder="Kinh ƒë·ªô" value={lng} onChange={e=>setLng(e.target.value)}/>
                                                    </div>
                                                ) : (
                                                    <textarea className="w-full p-2 rounded-xl border-2 h-20 text-xs font-mono" placeholder="Click b·∫£n ƒë·ªì ƒë·ªÉ v·∫Ω..." value={coordString} readOnly></textarea>
                                                )}
                                                <p className="text-xs text-brand-blue font-bold italic">üí° Tip: Click l√™n b·∫£n ƒë·ªì b√™n ph·∫£i ƒë·ªÉ l·∫•y t·ªça ƒë·ªô t·ª± ƒë·ªông.</p>
                                            </>
                                        ) : (
                                            <>
                                                <select className="w-full p-3 rounded-xl border-2 border-slate-200 font-bold" value={category} onChange={e=>setCategory(e.target.value)}>
                                                    {activeTab === 'news' ? (
                                                        <><option>Tin t·ª©c</option><option>G∆∞∆°ng ƒëi·ªÉn h√¨nh</option><option>S·ª± ki·ªán</option></> 
                                                    ) : activeTab === 'skills' ? (
                                                        <><option>ƒêi b·ªô an to√†n</option><option>ƒêi xe ƒë·∫°p</option><option>ƒê·ªôi m≈© b·∫£o hi·ªÉm</option><option>Ng·ªìi sau xe m√°y</option></>
                                                    ) : (
                                                        <><option>VƒÉn b·∫£n n·ªôi b·ªô</option><option>VƒÉn b·∫£n ph√°p lu·∫≠t</option><option>M·∫´u cam k·∫øt</option></>
                                                    )}
                                                </select>
                                                {(activeTab === 'news' || activeTab === 'skills') ? <SimpleRichTextEditor value={content} onChange={setContent} /> : <input className="w-full p-3 rounded-xl border-2 font-bold" placeholder="Link t·∫£i t√†i li·ªáu" value={content} onChange={e=>setContent(e.target.value)}/>}
                                            </>
                                        )}
                                    </div>
                                    <div className="flex gap-2 mt-4">
                                        <button className="flex-1 bg-brand-blue text-white py-2 rounded-xl font-bold shadow-cartoon btn-cartoon">{editingId ? 'C·∫≠p nh·∫≠t' : 'L∆∞u l·∫°i'}</button>
                                        {editingId && <button type="button" onClick={resetForm} className="px-4 bg-slate-200 rounded-xl font-bold">H·ªßy</button>}
                                    </div>
                                    {status && <p className="text-center text-sm font-bold text-green-600 mt-2">{status}</p>}
                                </form>
                                <div className="bg-white border-2 rounded-xl overflow-hidden max-h-60 overflow-y-auto">
                                    {getListToRender().map(item => (
                                        <div key={item.id} className="p-3 border-b flex justify-between items-center text-sm hover:bg-slate-50">
                                            <span className="font-bold truncate w-2/3">{item.title || item.label}</span>
                                            <div className="flex gap-1">
                                                <button onClick={() => handleEdit(item)} className="text-blue-500 p-1"><Edit size={16}/></button>
                                                <button onClick={() => handleDelete(activeTab === 'map' ? 'map_markers' : (activeTab === 'news' ? 'news' : (activeTab === 'skills' ? 'skills' : 'documents')), item.id)} className="text-red-500 p-1"><Trash2 size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="lg:col-span-2">
                                {activeTab === 'map' ? (
                                    <div className="h-[500px] bg-slate-100 rounded-2xl border-4 border-slate-200 overflow-hidden relative">
                                        <InteractiveMap isAdmin={true} onMapClick={handleMapClick} drawingData={drawingData} />
                                        <div className="absolute top-2 right-2 bg-white/90 p-2 rounded-lg text-xs font-bold shadow z-[1000]">Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a ƒëang B·∫¨T</div>
                                    </div>
                                ) : (
                                    <div className="h-full flex items-center justify-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 font-bold p-8 text-center">
                                        {activeTab === 'skills' ? 
                                            "Xem tr∆∞·ªõc n·ªôi dung k·ªπ nƒÉng s·∫Ω hi·ªÉn th·ªã ·ªü trang 'K·ªπ nƒÉng'. H√£y so·∫°n th·∫£o n·ªôi dung phong ph√∫!" 
                                            : 'Ch·ªçn "B·∫£n ƒë·ªì" ƒë·ªÉ xem tr∆∞·ªõc'}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Little Reporter (Ph√≥ng vi√™n MƒÉng non) ---
        const LittleReporter = () => {
            const [name, setName] = useState('');
            const [issueType, setIssueType] = useState('H∆∞ h·ªèng c∆° s·ªü v·∫≠t ch·∫•t');
            const [urgency, setUrgency] = useState('low'); 
            const [imageLink, setImageLink] = useState('');
            const [content, setContent] = useState('');
            const [status, setStatus] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setStatus('sending');
                try {
                    await addDoc(collection(db, 'reports'), {
                        name: name || '·∫®n danh',
                        type: issueType,
                        urgency: urgency,
                        image: imageLink,
                        content,
                        status: 'pending', 
                        createdAt: serverTimestamp(),
                    });
                    setStatus('success'); setName(''); setContent(''); setImageLink('');
                } catch (err) { setStatus('error'); }
            };

            const urgencyOptions = [
                { val: 'low', label: 'B√¨nh th∆∞·ªùng', color: 'bg-traffic-green', icon: 'üü¢' },
                { val: 'medium', label: 'C·∫ßn ch√∫ √Ω', color: 'bg-traffic-yellow', icon: 'üü°' },
                { val: 'high', label: 'Nguy hi·ªÉm!', color: 'bg-traffic-red', icon: 'üî¥' }
            ];

            return (
                <div className="max-w-2xl mx-auto">
                    <div className="bg-white rounded-3xl p-8 border-4 border-purple-100 shadow-cartoon relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-6 opacity-10 rotate-12"><Camera size={100} className="text-purple-600"/></div>
                        <h2 className="font-display text-3xl font-black text-purple-600 mb-2 flex items-center gap-3"><span className="bg-purple-100 p-2 rounded-xl"><Camera/></span> Ph√≥ng vi√™n MƒÉng non</h2>
                        <p className="text-slate-500 mb-6 font-semibold">Th·∫•y ƒëi·ªÅu g√¨ ch∆∞a an to√†n? H√£y b√°o ngay cho Bi·ªát ƒë·ªôi Giao th√¥ng nh√©!</p>
                        {status === 'success' ? (
                            <div className="bg-green-50 p-8 rounded-2xl text-center border-2 border-green-200 animate-bounce">
                                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle className="w-10 h-10 text-green-600"/></div>
                                <h3 className="font-display text-2xl font-bold text-green-700">ƒê√£ g·ª≠i tin!</h3>
                                <p className="text-green-800">C·∫£m ∆°n b·∫°n ƒë√£ g√≥p ph·∫ßn gi√∫p tr∆∞·ªùng an to√†n h∆°n.</p>
                                <button onClick={() => setStatus('')} className="mt-4 font-bold underline text-green-600">G·ª≠i tin kh√°c</button>
                            </div>
                        ) : (
                            <form onSubmit={handleSubmit} className="space-y-4 relative z-10">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="font-bold text-slate-700 block mb-1">T√™n c·ªßa b·∫°n</label><input className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-bold focus:border-purple-400 outline-none" placeholder="VD: B√© Bi l·ªõp 3A" value={name} onChange={e=>setName(e.target.value)} /></div>
                                    <div><label className="font-bold text-slate-700 block mb-1">Lo·∫°i s·ª± c·ªë</label><select className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-bold focus:border-purple-400 outline-none" value={issueType} onChange={e=>setIssueType(e.target.value)}><option>Bi·ªÉn b√°o h·ªèng/m·ªù</option><option>H·ªë g√†/ƒê∆∞·ªùng x·∫•u</option><option>√ôn t·∫Øc giao th√¥ng</option><option>ƒêi xe kh√¥ng m≈© b·∫£o hi·ªÉm</option><option>Kh√°c</option></select></div>
                                </div>
                                <div><label className="font-bold text-slate-700 block mb-2">M·ª©c ƒë·ªô kh·∫©n c·∫•p</label><div className="flex gap-2">{urgencyOptions.map(opt => (<button type="button" key={opt.val} onClick={() => setUrgency(opt.val)} className={`flex-1 py-3 rounded-xl font-bold border-2 transition-all ${urgency === opt.val ? 'border-black shadow-cartoon transform -translate-y-1 ' + opt.color + ' text-white' : 'border-slate-200 bg-white text-slate-500 hover:bg-slate-50'}`}>{opt.label}</button>))}</div></div>
                                <div><label className="font-bold text-slate-700 block mb-1">M√¥ t·∫£ s·ª± vi·ªác *</label><textarea required className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 h-24 font-bold focus:border-purple-400 outline-none resize-none" placeholder="K·ªÉ chi ti·∫øt h∆°n cho ch√∫ng t·ªõ nghe nh√©..." value={content} onChange={e=>setContent(e.target.value)}></textarea></div>
                                <div><label className="font-bold text-slate-700 block mb-1 flex items-center gap-2"><Camera className="w-4 h-4"/> Link ·∫¢nh minh h·ªça (N·∫øu c√≥)</label><input className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 text-sm focus:border-purple-400 outline-none" placeholder="https://..." value={imageLink} onChange={e=>setImageLink(e.target.value)} /></div>
                                <button disabled={status === 'sending'} className="w-full bg-purple-600 text-white font-black text-lg py-4 rounded-2xl shadow-cartoon btn-cartoon hover:bg-purple-700 flex items-center justify-center gap-2">{status === 'sending' ? 'ƒêang g·ª≠i...' : <>G·ª¨I B√ÅO C√ÅO NGAY <Siren className="animate-pulse"/></>}</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- Traffic Quiz ---
        const TrafficQuiz = () => {
            const [questions, setQuestions] = useState([]);
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [loading, setLoading] = useState(true);

            // Fetch Data on Load
            useEffect(() => {
                const initQuiz = async () => {
                    try {
                        // 1. Get Settings (Quiz Limit)
                        let quizLimit = 10;
                        const settingsSnap = await getDoc(doc(db, 'quiz_settings', 'config'));
                        if (settingsSnap.exists()) {
                            quizLimit = settingsSnap.data().quizLimit || 10;
                        }

                        // 2. Get All Questions
                        const qSnap = await getDocs(collection(db, 'quiz_questions'));
                        const allQuestions = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                        // 3. Shuffle & Slice
                        if (allQuestions.length > 0) {
                            // Fisher-Yates Shuffle
                            for (let i = allQuestions.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
                            }
                            setQuestions(allQuestions.slice(0, quizLimit));
                        }
                    } catch (err) {
                        console.error("L·ªói t·∫£i c√¢u h·ªèi:", err);
                    } finally {
                        setLoading(false);
                    }
                };
                initQuiz();
            }, []);

            const handleAns = (i) => {
                // Check correct option
                if (i === questions[idx].correctOption) {
                    setScore(score + 1);
                }
                
                // Move to next or finish
                if (idx < questions.length - 1) {
                    setIdx(idx + 1);
                } else {
                    setFinished(true);
                }
            };

            // Loading State
            if (loading) return (
                <div className="max-w-2xl mx-auto bg-white rounded-3xl p-10 text-center shadow-xl border-4 border-slate-100">
                    <div className="animate-spin w-10 h-10 border-4 border-brand-blue border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p className="font-bold text-slate-500">ƒêang tr·ªôn ƒë·ªÅ thi...</p>
                </div>
            );

            // Empty State
            if (questions.length === 0) return (
                <div className="max-w-2xl mx-auto bg-white rounded-3xl p-10 text-center shadow-xl border-4 border-slate-100">
                    <div className="text-4xl mb-4">üì≠</div>
                    <h3 className="font-display text-xl font-black text-slate-800">Ch∆∞a c√≥ c√¢u h·ªèi n√†o!</h3>
                    <p className="text-slate-500">H√£y nh·ªù th·∫ßy c√¥ Admin th√™m c√¢u h·ªèi v√†o ng√¢n h√†ng nh√©.</p>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-3xl border-b-8 border-r-8 border-traffic-red border-t-2 border-l-2 border-slate-800 p-8 shadow-2xl relative animate-fade-in">
                    <div className="absolute -top-6 -left-6 transform -rotate-12 bg-traffic-yellow px-4 py-2 rounded-lg font-black border-2 border-black shadow-cartoon">ƒê·ªê VUI!</div>
                    
                    {!finished ? (
                        <div className="text-center">
                            <div className="flex justify-between items-center mb-6 text-xs font-bold text-slate-400 uppercase tracking-widest">
                                <span>C√¢u h·ªèi {idx + 1}/{questions.length}</span>
                                <span>ƒêi·ªÉm: {score}</span>
                            </div>
                            
                            {questions[idx].image && (
                                <img src={questions[idx].image} alt="Minh h·ªça" className="mx-auto h-40 object-contain rounded-xl border-2 border-slate-200 mb-4 bg-slate-50" />
                            )}

                            <h3 className="font-display text-2xl font-black text-slate-800 mb-6 min-h-[4rem] flex items-center justify-center">
                                {questions[idx].question}
                            </h3>
                            
                            <div className="grid gap-3">
                                {questions[idx].options.map((ans, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => handleAns(i)} 
                                        className="p-4 rounded-xl bg-slate-50 hover:bg-brand-blue hover:text-white font-bold border-2 border-slate-200 transition-all shadow-sm text-left flex items-center gap-3 group"
                                    >
                                        <span className="w-8 h-8 rounded-full bg-white text-slate-800 flex items-center justify-center border-2 border-slate-200 group-hover:border-white text-sm font-black">
                                            {String.fromCharCode(65 + i)}
                                        </span>
                                        {ans}
                                    </button>
                                ))}
                            </div>
                            
                            <div className="mt-8 flex justify-center gap-1">
                                {questions.map((_, i) => (
                                    <div key={i} className={`h-1.5 flex-1 rounded-full transition-colors ${i <= idx ? 'bg-brand-blue' : 'bg-slate-100'}`}></div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <div className="text-6xl mb-4 animate-bounce">
                                {score === questions.length ? 'üèÜ' : (score > questions.length / 2 ? 'üéâ' : 'üòÖ')}
                            </div>
                            <h3 className="font-display text-3xl font-black text-slate-800 mb-2">
                                {score === questions.length ? 'Tuy·ªát ƒë·ªânh!' : (score > questions.length / 2 ? 'L√†m t·ªët l·∫Øm!' : 'C·ªë g·∫Øng h∆°n nh√©!')}
                            </h3>
                            <p className="text-xl font-bold text-slate-500 mb-8">
                                B·∫°n tr·∫£ l·ªùi ƒë√∫ng <span className="text-brand-blue text-2xl">{score}/{questions.length}</span> c√¢u.
                            </p>
                            
                            <button 
                                onClick={() => window.location.reload()} 
                                className="bg-traffic-green text-white px-8 py-4 rounded-2xl font-black shadow-cartoon btn-cartoon flex items-center gap-2 mx-auto"
                            >
                                <Undo2 className="w-5 h-5"/> THI L·∫†I NGAY
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- Login Component ---
        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.');
                    setIsLoading(false);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-white p-8 rounded-3xl border-4 border-traffic-yellow shadow-2xl mt-10">
                    <div className="text-center mb-6">
                        <div className="w-20 h-20 bg-traffic-dark rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-cartoon text-white">
                            <User size={40} />
                        </div>
                        <h2 className="font-display text-3xl font-black text-slate-800">ƒêƒÉng nh·∫≠p Admin</h2>
                        <p className="text-slate-500 font-bold text-sm">H·ªá th·ªëng Qu·∫£n tr·ªã An to√†n Giao th√¥ng</p>
                    </div>

                    <form onSubmit={handleLogin} className="space-y-4">
                        <div>
                            <label className="font-bold text-slate-700 block mb-1">Email</label>
                            <input 
                                type="email" 
                                required
                                className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-bold focus:border-brand-blue outline-none transition-colors" 
                                placeholder="example@namha.edu.vn"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                            />
                        </div>
                        <div>
                            <label className="font-bold text-slate-700 block mb-1">M·∫≠t kh·∫©u</label>
                            <input 
                                type="password" 
                                required
                                className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-bold focus:border-brand-blue outline-none transition-colors" 
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                            />
                        </div>
                        
                        {error && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-sm font-bold text-center border-2 border-red-100">{error}</div>}

                        <button 
                            disabled={isLoading}
                            className="w-full bg-brand-blue text-white font-bold py-3 rounded-xl shadow-cartoon btn-cartoon hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                        >
                            {isLoading ? 'ƒêang x·ª≠ l√Ω...' : <><LogIn size={20}/> ƒêƒÉng nh·∫≠p</>}
                        </button>
                    </form>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [user, setUser] = useState(null);
            useEffect(() => { const u = onAuthStateChanged(auth, setUser); return () => u(); }, []);

            // --- FIX: T·ª± ƒë·ªông chuy·ªÉn v√†o trang Admin khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng ---
            useEffect(() => {
                if (user && currentPage === 'login') {
                    setCurrentPage('admin');
                }
            }, [user, currentPage]);
            // -------------------------------------------------------------------

            const renderContent = () => {
                switch(currentPage) {
                    case 'home': return (
                        <div className="space-y-12 animate-fade-in">
                            <div className="bg-traffic-dark rounded-[2.5rem] p-8 md:p-12 text-white relative overflow-hidden shadow-2xl border-b-8 border-slate-900">
                                <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle,_#ffffff_2px,_transparent_2px)] bg-[length:20px_20px]"></div>
                                <div className="relative z-10 flex flex-col md:flex-row items-center gap-8">
                                    <div className="flex-1 text-center md:text-left">
                                        <div className="inline-flex items-center gap-2 bg-traffic-yellow text-slate-900 px-4 py-1 rounded-full font-black text-sm mb-4 transform -rotate-2"><Siren className="w-4 h-4"/> AN TO√ÄN L√Ä B·∫†N</div>
                                        <h2 className="font-display text-4xl md:text-6xl font-black mb-6 leading-tight">C·ªïng tr∆∞·ªùng <br/><span className="text-traffic-green">An to√†n</span> & <span className="text-brand-blue">VƒÉn minh</span></h2>
                                        <div className="flex flex-wrap gap-4 justify-center md:justify-start">
                                            <button onClick={() => setCurrentPage('map')} className="bg-traffic-red text-white px-8 py-4 rounded-2xl font-black shadow-cartoon btn-cartoon flex items-center gap-2"><MapIcon className="w-6 h-6"/> XEM B·∫¢N ƒê·ªí</button>
                                            <button onClick={() => setCurrentPage('quiz')} className="bg-white text-traffic-dark px-8 py-4 rounded-2xl font-black shadow-cartoon btn-cartoon border-2 border-slate-200">THI ƒê·ªê VUI</button>
                                        </div>
                                    </div>
                                    <div className="w-64 h-64 bg-brand-blue rounded-full flex items-center justify-center border-8 border-white/20 shadow-2xl animate-bounce-slow"><Shield className="w-32 h-32 text-white" /></div>
                                </div>
                            </div>
                            <div className="zebra-divider" style={{height:'20px', backgroundImage: 'linear-gradient(90deg, #2C3E50 50%, transparent 50%)', backgroundSize: '60px 100%', opacity: 0.1, margin: '2rem 0'}}></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div onClick={() => setCurrentPage('reporter')} className="bg-purple-100 p-8 rounded-[2rem] border-4 border-purple-200 cursor-pointer hover:bg-purple-200 transition-colors group">
                                    <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mb-4 shadow-cartoon text-purple-600 group-hover:scale-110 transition-transform"><Camera className="w-8 h-8"/></div>
                                    <h3 className="font-display text-2xl font-black text-purple-800 mb-2">Ph√≥ng vi√™n MƒÉng non</h3><p className="font-bold text-purple-600/70">Th·∫•y ƒë∆∞·ªùng h·ªèng, bi·ªÉn b√°o m·ªù? Ch·ª•p ·∫£nh g·ª≠i ngay cho Bi·ªát ƒë·ªôi nh√©!</p>
                                </div>
                                <div onClick={() => setCurrentPage('skills')} className="bg-traffic-light p-8 rounded-[2rem] border-4 border-slate-200 cursor-pointer hover:bg-white transition-colors group">
                                    <div className="w-16 h-16 bg-traffic-yellow rounded-2xl flex items-center justify-center mb-4 shadow-cartoon text-slate-800 group-hover:scale-110 transition-transform"><GraduationCap className="w-8 h-8"/></div>
                                    <h3 className="font-display text-2xl font-black text-slate-800 mb-2">G√≥c K·ªπ NƒÉng</h3><p className="font-bold text-slate-500">H·ªçc c√°ch ƒëi b·ªô, sang ƒë∆∞·ªùng v√† ƒë·ªôi m≈© b·∫£o hi·ªÉm ƒë√∫ng c√°ch.</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 'news': return <NewsFeed />;
                    case 'skills': return <SkillsPage />; // Add Skills Page
                    case 'reporter': return <LittleReporter />;
                    case 'quiz': return <TrafficQuiz />;
                    case 'admin': return user ? <AdminDashboard onLogout={() => signOut(auth)} /> : <Login />;
                    case 'map': return <InteractiveMap isAdmin={!!user} />; 
                    case 'login': return <Login />;
                    default: return <div className="p-8 text-center font-bold text-slate-500">N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</div>;
                }
            };

            return (
                <ErrorBoundary>
                    <div className="min-h-screen pb-20">
                        <Header setCurrentPage={setCurrentPage} user={user} onLogout={() => signOut(auth)} />
                        <main className="container mx-auto px-4 py-8">{renderContent()}</main>
                        <footer className="bg-traffic-dark text-white mt-12 py-12 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-4 bg-white opacity-20 bg-[linear-gradient(90deg,_transparent_50%,_#fff_50%)] bg-[length:50px_100%]"></div>
                            <div className="container mx-auto px-4 text-center">
                                <h3 className="font-display text-2xl font-black mb-4">TR∆Ø·ªúNG TI·ªÇU H·ªåC NAM H√Ä</h3>
                                <p className="font-bold opacity-60">V√¨ n·ª• c∆∞·ªùi tr·∫ª th∆° - H√£y l√°i xe b·∫±ng c·∫£ tr√°i tim</p>
                                <div className="flex justify-center gap-4 mt-8">
                                    <div className="w-3 h-3 rounded-full bg-traffic-red animate-bounce"></div>
                                    <div className="w-3 h-3 rounded-full bg-traffic-yellow animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                    <div className="w-3 h-3 rounded-full bg-traffic-green animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                </div>
                            </div>
                        </footer>
                    </div>
                </ErrorBoundary>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
