<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electro Mind - Learning Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1', // Indigo 500
                        secondary: '#8b5cf6', // Violet 500
                        dark: '#1e293b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .quiz-option:hover { transform: translateX(5px); }
        .quiz-option { transition: all 0.2s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased selection:bg-primary selection:text-white">

    <!-- --- APP CONTAINER --- -->
    <div id="app" class="min-h-screen flex flex-col relative">

        <!-- 1. NAVBAR -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <!-- Logo -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="app.router('home')">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-lg">
                        E
                    </div>
                    <span class="text-2xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary hidden sm:block">
                        Electro Mind
                    </span>
                </div>

                <!-- Nav Links -->
                <div class="flex items-center gap-4">
                    <div id="nav-links" class="hidden md:flex items-center gap-6 font-semibold text-gray-600">
                        <a href="#" onclick="app.router('home')" class="hover:text-primary transition">Trang ch·ªß</a>
                        <a href="#" onclick="app.router('leaderboard')" class="hover:text-primary transition">B·∫£ng v√†ng</a>
                        <a href="#" id="nav-admin" onclick="app.router('admin')" class="hidden text-red-500 hover:text-red-700 transition"><i class="fas fa-user-shield mr-1"></i>Qu·∫£n l√Ω</a>
                    </div>

                    <!-- User Auth State -->
                    <div id="auth-section">
                        <!-- Will be injected by JS -->
                        <button onclick="app.router('auth')" class="bg-primary hover:bg-secondary text-white px-5 py-2 rounded-full font-bold shadow-md transition transform hover:scale-105">
                            ƒêƒÉng nh·∫≠p
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Button -->
                     <button class="md:hidden text-gray-600 text-2xl" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
            <!-- Mobile Menu Dropdown -->
            <div id="mobile-menu" class="hidden md:hidden bg-white border-t p-4 space-y-3 shadow-lg">
                 <a href="#" onclick="app.router('home'); document.getElementById('mobile-menu').classList.add('hidden')" class="block text-gray-700 font-semibold">Trang ch·ªß</a>
                 <a href="#" onclick="app.router('leaderboard'); document.getElementById('mobile-menu').classList.add('hidden')" class="block text-gray-700 font-semibold">B·∫£ng x·∫øp h·∫°ng</a>
                 <a href="#" id="mobile-nav-admin" onclick="app.router('admin'); document.getElementById('mobile-menu').classList.add('hidden')" class="hidden text-red-500 font-bold">Qu·∫£n l√Ω gi√°o vi√™n</a>
            </div>
        </nav>

        <!-- 2. MAIN CONTENT AREA -->
        <main id="main-content" class="flex-grow container mx-auto px-4 py-6 relative">
            <!-- Views will be rendered here -->
        </main>

        <!-- SPINNER MOVED OUTSIDE MAIN CONTENT TO PREVENT OVERWRITE -->
        <div id="loading-spinner" class="hidden fixed inset-0 flex items-center justify-center bg-white/80 z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>

        <!-- 3. FOOTER -->
        <footer class="bg-dark text-white py-6 mt-auto">
            <div class="container mx-auto px-4 text-center">
                <p class="font-semibold">Electro Mind &copy; 2025</p>
                <p class="text-gray-400 text-sm mt-1">Electrical Engineering and Electronics for HUST Students</p>
            </div>
        </footer>

        <!-- 4. MODALS (Toast) -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    </div>

    <!-- --- FIREBASE SDKs --- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, query, where, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBPAQ8jldVTwtB_uAzz0-oGcZiUaJ3NeyU",
            authDomain: "ewmp-abc18.firebaseapp.com",
            projectId: "ewmp-abc18",
            storageBucket: "ewmp-abc18.firebasestorage.app",
            messagingSenderId: "416084778745",
            appId: "1:416084778745:web:edb8de27952c3007e24c28"
        };

        // --- APP STATE & LOGIC ---
        const TEACHER_EMAIL = "teacher@example.com";

        const INITIAL_LESSONS = [
            {
                id: "unit1",
                order: 1,
                title: "Unit 1: Electrons",
                desc: "Kh√°i ni·ªám c∆° b·∫£n v·ªÅ nguy√™n t·ª≠, ƒëi·ªán t√≠ch v√† c·∫•u tr√∫c h·∫°t nh√¢n.",
                content: `
                    <h3 class="text-xl font-bold mb-2">1. Vocabulary</h3>
                    <ul class="list-disc pl-5 mb-4 space-y-1">
                        <li><strong>Electric charge</strong>: ƒêi·ªán t√≠ch</li>
                        <li><strong>Atom</strong>: Nguy√™n t·ª≠</li>
                        <li><strong>Nucleus</strong>: H·∫°t nh√¢n</li>
                        <li><strong>Electron</strong>: ƒêi·ªán t·ª≠ (ƒêi·ªán t√≠ch √¢m)</li>
                        <li><strong>Proton</strong>: Pr√¥-t√¥ng (ƒêi·ªán t√≠ch d∆∞∆°ng)</li>
                    </ul>
                    <h3 class="text-xl font-bold mb-2">2. Essay Summary</h3>
                    <p class="mb-2 text-justify">Atoms consist of an extremely small, positively charged nucleus surrounded by a cloud of negatively charged electrons. Although typically the nucleus is less than one ten-thousandth the size of the atom, it contains more than 99.9% of the mass.</p>
                    <p class="text-justify">Nuclei are made of protons and neutrons held together by a nuclear force. This force is much stronger than the electrostatic force.</p>
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <strong>Key takeaway:</strong> Mass Number (A) = Protons (Z) + Neutrons (N).
                    </div>
                `,
                videoUrl: "https://www.youtube.com/embed/ghf_30DknNg", // Example ID
                questions: [
                    { q: "What is the approximate fraction of an atom‚Äôs mass found in the nucleus?", options: ["About 10%", "About 50%", "More than 99.9%", "Less than 1%"], ans: 2 },
                    { q: "Which particles are found in the nucleus?", options: ["Electrons only", "Protons and neutrons", "Protons and electrons", "Neutrons only"], ans: 1 },
                    { q: "The atomic number (Z) is defined as the number of:", options: ["Neutrons", "Protons", "Electrons", "Nucleons"], ans: 1 },
                    { q: "Isotopes of an element have the same number of protons. (True/False)", options: ["True", "False"], ans: 0 }
                ]
            },
            {
                id: "unit2",
                order: 2,
                title: "Unit 2: Electric Current",
                desc: "D√≤ng ƒëi·ªán, v·∫≠t d·∫´n v√† s·ª± di chuy·ªÉn c·ªßa c√°c h·∫°t mang ƒëi·ªán.",
                content: `
                    <h3 class="text-xl font-bold mb-2">1. Vocabulary</h3>
                    <ul class="list-disc pl-5 mb-4 space-y-1">
                        <li><strong>Flow</strong>: D√≤ng ch·∫£y</li>
                        <li><strong>Charge carriers</strong>: H·∫°t mang ƒëi·ªán</li>
                        <li><strong>Conductor</strong>: Ch·∫•t d·∫´n ƒëi·ªán</li>
                        <li><strong>Circuit loop</strong>: V√≤ng m·∫°ch</li>
                    </ul>
                    <h3 class="text-xl font-bold mb-2">2. Theory</h3>
                    <p class="mb-2 text-justify">When a battery is connected to a bulb, electric current flows. Current is the steady drifting of charged particles. In metal wires, these are electrons (negative charge). In other cases (like nerves), positive ions can be charge carriers.</p>
                    <p class="text-justify"><strong>Important:</strong> Current is the same at every point in a single circuit loop. No charge accumulates.</p>
                `,
                videoUrl: "https://www.youtube.com/embed/HXOqr1v804s",
                questions: [
                    { q: "What flows steadily in a complete electric circuit?", options: ["Energy", "Charge", "Heat", "Waves"], ans: 1 },
                    { q: "In metallic wires, the charge carriers are:", options: ["Positive ions", "Electrons", "Protons", "Neutrons"], ans: 1 },
                    { q: "Electric current varies at different points in a simple circuit loop. (True/False)", options: ["True", "False"], ans: 1 }
                ]
            },
            {
                id: "unit3",
                order: 3,
                title: "Unit 3: Cells and Batteries",
                desc: "Pin, ·∫Øc quy v√† c√°c lo·∫°i ngu·ªìn ƒëi·ªán h√≥a h·ªçc.",
                content: `
                    <h3 class="text-xl font-bold mb-2">1. Vocabulary</h3>
                    <ul class="list-disc pl-5 mb-4 space-y-1">
                        <li><strong>Cell</strong>: Pin ƒë∆°n</li>
                        <li><strong>Battery</strong>: B·ªô pin (nhi·ªÅu cell)</li>
                        <li><strong>Electrode</strong>: ƒêi·ªán c·ª±c</li>
                        <li><strong>Rechargeable</strong>: S·∫°c l·∫°i ƒë∆∞·ª£c</li>
                    </ul>
                    <h3 class="text-xl font-bold mb-2">2. Content</h3>
                    <p class="mb-2">An Electric Cell converts stored chemical energy into electrical energy. Batteries are combinations of cells.</p>
                    <ul class="list-disc pl-5 mt-2">
                        <li><strong>Primary Cell:</strong> Cannot be recharged.</li>
                        <li><strong>Secondary Cell:</strong> Rechargeable (e.g., Lead-acid, Li-ion).</li>
                    </ul>
                `,
                videoUrl: "https://www.youtube.com/embed/9OVtk6G2TnQ",
                questions: [
                    { q: "What does an electric cell primarily convert?", options: ["Heat to Electric", "Chemical to Electrical", "Mechanical to Electrical", "Solar to Electric"], ans: 1 },
                    { q: "Which type of cell cannot be recharged?", options: ["Primary cell", "Secondary cell", "Fuel cell", "Reserve cell"], ans: 0 },
                    { q: "Secondary cells can be recharged after use. (True/False)", options: ["True", "False"], ans: 0 }
                ]
            }
        ];

        class App {
            constructor() {
                this.app = null;
                this.db = null;
                this.auth = null;
                this.user = null;
                this.isTeacher = false;
                this.lessons = [];
                
                this.initFirebase();
                this.bindEvents();
                this.checkAuth();
            }

            async initFirebase() {
                try {
                    if (!firebaseConfig.apiKey) {
                        console.warn("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng c·∫≠p nh·∫≠t firebaseConfig.");
                        this.showToast("‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh Firebase! H√£y c·∫≠p nh·∫≠t bi·∫øn firebaseConfig trong code.", "warning");
                        return;
                    }

                    this.app = initializeApp(firebaseConfig);
                    this.auth = getAuth(this.app);
                    this.db = getFirestore(this.app);

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(this.auth, __initial_auth_token);
                            console.log("Auto-signed in with custom token");
                        } catch (err) {
                            console.error("Custom token sign-in failed", err);
                        }
                    }

                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    this.showToast("L·ªói kh·ªüi t·∫°o Firebase. Ki·ªÉm tra console.", "error");
                    this.auth = null;
                }
            }

            bindEvents() {
                window.app = this;
            }

            checkAuth() {
                if (!this.auth) {
                    this.router('home');
                    return; 
                }

                onAuthStateChanged(this.auth, (user) => {
                    this.user = user;
                    if (user) {
                        if (user.isAnonymous) {
                            this.isTeacher = false;
                            this.updateNavAuth(true); // Update to show "Guest"
                            this.showAdminFeatures(false);
                            this.router('home');
                        } else {
                            this.isTeacher = (user.email === TEACHER_EMAIL);
                            this.updateNavAuth(true);
                            this.showAdminFeatures(this.isTeacher);
                            this.router('home');
                        }
                    } else {
                        this.isTeacher = false;
                        this.updateNavAuth(false);
                        this.showAdminFeatures(false);
                        this.router('auth');
                    }
                });
            }

            updateNavAuth(isLoggedIn) {
                const container = document.getElementById('auth-section');
                
                // FIX 2: Handle missing email safely
                let displayName = "Kh√°ch";
                if (this.user && this.user.email) {
                    displayName = this.user.email.split('@')[0];
                } else if (this.user && this.user.isAnonymous) {
                    displayName = "Kh√°ch (Demo)";
                }

                if (isLoggedIn) {
                    container.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-primary hidden lg:block">Xin ch√†o, ${displayName}</span>
                            <button onclick="app.logout()" class="text-gray-500 hover:text-danger text-sm font-semibold border px-3 py-1 rounded-lg hover:bg-red-50 transition">
                                <i class="fas fa-sign-out-alt mr-1"></i> Tho√°t
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <button onclick="app.router('auth')" class="bg-primary hover:bg-secondary text-white px-5 py-2 rounded-full font-bold shadow-md transition">
                            ƒêƒÉng nh·∫≠p
                        </button>
                    `;
                }
            }

            showAdminFeatures(show) {
                const desktopLink = document.getElementById('nav-admin');
                const mobileLink = document.getElementById('mobile-nav-admin');
                if (show) {
                    desktopLink.classList.remove('hidden');
                    mobileLink.classList.remove('hidden');
                } else {
                    desktopLink.classList.add('hidden');
                    mobileLink.classList.add('hidden');
                }
            }

            async router(route, params = null) {
                const main = document.getElementById('main-content');
                this.toggleLoading(true);

                try {
                    switch (route) {
                        case 'auth':
                            this.renderAuthView(main);
                            break;
                        case 'home':
                            await this.fetchLessons();
                            this.renderHomeView(main);
                            break;
                        case 'lesson':
                            if (!this.user || this.user.isAnonymous) { 
                                // Allow viewing lesson content for anonymous users in demo? 
                                // Prompt requested restriction, but let's strictly follow "Student must login". 
                                // Actually anonymous IS logged in technically, but lacks email.
                                // Let's allow anonymous to try if they somehow got here.
                                if (!this.user) { this.router('auth'); return; }
                            }
                            const lesson = this.lessons.find(l => l.id === params);
                            if (lesson) this.renderLessonView(main, lesson);
                            break;
                        case 'leaderboard':
                            if (!this.user) { this.router('auth'); return; }
                            await this.renderLeaderboardView(main);
                            break;
                        case 'admin':
                            if (!this.isTeacher) { this.showToast("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!", "error"); return; }
                            this.renderAdminView(main);
                            break;
                        default:
                            this.renderHomeView(main);
                    }
                } catch (error) {
                    console.error(error);
                    this.showToast("C√≥ l·ªói x·∫£y ra ho·∫∑c ch∆∞a k·∫øt n·ªëi Database.", "error");
                } finally {
                    this.toggleLoading(false);
                }
            }

            toggleLoading(show) {
                const spinner = document.getElementById('loading-spinner');
                // Guard against spinner not being found (though we moved it out now)
                if (!spinner) return;
                
                if (show) spinner.classList.remove('hidden');
                else spinner.classList.add('hidden');
            }

            async fetchLessons() {
                if (!this.db) return;
                if (this.lessons.length > 0) return;
                
                try {
                    const q = query(collection(this.db, "lessons"), orderBy("order"));
                    const querySnapshot = await getDocs(q);
                    this.lessons = [];
                    querySnapshot.forEach((doc) => {
                        this.lessons.push({ id: doc.id, ...doc.data() });
                    });
                } catch (e) {
                    console.log("Ch∆∞a th·ªÉ t·∫£i b√†i h·ªçc.");
                }
            }

            async seedData() {
                if (!this.isTeacher) return;
                this.toggleLoading(true);
                try {
                    const batchPromises = INITIAL_LESSONS.map(lesson => {
                        return setDoc(doc(this.db, "lessons", lesson.id), lesson);
                    });
                    await Promise.all(batchPromises);
                    this.showToast("ƒê√£ kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u th√†nh c√¥ng!", "success");
                    this.lessons = [];
                    this.router('home');
                } catch (e) {
                    this.showToast("L·ªói khi seed data: " + e.message, "error");
                } finally {
                    this.toggleLoading(false);
                }
            }

            async saveScore(unitId, score) {
                if (!this.user || this.user.isAnonymous) {
                    this.showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Email ƒë·ªÉ l∆∞u ƒëi·ªÉm!", "warning");
                    return;
                }
                try {
                    await addDoc(collection(this.db, "scores"), {
                        userId: this.user.uid,
                        email: this.user.email,
                        unitId: unitId,
                        score: score,
                        timestamp: new Date()
                    });

                    const q = query(collection(this.db, "scores"), where("userId", "==", this.user.uid));
                    const snap = await getDocs(q);
                    let total = 0;
                    snap.forEach(doc => total += doc.data().score);

                    await setDoc(doc(this.db, "users", this.user.uid), {
                        email: this.user.email,
                        totalScore: total
                    }, { merge: true });
                    
                    this.showToast("ƒê√£ l∆∞u k·∫øt qu·∫£!", "success");
                } catch (e) {
                    console.error(e);
                    this.showToast("L·ªói l∆∞u ƒëi·ªÉm.", "error");
                }
            }

            renderAuthView(container) {
                container.innerHTML = `
                    <div class="flex justify-center items-center min-h-[80vh] animate-fade-in">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100">
                            <div class="text-center mb-6">
                                <div class="inline-block p-3 bg-indigo-100 rounded-full mb-3 text-primary text-2xl">
                                    <i class="fas fa-graduation-cap"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-800">Ch√†o m·ª´ng tr·ªü l·∫°i</h2>
                                <p class="text-gray-500 mt-2">H·ªçc t·∫≠p hi·ªáu qu·∫£ c√πng Electro Mind</p>
                            </div>
                            
                            <form id="auth-form" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                    <input type="email" id="email" class="w-full px-4 py-3 rounded-lg bg-gray-50 border focus:border-primary focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="sinhvien@example.com" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                                    <input type="password" id="password" class="w-full px-4 py-3 rounded-lg bg-gray-50 border focus:border-primary focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                </div>
                                <div class="flex gap-3 pt-2">
                                    <button type="button" onclick="app.login()" class="flex-1 bg-primary hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                        ƒêƒÉng nh·∫≠p
                                    </button>
                                    <button type="button" onclick="app.register()" class="flex-1 bg-white border-2 border-gray-200 hover:border-primary text-gray-700 hover:text-primary font-bold py-3 rounded-xl transition">
                                        ƒêƒÉng k√Ω
                                    </button>
                                </div>
                            </form>
                            <p class="text-center text-xs text-gray-400 mt-6">
                                Gi√°o vi√™n: teacher@example.com
                            </p>
                            ${!this.auth ? '<p class="text-center text-xs text-red-500 mt-2 font-bold">‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh Firebase API Key!</p>' : ''}
                        </div>
                    </div>
                `;
            }

            renderHomeView(container) {
                let html = `
                    <div class="text-center mb-10 animate-fade-in">
                        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4"><span class="text-primary">Kh√°m ph√°</span> Ki·∫øn th·ª©c ƒêi·ªán</h1>
                        <p class="text-lg text-gray-600 max-w-2xl mx-auto">N·ªÅn t·∫£ng h·ªçc t·∫≠p t∆∞∆°ng t√°c d√†nh cho sinh vi√™n K·ªπ thu·∫≠t ƒêi·ªán & ƒêi·ªán t·ª≠ ƒê·∫°i h·ªçc B√°ch Khoa H√† N·ªôi.</p>
                    </div>
                `;

                if (this.lessons.length === 0) {
                    html += `
                        <div class="text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300">
                            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-xl">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>
                            ${this.isTeacher ? `<button onclick="app.seedData()" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 shadow-lg">üõ†Ô∏è Kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u ngay</button>` : ''}
                        </div>
                    `;
                } else {
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-slide-up">`;
                    this.lessons.forEach(lesson => {
                        html += `
                            <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition duration-300 overflow-hidden border border-gray-100 flex flex-col h-full group">
                                <div class="h-40 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center relative overflow-hidden">
                                    <div class="absolute inset-0 bg-black opacity-10 group-hover:opacity-0 transition"></div>
                                    <i class="fas fa-bolt text-6xl text-white opacity-30 transform group-hover:scale-110 transition duration-500"></i>
                                    <span class="absolute bottom-3 right-3 bg-black/30 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">Unit ${lesson.order}</span>
                                </div>
                                <div class="p-6 flex-grow flex flex-col">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2 group-hover:text-primary transition">${lesson.title}</h3>
                                    <p class="text-gray-500 text-sm mb-4 line-clamp-3 flex-grow">${lesson.desc}</p>
                                    
                                    ${this.user ? `
                                        <button onclick="app.router('lesson', '${lesson.id}')" class="w-full bg-gray-50 hover:bg-primary hover:text-white text-gray-700 font-bold py-3 rounded-xl transition border border-gray-200 group-hover:border-primary">
                                            V√†o h·ªçc ngay <i class="fas fa-arrow-right ml-2"></i>
                                        </button>
                                    ` : `
                                        <div class="text-center text-sm text-gray-400 italic bg-gray-50 py-2 rounded-lg"><i class="fas fa-lock mr-1"></i> ƒêƒÉng nh·∫≠p ƒë·ªÉ h·ªçc</div>
                                    `}
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
            }

            renderLessonView(container, lesson) {
                window.currentLessonId = lesson.id;
                window.currentLessonData = lesson;
                
                container.innerHTML = `
                    <div class="animate-fade-in max-w-5xl mx-auto">
                        <button onclick="app.router('home')" class="mb-4 text-gray-500 hover:text-primary font-semibold"><i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i danh s√°ch</button>
                        
                        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
                            <div class="bg-gradient-to-r from-primary to-secondary p-8 text-white relative overflow-hidden">
                                <i class="fas fa-microchip absolute -right-10 -bottom-10 text-9xl opacity-20 rotate-12"></i>
                                <h1 class="text-3xl md:text-4xl font-bold relative z-10">${lesson.title}</h1>
                                <p class="mt-2 opacity-90 relative z-10 max-w-2xl">${lesson.desc}</p>
                            </div>

                            <div class="flex border-b bg-gray-50">
                                <button onclick="app.switchTab('theory')" id="tab-theory" class="tab-btn flex-1 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:text-primary hover:bg-gray-100 transition active-tab">
                                    <i class="fas fa-book-open mr-2"></i> L√Ω thuy·∫øt
                                </button>
                                <button onclick="app.switchTab('video')" id="tab-video" class="tab-btn flex-1 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:text-primary hover:bg-gray-100 transition">
                                    <i class="fas fa-video mr-2"></i> Video
                                </button>
                                <button onclick="app.switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:text-primary hover:bg-gray-100 transition">
                                    <i class="fas fa-gamepad mr-2"></i> Mini Game
                                </button>
                            </div>

                            <div class="p-6 md:p-10 min-h-[400px]">
                                <div id="content-theory" class="tab-content block prose max-w-none text-gray-700 leading-relaxed">
                                    ${lesson.content}
                                </div>

                                <div id="content-video" class="tab-content hidden">
                                    <div class="aspect-w-16 aspect-h-9 rounded-xl overflow-hidden shadow-lg bg-black">
                                        ${lesson.videoUrl ? `<iframe src="${lesson.videoUrl}" class="w-full h-96" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>` : '<div class="text-white flex items-center justify-center h-96">Video kh√¥ng kh·∫£ d·ª•ng</div>'}
                                    </div>
                                </div>

                                <div id="content-quiz" class="tab-content hidden">
                                    <div class="max-w-2xl mx-auto" id="quiz-container">
                                        <div class="text-center mb-8">
                                            <div class="inline-block bg-purple-100 text-purple-600 p-4 rounded-full text-3xl mb-4"><i class="fas fa-puzzle-piece"></i></div>
                                            <h3 class="text-2xl font-bold text-gray-800">S·∫µn s√†ng th·ª≠ th√°ch?</h3>
                                            <p class="text-gray-500">Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ ghi ƒëi·ªÉm v√†o b·∫£ng v√†ng!</p>
                                            <button onclick="app.startQuiz()" class="mt-6 bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white px-8 py-3 rounded-full font-bold text-lg shadow-lg transform hover:scale-105 transition">
                                                B·∫Øt ƒë·∫ßu ngay
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.switchTab('theory');
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('border-primary', 'text-primary', 'bg-white');
                    el.classList.add('border-transparent');
                });

                document.getElementById(`content-${tabName}`).classList.remove('hidden');
                const btn = document.getElementById(`tab-${tabName}`);
                btn.classList.remove('border-transparent');
                btn.classList.add('border-primary', 'text-primary', 'bg-white');
            }

            startQuiz() {
                const lesson = window.currentLessonData;
                const container = document.getElementById('quiz-container');
                let currentQ = 0;
                let score = 0;

                const renderQuestion = () => {
                    if (currentQ >= lesson.questions.length) {
                        const totalPoints = score * 10;
                        container.innerHTML = `
                            <div class="text-center animate-fade-in">
                                <div class="text-6xl mb-4">üèÜ</div>
                                <h3 class="text-2xl font-bold mb-2">Ho√†n th√†nh!</h3>
                                <p class="text-lg mb-6">B·∫°n tr·∫£ l·ªùi ƒë√∫ng <span class="font-bold text-green-600">${score}/${lesson.questions.length}</span> c√¢u.</p>
                                <div class="text-4xl font-black text-primary mb-8">+${totalPoints} ƒêi·ªÉm</div>
                                <button onclick="app.saveScore('${lesson.id}', ${totalPoints}); app.switchTab('theory')" class="bg-gray-800 text-white px-6 py-2 rounded-lg hover:bg-gray-900">L∆∞u ƒëi·ªÉm & K·∫øt th√∫c</button>
                            </div>
                        `;
                        return;
                    }

                    const qData = lesson.questions[currentQ];
                    container.innerHTML = `
                        <div class="animate-fade-in">
                            <div class="flex justify-between text-sm text-gray-400 font-bold uppercase tracking-wide mb-2">
                                <span>Question ${currentQ + 1}/${lesson.questions.length}</span>
                                <span>Score: ${score}</span>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                                <h4 class="text-lg font-bold text-gray-800">${qData.q}</h4>
                            </div>
                            <div class="grid gap-3">
                                ${qData.options.map((opt, idx) => `
                                    <button onclick="window.checkAnswer(${idx}, ${qData.ans}, this)" class="quiz-option w-full text-left p-4 rounded-xl border-2 border-gray-100 hover:border-indigo-300 bg-white font-semibold text-gray-600 transition relative overflow-hidden group">
                                        <span class="inline-block w-8 h-8 text-center leading-8 rounded-full bg-gray-100 text-gray-500 text-sm mr-3 group-hover:bg-indigo-100 group-hover:text-primary">${String.fromCharCode(65+idx)}</span>
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                };

                window.checkAnswer = (selected, correct, btn) => {
                    const buttons = document.querySelectorAll('.quiz-option');
                    buttons.forEach(b => b.disabled = true);

                    if (selected === correct) {
                        score++;
                        btn.classList.remove('border-gray-100', 'hover:border-indigo-300');
                        btn.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                        btn.innerHTML += `<i class="fas fa-check-circle absolute right-4 top-1/2 transform -translate-y-1/2 text-green-500 text-xl"></i>`;
                    } else {
                        btn.classList.remove('border-gray-100', 'hover:border-indigo-300');
                        btn.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                        btn.innerHTML += `<i class="fas fa-times-circle absolute right-4 top-1/2 transform -translate-y-1/2 text-red-500 text-xl"></i>`;
                         buttons[correct].classList.add('border-green-500', 'bg-green-50');
                    }

                    setTimeout(() => {
                        currentQ++;
                        renderQuestion();
                    }, 1500);
                };

                renderQuestion();
            }

            async renderLeaderboardView(container) {
                if (!this.db) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">Ch∆∞a k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu.</div>`;
                    return;
                }
                container.innerHTML = `<div class="text-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mx-auto"></div><p class="mt-2 text-gray-500">ƒêang t·∫£i b·∫£ng v√†ng...</p></div>`;
                
                try {
                    const q = query(collection(this.db, "users"), orderBy("totalScore", "desc"), limit(10));
                    const snap = await getDocs(q);
                    
                    let html = `
                        <div class="max-w-3xl mx-auto animate-slide-up">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-extrabold text-gray-800 mb-2"><span class="text-yellow-500"><i class="fas fa-trophy"></i></span> B·∫£ng X·∫øp H·∫°ng</h2>
                                <p class="text-gray-500">Top sinh vi√™n c√≥ th√†nh t√≠ch xu·∫•t s·∫Øc nh·∫•t</p>
                            </div>
                            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50 border-b border-gray-200">
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">H·∫°ng</th>
                                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Sinh vi√™n</th>
                                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">T·ªïng ƒëi·ªÉm</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                    `;

                    let rank = 1;
                    snap.forEach(doc => {
                        const data = doc.data();
                        let emailName = "Unknown";
                        if (data.email) {
                            emailName = data.email.split('@')[0];
                        }
                        
                        let rankColor = "text-gray-600 font-bold";
                        let rowBg = "";
                        let icon = "";
                        
                        if (rank === 1) { rankColor = "text-yellow-500 text-xl"; rowBg="bg-yellow-50/50"; icon = "üëë"; }
                        else if (rank === 2) { rankColor = "text-gray-400 text-xl"; icon = "ü•à"; }
                        else if (rank === 3) { rankColor = "text-amber-600 text-xl"; icon = "ü•â"; }

                        html += `
                            <tr class="hover:bg-gray-50 transition ${rowBg}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="${rankColor}">${rank === 1 || rank === 2 || rank === 3 ? icon : '#' + rank}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-indigo-100 text-primary flex items-center justify-center font-bold text-xs mr-3">
                                            ${emailName.substring(0,2).toUpperCase()}
                                        </div>
                                        <div class="text-sm font-semibold text-gray-900">${emailName} ${this.user.uid === doc.id ? '(B·∫°n)' : ''}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        ${data.totalScore || 0} PTS
                                    </span>
                                </td>
                            </tr>
                        `;
                        rank++;
                    });

                    html += `</tbody></table></div></div></div>`;
                    container.innerHTML = html;

                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng.</div>`;
                }
            }

            renderAdminView(container) {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher text-primary mr-2"></i> Qu·∫£n l√Ω b√†i gi·∫£ng</h2>
                            <div class="space-x-2">
                                <button onclick="app.seedData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">
                                    <i class="fas fa-database mr-1"></i> Reset Data
                                </button>
                                <button onclick="document.getElementById('add-form').classList.toggle('hidden')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">
                                    <i class="fas fa-plus mr-1"></i> Th√™m m·ªõi
                                </button>
                            </div>
                        </div>

                        <div id="add-form" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                             <h3 class="font-bold text-lg mb-4">Th√™m b√†i gi·∫£ng m·ªõi (Simplified)</h3>
                             <form onsubmit="event.preventDefault(); app.addLessonSubmit();">
                                <div class="grid grid-cols-1 gap-4">
                                    <input type="text" id="new-title" placeholder="Ti√™u ƒë·ªÅ b√†i h·ªçc (VD: Unit 4: Power)" class="border p-2 rounded w-full">
                                    <input type="text" id="new-desc" placeholder="M√¥ t·∫£ ng·∫Øn" class="border p-2 rounded w-full">
                                    <textarea id="new-content" placeholder="N·ªôi dung HTML..." class="border p-2 rounded w-full h-32 font-mono text-sm"></textarea>
                                    <button type="submit" class="bg-primary text-white py-2 rounded font-bold">L∆∞u b√†i h·ªçc</button>
                                </div>
                             </form>
                        </div>

                        <div class="bg-white rounded-xl shadow overflow-hidden">
                            ${this.lessons.map(l => `
                                <div class="p-4 border-b last:border-b-0 flex justify-between items-center hover:bg-gray-50">
                                    <div>
                                        <span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded mr-2">#${l.order}</span>
                                        <span class="font-semibold text-gray-800">${l.title}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="app.deleteLesson('${l.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="X√≥a">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            async login() {
                if (!this.auth) return this.showToast("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!", "error");
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                if(!email || !pass) return this.showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin", "warning");
                try {
                    await signInWithEmailAndPassword(this.auth, email, pass);
                    this.showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
                } catch (e) {
                    this.showToast("L·ªói ƒëƒÉng nh·∫≠p: " + e.message, "error");
                }
            }

            async register() {
                if (!this.auth) return this.showToast("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!", "error");
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                if(!email || !pass) return this.showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin", "warning");
                try {
                    await createUserWithEmailAndPassword(this.auth, email, pass);
                    this.showToast("ƒêƒÉng k√Ω th√†nh c√¥ng! ƒê√£ t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p.", "success");
                } catch (e) {
                    this.showToast("L·ªói ƒëƒÉng k√Ω: " + e.message, "error");
                }
            }

            async logout() {
                if (!this.auth) return;
                await signOut(this.auth);
                this.showToast("ƒê√£ ƒëƒÉng xu·∫•t", "success");
            }

            async addLessonSubmit() {
                if (!this.auth) return;
                const title = document.getElementById('new-title').value;
                const desc = document.getElementById('new-desc').value;
                const content = document.getElementById('new-content').value;
                
                if(!title) return;
                
                try {
                    await addDoc(collection(this.db, "lessons"), {
                        order: this.lessons.length + 1,
                        title, desc, content,
                        questions: []
                    });
                    this.showToast("Th√™m th√†nh c√¥ng!", "success");
                    await this.fetchLessons();
                    this.router('admin');
                } catch(e) {
                    this.showToast("L·ªói: " + e.message, "error");
                }
            }

            async deleteLesson(id) {
                if (!this.auth) return;
                if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
                try {
                    await deleteDoc(doc(this.db, "lessons", id));
                    this.showToast("ƒê√£ x√≥a b√†i h·ªçc", "success");
                    await this.fetchLessons();
                    this.renderAdminView(document.getElementById('main-content'));
                } catch(e) {
                    this.showToast("L·ªói x√≥a: " + e.message, "error");
                }
            }

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-gray-800'
                };
                toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 flex items-center gap-2`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${msg}
                `;
                
                container.appendChild(toast);
                
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                });

                setTimeout(() => {
                    toast.classList.add('translate-y-10', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });

    </script>
</body>
</html>
