<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English With Me - Website H·ªçc Ti·∫øng Anh (v5 - B·∫£ng X·∫øp H·∫°ng)</title>
    <!-- Nh√∫ng font Inter t·ª´ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        /* C√†i ƒë·∫∑t chung & Reset */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --light-blue-bg: #e0f7fa;
            --dark-text: #333;
            --dark-red: #c62828;
            --success-green: #28a745;
            --success-green-hover: #218838;
            /* M·ªöI: M√†u cho t√≠nh nƒÉng AI */
            --ai-purple: #6f42c1;
            --ai-purple-hover: #5a359a;
            --ai-bg: #f5f3f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: var(--dark-text);
            line-height: 1.6;
        }

        /* 1. C√°c th√†nh ph·∫ßn chung */

        /* Top Bar (ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω) */
        .top-bar {
            background-color: #2c2c2c;
            color: white;
            padding: 8px 10%;
            text-align: right;
            font-size: 0.9em;
        }

        .top-bar a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            transition: opacity 0.3s;
            cursor: pointer; /* ƒê√£ c√≥ cursor:pointer t·ª´ showPage */
        }

        .top-bar a:hover {
            opacity: 0.8;
        }

        /* Header (Logo) */
        .header {
            background-color: white;
            text-align: center;
            padding: 25px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header .logo {
            /* S·ª≠ d·ª•ng font 'Pacifico' ƒë·ªÉ gi·∫£ l·∫≠p ch·ªØ vi·∫øt tay */
            font-family: 'Pacifico', cursive;
            font-size: 3em;
            color: #2a2a2a;
            margin: 0;
            text-decoration: none;
        }

        /* Navbar (Menu) */
        .navbar {
            background-color: #000;
            padding: 10px 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            display: inline-block;
            font-weight: 700;
            transition: background-color 0.3s;
            cursor: pointer; /* ƒê·ªïi con tr·ªè th√†nh pointer */
        }

        .navbar a:hover,
        .navbar a.active-nav {
            background-color: #444;
        }

        /* Footer (Ch√¢n trang) */
        .footer {
            background-color: #f4f4f4;
            color: #777;
            text-align: center;
            padding: 25px;
            margin-top: 40px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        /* 2. C·∫•u tr√∫c trang (Page) */

        /* Container cho c√°c trang con */
        .subpage-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .subpage-container h1 {
            text-align: center;
            color: #000;
            margin-bottom: 30px;
        }

        /* M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ c√°c trang */
        .page {
            display: none;
        }
        /* Hi·ªÉn th·ªã trang c√≥ class 'active' */
        .page.active {
            display: block;
        }

        /* N√∫t chung */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-back {
            background-color: #6c757d;
            margin-bottom: 20px;
        }
        .btn-back:hover {
            background-color: #5a6268;
        }

        /* 3. Trang ch·ªß (Home Page) */

        /* Hero Section */
        .hero {
            background-color: var(--light-blue-bg); /* M√†u xanh nh·∫°t t·ª´ h√¨nh ·∫£nh */
            padding: 60px 20px;
            text-align: center;
        }

        .hero-content {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-content h2 {
            font-size: 2.2em;
            color: var(--dark-red); /* M√†u ƒë·ªè ƒë·∫≠m */
            font-weight: 700;
            margin: 0;
            line-height: 1.3;
        }

        /* Welcome Section */
        .welcome {
            padding: 60px 20px;
            text-align: center;
            background-color: white;
        }

        .welcome h2 {
            font-size: 2em;
            color: #000;
            margin-bottom: 15px;
        }

        .welcome p {
            max-width: 700px;
            margin: 0 auto;
            font-size: 1.1em;
            color: #555;
        }

        /* Features Section */
        .features {
            background-color: var(--light-blue-bg); /* C√πng m√†u xanh v·ªõi Hero */
            padding: 60px 20px;
        }

        .feature-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap; /* Cho ph√©p xu·ªëng h√†ng tr√™n di ƒë·ªông */
        }

        /* Th·∫ª t√≠nh nƒÉng (ph·∫£i l√† th·∫ª <a>) */
        .feature-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 300px;
            padding: 25px;
            text-align: center;
            text-decoration: none;
            color: var(--dark-text);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .feature-card h3 {
            font-size: 1.5em;
            color: #000;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        /* M·ªöI: CSS T√çNH NƒÇNG T·ª™ V·ª∞NG M·ªñI NG√ÄY (AI) */
        .word-of-the-day {
            background-color: var(--ai-bg);
            padding: 60px 20px;
            text-align: center;
        }
        .word-of-the-day h2 {
            font-size: 2em;
            color: var(--ai-purple);
            margin-top: 0;
            margin-bottom: 30px;
        }
        .word-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: center;
        }
        
        /* Spinner CSS */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--ai-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .word-content {
            text-align: left;
        }
        .word-image-container {
            width: 100%;
            height: 250px;
            background-color: #eee;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .word-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #word-term {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--ai-purple);
            margin: 0;
        }
        #word-definition {
            font-size: 1.1em;
            color: #555;
            margin: 10px 0;
        }
        #word-example {
            font-size: 1.1em;
            color: #333;
            font-style: italic;
            border-left: 4px solid var(--ai-purple);
            padding-left: 10px;
            margin: 15px 0 0 0;
        }
        
        .btn-ai {
            background-color: var(--ai-purple);
            margin-top: 25px;
        }
        .btn-ai:hover {
            background-color: var(--ai-purple-hover);
        }
        
        #word-error {
            color: var(--dark-red);
            display: none;
        }

        /* ƒêi·ªÅu ch·ªânh layout cho m√†n h√¨nh l·ªõn h∆°n */
        @media (min-width: 768px) {
            .word-container {
                grid-template-columns: 300px 1fr;
                gap: 30px;
            }
            .word-image-container {
                height: 100%;
                min-height: 250px;
            }
        }


        /* 4. Trang Video H∆∞·ªõng D·∫´n */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .video-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s;
            cursor: pointer;
        }

        .video-item:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .video-item img {
            width: 100%;
            height: 170px;
            object-fit: cover;
            display: block;
        }

        .video-item-content {
            padding: 15px;
        }

        .video-item-content h3 {
            margin-top: 0;
            font-size: 1.2em;
        }

        /* 5. Trang ƒê·ªÅ √în Thi */
        .test-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Xu·ªëng h√†ng tr√™n di ƒë·ªông */
            gap: 15px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .test-info h3 {
            margin: 0 0 5px 0;
        }

        .test-info p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        /* General Content Grid (for Cambridge/Global Success) */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .content-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s;
            text-align: center;
            padding: 20px;
        }
        .content-item:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .content-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f0f0f0;
        }
        .content-item h3 {
            margin-top: 0;
            font-size: 1.2em;
        }
        .content-item .btn {
            margin-top: 15px;
        }
        
        /* M·ªöI: Icon ho√†n th√†nh b√†i h·ªçc */
        .completion-icon {
            color: var(--success-green);
            font-weight: bold;
            margin-left: 8px;
            font-size: 1.2em;
        }


        /* Lesson Page Content */
        .lesson-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .lesson-section h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            display: inline-block;
        }
        .lesson-section ul {
            list-style-type: disc;
            margin-left: 20px;
            line-height: 1.8;
        }
        
        /* M·ªöI: N√∫t ho√†n th√†nh b√†i h·ªçc */
        .btn-complete {
            background-color: var(--success-green);
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }
        .btn-complete:hover {
            background-color: var(--success-green-hover);
        }
        .btn-complete.completed,
        .btn-complete:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* 6. Trang Game √în T·∫≠p */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .game-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s;
        }

        .game-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .game-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .game-card h3 {
            margin: 0 0 15px 0;
        }

        /* 7. Responsive */
        @media (max-width: 768px) {
            .top-bar {
                padding: 8px 5%;
                text-align: center;
            }
            .navbar {
                padding: 5px 0;
            }
            .navbar a {
                padding: 10px 8px;
                font-size: 0.9em;
            }
            .hero-content h2 {
                font-size: 1.8em;
            }
            .welcome h2 {
                font-size: 1.7em;
            }
            .test-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .modal-content {
                width: 95% !important;
            }
            /* M·ªöI: Responsive cho game */
            .flashcard-grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .wc-game-area {
                flex-direction: column;
            }
            .wc-grid-container {
                width: 100%;
                max-width: 350px;
                margin-top: 20px;
            }
            #wc-found-words {
                width: 100%;
                max-width: none;
                height: 150px;
            }
        }
        
        /* 8. CSS T√çNH NƒÇNG M·ªöI (C≈©) */
        
        /* Form ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω */
        .auth-form-container {
            max-width: 450px;
            margin: 40px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m h·ªèng layout */
        }
        .auth-form-container .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }
        .auth-switch {
            text-align: center;
            margin-top: 20px;
        }
        .auth-switch a {
            color: var(--primary-color);
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
        }
        .auth-switch a:hover {
            text-decoration: underline;
        }
        .auth-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 5px;
            display: none; /* ·∫®n ban ƒë·∫ßu */
            text-align: center;
        }
        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Video Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 70%;
            max-width: 800px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2.5em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #333;
        }
        .video-player-container {
            width: 100%;
            margin-top: 15px;
            /* Aspect ratio 16:9 */
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .video-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Trang Quiz */
        .quiz-question-text {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .quiz-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .quiz-option {
            background: #f4f4f4;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quiz-option:hover {
            border-color: var(--primary-color);
        }
        .quiz-option.selected {
            background: var(--light-blue-bg);
            border-color: var(--primary-color);
            font-weight: bold;
        }
        .quiz-option.correct {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .quiz-option.wrong {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        #quiz-next-btn {
            margin-top: 20px;
        }
        #quiz-result {
            text-align: center;
            font-size: 1.2em;
        }
        
        /* M·ªöI: CSS Khu v·ª±c b√¨nh lu·∫≠n */
        .comment-section {
            margin-top: 40px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .comment-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        .comment-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-item strong {
            display: block;
            font-size: 0.95em;
            color: var(--primary-color);
        }
        .comment-item small {
            font-size: 0.8em;
            color: #888;
            display: block;
            margin-top: 2px;
        }
        .comment-item p {
            margin: 5px 0 0 0;
            color: #444;
        }
        .comment-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
        }
        .comment-form .auth-message {
            margin-top: -5px; /* ƒê·∫∑t th√¥ng b√°o l·ªói s√°t l√™n tr√™n */
        }

        /* Trang Game Flashcard */
        .flashcard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .flashcard-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            perspective: 1000px; /* Cho hi·ªáu ·ª©ng 3D */
        }
        .flashcard {
            width: 100%;
            height: 150px;
            background-color: transparent;
            cursor: pointer;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
        }
        .flashcard-front {
            background-color: var(--primary-color);
            color: white;
            /* Th√™m bi·ªÉu t∆∞·ª£ng (v√≠ d·ª•) */
            content: '?';
        }
        .flashcard-back {
            background-color: var(--light-blue-bg);
            color: var(--dark-text);
            transform: rotateY(180deg);
            padding: 10px;
            box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m h·ªèng layout */
        }
        .flashcard.matched .flashcard-inner {
            /* Gi·ªØ th·∫ª ng·ª≠a v√† m·ªù ƒëi khi kh·ªõp */
            transform: rotateY(180deg);
            opacity: 0.5;
        }
        .flashcard.matched {
            cursor: default;
        }
        
        /* M·ªöI: CSS CHO GAME N·ªêI T·ª™ (WORD CONNECT) */
        .wc-game-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        #wc-found-words {
            width: 250px;
            max-width: 100%;
            height: 350px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        #wc-found-words h3 {
            margin-top: 0;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #wc-found-list {
            list-style-type: none;
            padding-left: 0;
            text-align: center;
        }
        #wc-found-list li {
            font-size: 1.2em;
            color: var(--success-green);
            font-weight: bold;
            padding: 4px 0;
        }
        .wc-grid-container {
            width: 350px;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #wc-grid {
            display: grid;
            grid-template-columns: repeat(3, 80px); /* 3x3 grid */
            gap: 15px;
            margin-top: 20px;
            touch-action: none; /* Quan tr·ªçng cho touch events */
        }
        .wc-letter {
            width: 80px;
            height: 80px;
            background: var(--light-blue-bg);
            border: 2px solid var(--primary-color);
            border-radius: 50%; /* H√¨nh tr√≤n */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
            cursor: pointer;
            user-select: none; /* NgƒÉn b√¥i ƒëen ch·ªØ */
            transition: background-color 0.2s;
        }
        .wc-letter.selected {
            background: var(--primary-color);
            color: white;
        }
        #wc-current-word {
            height: 50px;
            width: 100%;
            background: #f0f0f0;
            border-radius: 5px;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--dark-text);
            letter-spacing: 2px;
        }
        .wc-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        #wc-level-info {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* M·ªöI: CSS CHO GAME ƒêI·ªÄN V√ÄO CH·ªñ TR·ªêNG (FILL BLANK) */
        .fb-game-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        #fb-progress {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 20px;
        }
        #fb-sentence-container {
            font-size: 1.5em;
            font-weight: 500;
            line-height: 1.8;
            margin-bottom: 25px;
        }
        #fb-input {
            width: 150px;
            font-size: 1.4em;
            text-align: center;
            border: none;
            border-bottom: 2px solid var(--primary-color);
            padding: 5px;
            margin: 0 5px;
        }
        #fb-input:focus {
            outline: none;
            border-bottom-width: 3px;
        }
        #fb-check-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            margin-top: 10px;
        }
        #fb-feedback {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
        }
        #fb-feedback.correct {
            color: var(--success-green);
        }
        #fb-feedback.wrong {
            color: var(--dark-red);
        }
        #fb-results {
            margin-top: 30px;
        }
        #fb-results h2 {
            font-size: 1.8em;
        }
        #fb-results-score {
            font-size: 1.4em;
            margin-bottom: 20px;
        }
        
        /* M·ªöI: CSS B·∫£ng X·∫øp H·∫°ng */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .leaderboard-table th,
        .leaderboard-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }
        .leaderboard-table th {
            background-color: var(--light-blue-bg);
            color: var(--primary-color);
        }
        .leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* Icon cho top 3 */
        .leaderboard-table td:first-child {
            font-weight: bold;
        }
        .leaderboard-table tr:nth-child(1) td:first-child::before {
            content: 'ü•á ';
        }
        .leaderboard-table tr:nth-child(2) td:first-child::before {
            content: 'ü•à ';
        }
        .leaderboard-table tr:nth-child(3) td:first-child::before {
            content: 'ü•â ';
        }
        
    </style>
</head>
<body>

    <!-- PH·∫¶N 1: C√ÅC TH√ÄNH PH·∫¶N CHUNG -->

    <!-- Top Bar -->
    <div class="top-bar">
        <!-- Hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng xu·∫•t -->
        <a id="login-link" href="#" onclick="showPage('login')">ƒêƒÉng nh·∫≠p</a>
        <a id="register-link" href="#" onclick="showPage('register')">ƒêƒÉng k√Ω</a>
        <!-- Hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
        <a id="profile-link" href="#" onclick="showPage('profile')" style="display: none;">H·ªì s∆°</a>
        <a id="logout-link" href="#" onclick="handleLogout(event)" style="display: none;">ƒêƒÉng xu·∫•t</a>
    </div>

    <!-- Header (Logo) -->
    <header class="header">
        <a href="#" onclick="showPage('home')" class="logo">English With Me</a>
    </header>

    <!-- Navbar (Menu ch√≠nh) -->
    <nav class="navbar">
        <a href="#" data-page="home" onclick="showPage('home')">Home</a>
        <a href="#" data-page="cambridge" onclick="showPage('cambridge')">Cambridge</a>
        <a href="#" data-page="globalsuccess" onclick="showPage('globalsuccess')">Global Success</a>
        <a href="#" data-page="tests" onclick="showPage('tests')">T√†i li·ªáu √¥n thi</a>
        <a href="#" data-page="games" onclick="showPage('games')">Game</a>
        <!-- M·ªöI: Th√™m link B·∫£ng x·∫øp h·∫°ng -->
        <a href="#" data-page="leaderboard" onclick="showPage('leaderboard')">B·∫£ng x·∫øp h·∫°ng</a>
    </nav>

    <!-- PH·∫¶N 2: N·ªòI DUNG C√ÅC TRANG (Page) -->
    <main>

        <!-- Trang 1: Home (M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã) -->
        <div id="page-home" class="page active">
            
            <!-- Hero Section -->
            <section class="hero">
                <div class="hero-content">
                    <h2>
                        ENGLISH LEARNING WEBSITE FOR GRADE 5<br>
                        CAMBRIDGE PROGRAM -<br>
                        GLOBAL SUCCESS PROGRAM
                    </h2>
                </div>
            </section>

            <!-- Welcome Section -->
            <section class="welcome">
                <h2>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi English With Me!</h2>
                <p>
                    English With Me l√† n·ªÅn t·∫£ng t·ªïng h·ª£p t·ª´ v·ª±ng v√† ng·ªØ ph√°p t·ª´ ch∆∞∆°ng tr√¨nh
                    Cambridge v√† Global Success d√†nh cho h·ªçc sinh l·ªõp 5, ƒëi k√®m c√°c video b√†i
                    gi·∫£ng sinh ƒë·ªông v√† b√†i luy·ªán t·∫≠p th·ª±c h√†nh, gi√∫p b·∫°n ghi nh·ªõ l√¢u h∆°n v√† h·ªçc
                    hi·ªáu qu·∫£ h∆°n m·ªói ng√†y.
                </p>
            </section>
            
            <!-- M·ªöI: T√çNH NƒÇNG T·ª™ V·ª∞NG M·ªñI NG√ÄY (AI) -->
            <section class="word-of-the-day">
                <h2>T·ª´ v·ª±ng m·ªói ng√†y</h2>
                <div class="word-container">
                    
                    <!-- Tr·∫°ng th√°i Loading -->
                    <div id="word-loading">
                        <div class="loader"></div>
                        <p>AI ƒëang t√¨m t·ª´ v·ª±ng m·ªõi...</p>
                    </div>
                    
                    <!-- N·ªôi dung sau khi t·∫£i -->
                    <div id="word-display" style="display: none;">
                        <div class="word-image-container">
                            <img id="word-image" src="" alt="H√¨nh ·∫£nh minh h·ªça cho t·ª´ v·ª±ng">
                        </div>
                        <div class="word-content">
                            <h3 id="word-term"></h3>
                            <p id="word-definition"></p>
                            <p id="word-example"></p>
                        </div>
                    </div>

                    <!-- Th√¥ng b√°o l·ªói -->
                    <p id="word-error" style="display: none;">Kh√¥ng th·ªÉ t·∫£i t·ª´ v·ª±ng. Vui l√≤ng th·ª≠ l·∫°i.</p>
                </div>
                <button id="new-word-btn" class="btn btn-ai">Nh·∫≠n t·ª´ m·ªõi</button>
            </section>
            <!-- K·∫æT TH√öC T√çNH NƒÇNG AI -->

            <!-- Features Section -->
            <section class="features">
                <div class="feature-grid">
                    <!-- Th·∫ª 1: Link ƒë·∫øn trang Video -->
                    <a href="#" onclick="showPage('videos')" class="feature-card">
                        <h3>Video h∆∞·ªõng d·∫´n</h3>
                        <p>Gi·∫£i th√≠ch tr·ª±c quan t·ª´ng ch·ªß ƒë·ªÅ, minh h·ªça b·∫±ng v√≠ d·ª• th·ª±c t·∫ø.</p>
                    </a>
                    
                    <!-- Th·∫ª 2: Link ƒë·∫øn trang ƒê·ªÅ thi -->
                    <a href="#" onclick="showPage('tests')" class="feature-card">
                        <h3>T·ªïng h·ª£p ƒë·ªÅ √¥n thi</h3>
                        <p>H·ªá th·ªëng ƒë·ªÅ thi ƒë∆∞·ª£c ch·ªçn l·ªçc, gi√∫p b·∫°n luy·ªán t·∫≠p v√† ki·ªÉm tra nƒÉng l·ª±c th·∫≠t s√°t th·ª±c t·∫ø.</p>
                    </a>
                    
                    <!-- Th·∫ª 3: Link ƒë·∫øn trang Game -->
                    <a href="#" onclick="showPage('games')" class="feature-card">
                        <h3>Game √¥n t·∫≠p th√∫ v·ªã</h3>
                        <p>V·ª´a ch∆°i v·ª´a h·ªçc v·ªõi c√°c mini game gi√∫p ghi nh·ªõ t·ª´ v·ª±ng t·ª± nhi√™n v√† l√¢u d√†i.</p>
                    </a>
                </div>
            </section>

        </div> <!-- K·∫øt th√∫c #page-home -->

        <!-- Trang 2: Video H∆∞·ªõng D·∫´n (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-videos" class="page">
            <div class="subpage-container">
                <h1>Video H∆∞·ªõng D·∫´n</h1>
                <div class="video-grid">
                    <!-- Video item 1 -->
                    <!-- C·∫¨P NH·∫¨T: Thay ƒë·ªïi onclick ƒë·ªÉ truy·ªÅn ID YouTube -->
                    <div class="video-item" onclick="openVideoModal('B√†i 1: Th√¨ Hi·ªán t·∫°i ƒë∆°n (Present Simple)', '2rohVIy3v1U')">
                        <img src="https://img.youtube.com/vi/2rohVIy3v1U/hqdefault.jpg" alt="Thumbnail video 1">
                        <div class="video-item-content">
                            <h3>B√†i 1: Th√¨ Hi·ªán t·∫°i ƒë∆°n (Present Simple)</h3>
                            <p>M√¥ t·∫£ ng·∫Øn v·ªÅ n·ªôi dung video, c√°ch s·ª≠ d·ª•ng v√† c√°c v√≠ d·ª• c∆° b·∫£n.</p>
                        </div>
                    </div>
                    <!-- Video item 2 -->
                    <div class="video-item" onclick="openVideoModal('B√†i 2: T·ª´ v·ª±ng ch·ªß ƒë·ªÅ ƒê·ªông v·∫≠t (Animals)', 'aC8v4Cb19hc')">
                        <img src="https://img.youtube.com/vi/aC8v4Cb19hc/hqdefault.jpg" alt="Thumbnail video 2">
                        <div class="video-item-content">
                            <h3>B√†i 2: T·ª´ v·ª±ng ch·ªß ƒë·ªÅ ƒê·ªông v·∫≠t (Animals)</h3>
                            <p>H·ªçc t·ª´ v·ª±ng v·ªÅ c√°c lo√†i ƒë·ªông v·∫≠t hoang d√£ v√† v·∫≠t nu√¥i.</p>
                        </div>
                    </div>
                    <!-- Video item 3 -->
                    <div class="video-item" onclick="openVideoModal('B√†i 3: C·∫•u tr√∫c There is / There are', '4QGP1jsUims')">
                        <img src="https://img.youtube.com/vi/4QGP1jsUims/hqdefault.jpg" alt="Thumbnail video 3">
                        <div class="video-item-content">
                            <h3>B√†i 3: C·∫•u tr√∫c "There is / There are"</h3>
                            <p>C√°ch s·ª≠ d·ª•ng c·∫•u tr√∫c ch·ªâ s·ª± t·ªìn t·∫°i c·ªßa s·ª± v·∫≠t, s·ª± vi·ªác.</p>
                        </div>
                    </div>
                    <!-- Video item 4 -->
                    <div class="video-item" onclick="openVideoModal('B√†i 4: Gi·ªõi t·ª´ ch·ªâ n∆°i ch·ªën (Prepositions)', '-J0MjpK93UE')">
                        <img src="https://img.youtube.com/vi/-J0MjpK93UE/hqdefault.jpg" alt="Thumbnail video 4">
                        <div class="video-item-content">
                            <h3>B√†i 4: Gi·ªõi t·ª´ ch·ªâ n∆°i ch·ªën (Prepositions)</h3>
                            <p>H·ªçc c√°c gi·ªõi t·ª´ ph·ªï bi·∫øn: in, on, at, under, behind...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-videos -->

        <!-- Trang 3: T·ªïng H·ª£p ƒê·ªÅ √în Thi (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-tests" class="page">
            <div class="subpage-container">
                <h1>T·ªïng H·ª£p ƒê·ªÅ √în Thi</h1>
                <div class="test-list">
                    <!-- Test item 1 -->
                    <div class="test-item">
                        <div class="test-info">
                            <h3>ƒê·ªÅ ki·ªÉm tra 15 ph√∫t - Unit 1: My New School</h3>
                            <p>Th·ªùi gian: 15 ph√∫t | S·ªë c√¢u h·ªèi: 10</p>
                        </div>
                        <button class="btn" onclick="startQuiz('unit1')">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                    </div>
                    <!-- Test item 2 -->
                    <div class="test-item">
                        <div class="test-info">
                            <h3>ƒê·ªÅ thi gi·ªØa k·ª≥ 1</h3>
                            <p>Th·ªùi gian: 45 ph√∫t | S·ªë c√¢u h·ªèi: 30</p>
                        </div>
                        <button class="btn" onclick="startQuiz('midterm1')">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                    </div>
                    <!-- Test item 3 -->
                    <div class="test-item">
                        <div class="test-info">
                            <h3>ƒê·ªÅ ki·ªÉm tra t·ª´ v·ª±ng - Unit 1 & 2</h3>
                            <p>Th·ªùi gian: 10 ph√∫t | S·ªë c√¢u h·ªèi: 15</p>
                        </div>
                        <button class="btn" onclick="startQuiz('vocab1-2')">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-tests -->

        <!-- Trang 4: Game √în T·∫≠p (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-games" class="page">
            <div class="subpage-container">
                <h1>Game √în T·∫≠p Th√∫ V·ªã</h1>
                <div class="game-grid">
                    <!-- Game card 1 -->
                    <div class="game-card">
                        <img src="https://placehold.co/150x150/e0f7fa/000?text=Game+Icon+1" alt="Icon game">
                        <h3>L·∫≠t th·∫ª t·ª´ v·ª±ng</h3>
                        <button class="btn" onclick="startGame('flashcard')">Ch∆°i ngay</button>
                    </div>
                    <!-- Game card 2 -->
                    <div class="game-card">
                        <img src="https://placehold.co/150x150/e0f7fa/000?text=Game+Icon+2" alt="Icon game">
                        <h3>N·ªëi t·ª´ (Word Connect)</h3>
                        <!-- C·∫¨P NH·∫¨T: Thay ƒë·ªïi onclick -->
                        <button class="btn" onclick="startGame('wordconnect')">Ch∆°i ngay</button>
                    </div>
                    <!-- Game card 3 -->
                    <div class="game-card">
                        <img src="https://placehold.co/150x150/e0f7fa/000?text=Game+Icon+3" alt="Icon game">
                        <h3>ƒêi·ªÅn v√†o ch·ªó tr·ªëng</h3>
                        <!-- C·∫¨P NH·∫¨T: Thay ƒë·ªïi onclick -->
                        <button class="btn" onclick="startGame('fillblank')">Ch∆°i ngay</button>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-games -->
        
        <!-- Trang 5: L√†m Quiz (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-quiz" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('tests')">&larr; Quay l·∫°i danh s√°ch ƒë·ªÅ</button>
                <h1 id="quiz-title">ƒê·ªÅ ki·ªÉm tra</h1>
                <div id="quiz-content">
                    <div id="quiz-question-container">
                        <p id="quiz-question" class="quiz-question-text"></p>
                    </div>
                    <div id="quiz-options" class="quiz-options-grid">
                        <!-- Options will be generated by JS -->
                    </div>
                    <button id="quiz-next-btn" class="btn" onclick="nextQuestion()">C√¢u ti·∫øp theo</button>
                </div>
                <div id="quiz-result" style="display: none;">
                    <h2>K·∫øt qu·∫£</h2>
                    <p id="quiz-score"></p>
                    <button class="btn" onclick="showPage('tests')">Ho√†n th√†nh</button>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-quiz -->

        <!-- Trang 6: Game L·∫≠t Th·∫ª (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-game-flashcard" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('games')">&larr; Quay l·∫°i danh s√°ch game</button>
                <h1>Game: L·∫≠t th·∫ª t·ª´ v·ª±ng</h1>
                <div class="flashcard-controls">
                    <p>S·ªë l·∫ßn l·∫≠t: <span id="flashcard-flips">0</span></p>
                    <button class="btn" onclick="initFlashcardGame()">Ch∆°i l·∫°i</button>
                </div>
                <div id="flashcard-grid" class="flashcard-grid-container">
                    <!-- Cards will be generated by JS -->
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-game-flashcard -->
        
        <!-- M·ªöI: Trang 6.1: Game N·ªëi T·ª´ (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-game-wordconnect" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('games')">&larr; Quay l·∫°i danh s√°ch game</button>
                <h1>Game: N·ªëi t·ª´</h1>
                <p id="wc-level-info" style="text-align: center;">Level 1</p>
                <div class="wc-game-area">
                    <!-- C·ªôt t·ª´ ƒë√£ t√¨m th·∫•y -->
                    <div id="wc-found-words">
                        <h3>T·ª´ ƒë√£ t√¨m th·∫•y</h3>
                        <ul id="wc-found-list">
                            <!-- JS s·∫Ω ƒëi·ªÅn v√†o ƒë√¢y -->
                        </ul>
                    </div>
                    <!-- C·ªôt l∆∞·ªõi ch·ªØ -->
                    <div class="wc-grid-container">
                        <div id="wc-grid">
                            <!-- JS s·∫Ω t·∫°o l∆∞·ªõi ch·ªØ -->
                        </div>
                        <div id="wc-current-word"></div>
                        <div class="wc-controls">
                            <button id="wc-shuffle-btn" class="btn btn-back">Tr·ªôn ch·ªØ</button>
                            <button id="wc-next-level-btn" class="btn" style="display: none;">Level ti·∫øp theo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-game-wordconnect -->

        <!-- M·ªöI: Trang 6.2: Game ƒêi·ªÅn v√†o ch·ªó tr·ªëng (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-game-fillblank" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('games')">&larr; Quay l·∫°i danh s√°ch game</button>
                <h1>Game: ƒêi·ªÅn v√†o ch·ªó tr·ªëng</h1>
                
                <div id="fb-game-area" class="fb-game-container">
                    <p id="fb-progress">C√¢u 1 / 3</p>
                    <div id="fb-sentence-container">
                        <span id="fb-sentence-start"></span>
                        <input type="text" id="fb-input" autocomplete="off" autocorrect="off">
                        <span id="fb-sentence-end"></span>
                    </div>
                    <button id="fb-check-btn" class="btn">Ki·ªÉm tra</button>
                    <div id="fb-feedback"></div>
                </div>

                <div id="fb-results" class="fb-game-container" style="display: none;">
                    <h2>Ho√†n th√†nh!</h2>
                    <p id="fb-results-score">B·∫°n ƒë√∫ng 0 / 3 c√¢u.</p>
                    <button id="fb-restart-btn" class="btn">Ch∆°i l·∫°i</button>
                </div>

            </div>
        </div> <!-- K·∫øt th√∫c #page-game-fillblank -->


        <!-- Trang 7: ƒêƒÉng nh·∫≠p (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-login" class="page">
            <div class="auth-form-container">
                <form id="login-form">
                    <h1 style="text-align: center;">ƒêƒÉng nh·∫≠p</h1>
                    <div id="login-message" class="auth-message"></div>
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn">ƒêƒÉng nh·∫≠p</button>
                    <div class="auth-switch">
                        Ch∆∞a c√≥ t√†i kho·∫£n? <a onclick="showPage('register')">ƒêƒÉng k√Ω ngay</a>
                    </div>
                </form>
            </div>
        </div> <!-- K·∫øt th√∫c #page-login -->

        <!-- Trang 8: ƒêƒÉng k√Ω (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-register" class="page">
            <div class="auth-form-container">
                <form id="register-form">
                    <h1 style="text-align: center;">ƒêƒÉng k√Ω</h1>
                    <div id="register-message" class="auth-message"></div>
                    <div class="form-group">
                        <label for="reg-email">Email</label>
                        <input type="email" id="reg-email" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-password">M·∫≠t kh·∫©u</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <input type="password" id="reg-confirm-password" required>
                    </div>
                    <button type="submit" class="btn">ƒêƒÉng k√Ω</button>
                    <div class="auth-switch">
                        ƒê√£ c√≥ t√†i kho·∫£n? <a onclick="showPage('login')">ƒêƒÉng nh·∫≠p</a>
                    </div>
                </form>
            </div>
        </div> <!-- K·∫øt th√∫c #page-register -->

        <!-- Trang 9: Cambridge (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-cambridge" class="page">
            <div class="subpage-container">
                <h1>Ch∆∞∆°ng tr√¨nh Cambridge</h1>
                <p style="text-align: center; max-width: 800px; margin: 0 auto 30px;">
                    N·ªôi dung h·ªçc t·∫≠p b√°m s√°t ch∆∞∆°ng tr√¨nh Cambridge Primary. Luy·ªán t·∫≠p t·ª´ v·ª±ng, ng·ªØ ph√°p v√† c√°c k·ªπ nƒÉng nghe, n√≥i, ƒë·ªçc, vi·∫øt theo t·ª´ng Unit.
                </p>
                <div class="content-grid">
                    <!-- Unit Item 1 -->
                    <div class="content-item">
                        <img src="https://i.pinimg.com/736x/9f/73/2c/9f732c0a0cfd337c324c53d8ab917651.jpg" alt="Unit 1">
                        <h3>Unit 1: Our School <span class="completion-icon" id="icon-cambridge-unit1"></span></h3>
                        <p>T·ª´ v·ª±ng v·ªÅ tr∆∞·ªùng h·ªçc, c√°c m√¥n h·ªçc v√† ho·∫°t ƒë·ªông.</p>
                        <button class="btn" onclick="showPage('cambridge-unit1', 'cambridge')">V√†o h·ªçc</button>
                    </div>
                    <!-- Unit Item 2 -->
                    <div class="content-item">
                        <img src="https://placehold.co/250x150/e0f7fa/000?text=Unit+2:+Family" alt="Unit 2">
                        <h3>Unit 2: Family and Friends <span class="completion-icon" id="icon-cambridge-unit2"></span></h3>
                        <p>T·ª´ v·ª±ng v·ªÅ gia ƒë√¨nh, b·∫°n b√® v√† c√°c m·ªëi quan h·ªá.</p>
                        <button class="btn" onclick="showPage('cambridge-unit2', 'cambridge')">V√†o h·ªçc</button>
                    </div>
                    <!-- Unit Item 3 -->
                    <div class="content-item">
                        <img src="https://placehold.co/250x150/e0f7fa/000?text=Unit+3:+The+World" alt="Unit 3">
                        <h3>Unit 3: The World Around Us <span class="completion-icon" id="icon-cambridge-unit3"></span></h3>
                        <p>Kh√°m ph√° th·∫ø gi·ªõi t·ª± nhi√™n, ƒë·ªông v·∫≠t v√† m√¥i tr∆∞·ªùng.</p>
                        <button class="btn" onclick="showPage('cambridge-unit3', 'cambridge')">V√†o h·ªçc</button>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-cambridge -->

        <!-- Trang 10: Global Success (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-globalsuccess" class="page">
            <div class="subpage-container">
                <h1>Ch∆∞∆°ng tr√¨nh Global Success (L·ªõp 5)</h1>
                <p style="text-align: center; max-width: 800px; margin: 0 auto 30px;">
                    T·ªïng h·ª£p t·ª´ v·ª±ng v√† ng·ªØ ph√°p theo S√°ch gi√°o khoa Ti·∫øng Anh 5 - Global Success. Luy·ªán t·∫≠p theo t·ª´ng ƒë∆°n v·ªã b√†i h·ªçc.
                </p>
                <div class="content-grid">
                    <!-- Unit Item 1 -->
                    <div class="content-item">
                        <img src="https://placehold.co/250x150/e0f7fa/000?text=Unit+1:+Address" alt="Unit 1">
                        <h3>Unit 1: What's your address? <span class="completion-icon" id="icon-globalsuccess-unit1"></span></h3>
                        <p>H·ªçc c√°ch h·ªèi v√† tr·∫£ l·ªùi v·ªÅ ƒë·ªãa ch·ªâ.</p>
                        <button class="btn" onclick="showPage('globalsuccess-unit1', 'globalsuccess')">V√†o h·ªçc</button>
                    </div>
                    <!-- Unit Item 2 -->
                    <div class="content-item">
                        <img src="https://placehold.co/250x150/e0f7fa/000?text=Unit+2:+Daily+Routines" alt="Unit 2">
                        <h3>Unit 2: I always get up early <span class="completion-icon" id="icon-globalsuccess-unit2"></span></h3>
                        <p>N√≥i v·ªÅ c√°c th√≥i quen v√† ho·∫°t ƒë·ªông h√†ng ng√†y.</p>
                        <button class="btn" onclick="showPage('globalsuccess-unit2', 'globalsuccess')">V√†o h·ªçc</button>
                    </div>
                    <!-- Unit Item 3 -->
                    <div class="content-item">
                        <img src="https://placehold.co/250x150/e0f7fa/000?text=Unit+3:+Holiday" alt="Unit 3">
                        <h3>Unit 3: Where did you go on holiday? <span class="completion-icon" id="icon-globalsuccess-unit3"></span></h3>
                        <p>H·ªçc c√°ch n√≥i v·ªÅ c√°c k·ª≥ ngh·ªâ (Th√¨ qu√° kh·ª© ƒë∆°n).</p>
                        <button class="btn" onclick="showPage('globalsuccess-unit3', 'globalsuccess')">V√†o h·ªçc</button>
                    </div>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-globalsuccess -->

        <!-- Trang 11: H·ªì s∆° (M·∫∑c ƒë·ªãnh ·∫©n) -->
        <div id="page-profile" class="page">
            <div class="subpage-container">
                <h1>H·ªì s∆° c·ªßa b·∫°n</h1>
                <div class="lesson-section">
                    <h2>Th√¥ng tin t√†i kho·∫£n</h2>
                    <p>Email: <strong id="profile-email">...</strong></p>
                    <p>UserID: <strong id="profile-userid">...</strong></p>
                </div>
                
                <!-- HI·ªÇN TH·ªä K·∫æT QU·∫¢ QUIZ -->
                <div class="lesson-section">
                    <h2>Ti·∫øn ƒë·ªô h·ªçc t·∫≠p (B√†i ki·ªÉm tra)</h2>
                    <div id="profile-quiz-results">
                        <p>Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c l∆∞u.</p>
                    </div>
                </div>
                
                <!-- M·ªöI: HI·ªÇN TH·ªä TI·∫æN ƒê·ªò B√ÄI H·ªåC -->
                <div class="lesson-section">
                    <h2>Ti·∫øn ƒë·ªô b√†i h·ªçc (ƒê√£ ho√†n th√†nh)</h2>
                    <div id="profile-lesson-progress">
                        <p>Ch∆∞a ho√†n th√†nh b√†i h·ªçc n√†o.</p>
                    </div>
                </div>
                <!-- K·∫æT TH√öC T√çNH NƒÇNG M·ªöI -->

                <button class="btn btn-back" id="profile-logout-btn" onclick="handleLogout(event)">ƒêƒÉng xu·∫•t</button>
            </div>
        </div> <!-- K·∫øt th√∫c #page-profile -->
        
        <!-- M·ªöI: Trang 12: B·∫£ng X·∫øp H·∫°ng -->
        <div id="page-leaderboard" class="page">
            <div class="subpage-container">
                <h1>B·∫£ng X·∫øp H·∫°ng</h1>
                <p style="text-align: center; max-width: 800px; margin: 0 auto 30px;">
                    Th√†nh t√≠ch c·ªßa c√°c h·ªçc sinh c√≥ ƒëi·ªÉm cao nh·∫•t. ƒêi·ªÉm ƒë∆∞·ª£c t√≠nh t·ª´ c√°c b√†i ki·ªÉm tra (Quiz) v√† game (ƒêi·ªÅn v√†o ch·ªó tr·ªëng).
                </p>
                <div id="leaderboard-table-container">
                    <!-- B·∫£ng x·∫øp h·∫°ng s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JS -->
                    <p id="leaderboard-loading">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>
                </div>
            </div>
        </div> <!-- K·∫øt th√∫c #page-leaderboard -->

        <!-- TRANG B√ÄI H·ªåC (C·∫¨P NH·∫¨T V·ªöI T√çNH NƒÇNG M·ªöI) -->

        <!-- Cambridge Unit 1 -->
        <div id="page-cambridge-unit1" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('cambridge', 'cambridge')">&larr; Quay l·∫°i Cambridge</button>
                <h1>Cambridge - Unit 1: Our School</h1>
                
                <!-- N·ªôi dung b√†i h·ªçc -->
                <div class="lesson-section">
                    <h2>1. T·ª´ v·ª±ng (Vocabulary)</h2>
                    <ul>
                        <li>Classroom (n): L·ªõp h·ªçc</li>
                        <li>Library (n): Th∆∞ vi·ªán</li>
                        <li>Gym (n): Ph√≤ng t·∫≠p th·ªÉ d·ª•c</li>
                        <li>Playground (n): S√¢n ch∆°i</li>
                    </ul>
                </div>
                <div class="lesson-section">
                    <h2>2. Ng·ªØ ph√°p (Grammar)</h2>
                    <p><strong>C·∫•u tr√∫c: What subject do you have today?</strong></p>
                    <p>Tr·∫£ l·ªùi: I have + (t√™n m√¥n h·ªçc).</p>
                    <p>V√≠ d·ª•: I have Maths, Vietnamese, and English.</p>
                </div>
                
                <!-- M·ªöI: N√∫t ho√†n th√†nh -->
                <button class="btn btn-complete" onclick="markLessonComplete('cambridge-unit1')">Ho√†n th√†nh b√†i h·ªçc</button>

                <!-- M·ªöI: Khu v·ª±c b√¨nh lu·∫≠n -->
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-cambridge-unit1" class="comment-list">
                        <!-- Comments load here -->
                    </div>
                    <form id="comment-form-cambridge-unit1" class="comment-form" onsubmit="event.preventDefault(); postComment('cambridge-unit1');">
                        <textarea id="comment-input-cambridge-unit1" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
                
            </div>
        </div>
        <!-- Cambridge Unit 2 -->
        <div id="page-cambridge-unit2" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('cambridge', 'cambridge')">&larr; Quay l·∫°i Cambridge</button>
                <h1>Cambridge - Unit 2: Family and Friends</h1>
                <div class="lesson-section"><h2>N·ªôi dung Unit 2...</h2></div>
                
                <!-- M·ªöI: N√∫t ho√†n th√†nh -->
                <button class="btn btn-complete" onclick="markLessonComplete('cambridge-unit2')">Ho√†n th√†nh b√†i h·ªçc</button>

                <!-- M·ªöI: Khu v·ª±c b√¨nh lu·∫≠n -->
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-cambridge-unit2" class="comment-list"></div>
                    <form id="comment-form-cambridge-unit2" class="comment-form" onsubmit="event.preventDefault(); postComment('cambridge-unit2');">
                        <textarea id="comment-input-cambridge-unit2" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Cambridge Unit 3 -->
        <div id="page-cambridge-unit3" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('cambridge', 'cambridge')">&larr; Quay l·∫°i Cambridge</button>
                <h1>Cambridge - Unit 3: The World Around Us</h1>
                <div class="lesson-section"><h2>N·ªôi dung Unit 3...</h2></div>
                
                <button class="btn btn-complete" onclick="markLessonComplete('cambridge-unit3')">Ho√†n th√†nh b√†i h·ªçc</button>
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-cambridge-unit3" class="comment-list"></div>
                    <form id="comment-form-cambridge-unit3" class="comment-form" onsubmit="event.preventDefault(); postComment('cambridge-unit3');">
                        <textarea id="comment-input-cambridge-unit3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Global Success Unit 1 -->
        <div id="page-globalsuccess-unit1" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('globalsuccess', 'globalsuccess')">&larr; Quay l·∫°i Global Success</button>
                <h1>Global Success - Unit 1: What's your address?</h1>
                <div class="lesson-section">
                    <h2>1. T·ª´ v·ª±ng (Vocabulary)</h2>
                    <ul>
                        <li>Address (n): ƒê·ªãa ch·ªâ</li>
                        <li>Street (n): ƒê∆∞·ªùng ph·ªë</li>
                        <li>Village (n): L√†ng, x√£</li>
                        <li>City (n): Th√†nh ph·ªë</li>
                    </ul>
                </div>
                <div class="lesson-section">
                    <h2>2. Ng·ªØ ph√°p (Grammar)</h2>
                    <p><strong>C·∫•u tr√∫c: What's your address?</strong></p>
                    <p>Tr·∫£ l·ªùi: It's + (s·ªë nh√†) + (t√™n ƒë∆∞·ªùng).</p>
                    <p>V√≠ d·ª•: It's 123 Tran Hung Dao Street.</p>
                </div>
                
                <button class="btn btn-complete" onclick="markLessonComplete('globalsuccess-unit1')">Ho√†n th√†nh b√†i h·ªçc</button>
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-globalsuccess-unit1" class="comment-list"></div>
                    <form id="comment-form-globalsuccess-unit1" class="comment-form" onsubmit="event.preventDefault(); postComment('globalsuccess-unit1');">
                        <textarea id="comment-input-globalsuccess-unit1" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Global Success Unit 2 -->
        <div id="page-globalsuccess-unit2" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('globalsuccess', 'globalsuccess')">&larr; Quay l·∫°i Global Success</button>
                <h1>Global Success - Unit 2: I always get up early</h1>
                <div class="lesson-section"><h2>N·ªôi dung Unit 2...</h2></div>
                
                <button class="btn btn-complete" onclick="markLessonComplete('globalsuccess-unit2')">Ho√†n th√†nh b√†i h·ªçc</button>
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-globalsuccess-unit2" class="comment-list"></div>
                    <form id="comment-form-globalsuccess-unit2" class="comment-form" onsubmit="event.preventDefault(); postComment('globalsuccess-unit2');">
                        <textarea id="comment-input-globalsuccess-unit2" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Global Success Unit 3 -->
        <div id="page-globalsuccess-unit3" class="page">
            <div class="subpage-container">
                <button class="btn btn-back" onclick="showPage('globalsuccess', 'globalsuccess')">&larr; Quay l·∫°i Global Success</button>
                <h1>Global Success - Unit 3: Where did you go on holiday?</h1>
                <div class="lesson-section"><h2>N·ªôi dung Unit 3...</h2></div>
                
                <button class="btn btn-complete" onclick="markLessonComplete('globalsuccess-unit3')">Ho√†n th√†nh b√†i h·ªçc</button>
                <div class="lesson-section comment-section">
                    <h2>B√¨nh lu·∫≠n</h2>
                    <div id="comment-list-globalsuccess-unit3" class="comment-list"></div>
                    <form id="comment-form-globalsuccess-unit3" class="comment-form" onsubmit="event.preventDefault(); postComment('globalsuccess-unit3');">
                        <textarea id="comment-input-globalsuccess-unit3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <button type="submit" class="btn">G·ª≠i</button>
                    </form>
                </div>
            </div>
        </div>


    </main>

    <!-- PH·∫¶N 3: FOOTER CHUNG -->
    <footer class="footer">
        <p>¬© 2025 English With Me. All rights reserved.</p>
    </footer>

    <!-- Video Modal Structure -->
    <div id="video-modal" class="modal-overlay" style="display: none;" onclick="closeVideoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeVideoModal()">&times;</span>
            <h3 id="modal-video-title">Video Title</h3>
            <div class="video-player-container">
                <!-- C·∫¨P NH·∫¨T: Thay th·∫ø <img> b·∫±ng <iframe> -->
                <iframe id="modal-video-iframe" width="560" height="315" src="" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
            </div>
            <!-- M·ªöI: Th√™m n·ªôi dung cho Custom Alert -->
            <div id="modal-alert-content" style="display: none; text-align: center; padding: 30px 0;">
                <p id="modal-alert-text" style="font-size: 1.2em;"></p>
                <button class="btn" onclick="closeVideoModal()" style="margin-top: 20px;">ƒê√£ hi·ªÉu</button>
            </div>
        </div>
    </div>

    <!-- PH·∫¶N 4: JAVASCRIPT ƒêI·ªÄU H∆Ø·ªöNG & T√çNH NƒÇNG -->
    <script type="module">
        // --- 0. IMPORT FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel,
            // C·∫¨P NH·∫¨T: Th√™m c√°c h√†m Firestore
            doc,
            setDoc,
            getDoc, // M·ªöI: ƒê·ªÉ ki·ªÉm tra ti·∫øn ƒë·ªô
            collection,
            getDocs,
            addDoc, // M·ªöI: Cho b√¨nh lu·∫≠n
            query, // M·ªöI: Cho b√¨nh lu·∫≠n
            where, // M·ªöI: Cho b√¨nh lu·∫≠n
            onSnapshot, // M·ªöI: Cho b√¨nh lu·∫≠n real-time
            // M·ªöI: Th√™m increment cho b·∫£ng x·∫øp h·∫°ng
            increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C CHO APP ---
        
        // Bi·∫øn Firebase
        let app, auth, db;
        let currentUser = null;

        // --- !!! QUAN TR·ªåNG KHI TRI·ªÇN KHAI L√äN GITHUB PAGES !!! ---
        // B·∫°n c·∫ßn thay th·∫ø c√°c gi√° tr·ªã d∆∞·ªõi ƒë√¢y b·∫±ng th√¥ng tin t·ª´ d·ª± √°n Firebase c·ªßa b·∫°n.
        
        // 1. (T√πy ch·ªçn) ƒê·∫∑t m·ªôt ID cho ·ª©ng d·ª•ng c·ªßa b·∫°n, v√≠ d·ª•: 'my-english-app'
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-english-app-github';

        // 2. (B·∫ÆT BU·ªòC) D√°n ƒë·ªëi t∆∞·ª£ng c·∫•u h√¨nh Firebase c·ªßa b·∫°n v√†o ƒë√¢y.
        // L·∫•y n√≥ t·ª´ C√†i ƒë·∫∑t d·ª± √°n (Project Settings) > ·ª®ng d·ª•ng c·ªßa b·∫°n (Your apps) > Web app.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
               apiKey: "AIzaSyBPAQ8jldVTwtB_uAzz0-oGcZiUaJ3NeyU",
  authDomain: "ewmp-abc18.firebaseapp.com",
  projectId: "ewmp-abc18",
  storageBucket: "ewmp-abc18.firebasestorage.app",
  messagingSenderId: "416084778745",
  appId: "1:416084778745:web:edb8de27952c3007e24c28",
  measurementId: "G-GVP2MCQNLJ"
            };

        // 3. (Kh√¥ng c·∫ßn thay ƒë·ªïi) Bi·∫øn token n√†y s·∫Ω l√† null tr√™n GitHub Pages,
        // ·ª©ng d·ª•ng s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng ƒëƒÉng nh·∫≠p ·∫©n danh (signInAnonymously).
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Th√™m ki·ªÉm tra n·∫øu firebaseConfig v·∫´n c√≤n tr·ªëng
        if (!firebaseConfig.apiKey) {
            console.error("L·ªñI: firebaseConfig ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p!");
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng cu·ªëi
            document.body.innerHTML = `<div style="padding: 40px; text-align: center; font-family: sans-serif; font-size: 1.2em; color: red;">
                <h1>L·ªói C·∫•u H√¨nh</h1>
                <p>Trang web ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh Firebase. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.</p>
                <p>(N·∫øu b·∫°n l√† qu·∫£n tr·ªã vi√™n, vui l√≤ng d√°n 'firebaseConfig' v√†o t·ªáp HTML.)</p>
            </div>`;
            // NgƒÉn kh√¥ng cho code ti·∫øp t·ª•c ch·∫°y
            throw new Error("Firebase config is missing.");
        }
        
        // --- K·∫øt th√∫c ph·∫ßn c·∫•u h√¨nh cho GitHub Pages ---


        // Bi·∫øn tr·∫°ng th√°i App
        let currentPage = 'home';
        // M·ªöI: Bi·∫øn l∆∞u c√°c h√†m unsub c·ªßa listener b√¨nh lu·∫≠n
        let lessonUnsubscribers = {};
        
        // Bi·∫øn Video Modal & Alert
        let videoModal, modalVideoTitle, modalVideoIframe;
        // M·ªöI: Th√™m bi·∫øn cho alert modal
        let modalAlertContent, modalAlertText;
        
        // Bi·∫øn Quiz
        let currentQuiz = {};
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswerIndex = null;
        let quizTitleEl, quizQuestionEl, quizOptionsEl, quizNextBtn, quizContentEl, quizResultEl, quizScoreEl;

        // Bi·∫øn Game Flashcard
        let flashcardGrid, flipsEl;
        const cardData = [
            { text: 'Apple', id: 'apple' }, { text: 'Qu·∫£ t√°o', id: 'apple' },
            { text: 'Book', id: 'book' }, { text: 'Quy·ªÉn s√°ch', id: 'book' },
            { text: 'Cat', id: 'cat' }, { text: 'Con m√®o', id: 'cat' },
            { text: 'Sun', id: 'sun' }, { text: 'M·∫∑t tr·ªùi', id: 'sun' }
        ];
        let flippedCards = [];
        let lockBoard = false;
        let flipCount = 0;
        let matchedPairs = 0;
        
        // M·ªöI: Bi·∫øn Game Word Connect
        let wcGridEl, wcFoundWordsEl, wcCurrentWordEl, wcShuffleBtn, wcNextLevelBtn, wcLevelInfoEl, wcFoundListEl;
        let wcCurrentLevel = 0;
        let wcIsDrawing = false;
        let wcCurrentPath = []; // M·∫£ng c√°c {el, letter, index}
        let wcFoundInLevel = [];
        let wcGridLetters = []; // M·∫£ng 1D c·ªßa c√°c ch·ªØ c√°i tr√™n l∆∞·ªõi
        const wcGameData = [
            {
                grid: ['C', 'A', 'T', 'O', 'G', 'D', 'N', 'P', 'E'], // 3x3
                words: ['CAT', 'DOG', 'PEN', 'GET', 'TEN', 'GOT', 'DOT', 'ON', 'AT', 'TO', 'GO', 'DO', 'NO', 'EAT', 'TEA', 'PET', 'APE', 'AGE', 'ONE', 'TOP', 'POT', 'COP', 'COG']
            },
            {
                grid: ['B', 'E', 'D', 'R', 'O', 'M', 'O', 'A', 'K'], // 3x3
                words: ['BED', 'ROOM', 'BEDROOM', 'BOOK', 'ROBE', 'MORE', 'DOOR', 'DREAM', 'ODE', 'BAD', 'BEAM', 'BROOM', 'BORE', 'MODE']
            }
        ];

        // M·ªöI: Bi·∫øn Game Fill Blank
        let fbSentenceStartEl, fbSentenceEndEl, fbInputEl, fbCheckBtn, fbFeedbackEl, fbProgressEl, fbGameAreaEl, fbResultsEl, fbRestartBtn, fbResultsScoreEl;
        let fbCurrentQuestion = 0;
        let fbScore = 0;
        const fbGameData = [
            { start: 'She', end: 'breakfast at 7 AM.', answer: 'has' },
            { start: 'My new school is', end: 'a quiet street.', answer: 'on' },
            { start: 'What', end: 'your name?', answer: 'is' },
            { start: 'There', end: 'a book on the table.', answer: 'is' },
            { start: 'There', end: 'two cats under the chair.', answer: 'are' }
        ];
        
        // Bi·∫øn Element (Auth & Profile)
        let loginLink, registerLink, profileLink, logoutLink;
        let profileEmailEl, profileUserIdEl, profileLogoutBtn;
        let profileQuizResultsEl;
        // M·ªöI: Bi·∫øn cho ti·∫øn ƒë·ªô b√†i h·ªçc tr√™n profile
        let profileLessonProgressEl;

        // M·ªöI: Bi·∫øn cho t√≠nh nƒÉng AI
        let wordLoadingEl, wordDisplayEl, wordImageEl, wordTermEl, wordDefinitionEl, wordExampleEl, wordErrorEl, newWordBtn;
        const apiKey = ""; // S·∫Ω ƒë∆∞·ª£c cung c·∫•p l√∫c ch·∫°y
        let isFetchingWord = false; // NgƒÉn ch·∫∑n vi·ªác nh·∫•n n√∫t nhi·ªÅu l·∫ßn
        
        // M·ªöI: Bi·∫øn cho B·∫£ng x·∫øp h·∫°ng
        let leaderboardContainerEl, leaderboardLoadingEl;


        // --- 1. H·ªÜ TH·ªêNG CHUY·ªÇN TRANG (Global) ---
        window.showPage = (pageId, activeNavId = null) => {
            // 1. ·∫®n t·∫•t c·∫£ c√°c .page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 2. Hi·ªÉn th·ªã trang m·ª•c ti√™u
            const targetPage = document.getElementById('page-' + pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
            }

            // 3. C·∫≠p nh·∫≠t tr·∫°ng th√°i 'active' tr√™n navbar
            document.querySelectorAll('.navbar a').forEach(link => {
                link.classList.remove('active-nav');
                const linkPage = link.getAttribute('data-page');
                if (linkPage === pageId || (activeNavId && linkPage === activeNavId)) {
                    link.classList.add('active-nav');
                }
            });

            // 4. (M·ªöI) D·ªçn d·∫πp listeners b√¨nh lu·∫≠n c≈©
            // H·ªßy ƒëƒÉng k√Ω t·∫•t c·∫£ c√°c listeners b√¨nh lu·∫≠n c≈© ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ
            Object.values(lessonUnsubscribers).forEach(unsub => unsub());
            lessonUnsubscribers = {};

            // 5. (M·ªöI) T·∫£i d·ªØ li·ªáu ƒë·ªông cho c√°c trang b√†i h·ªçc
            if (pageId.startsWith('cambridge-unit') || pageId.startsWith('globalsuccess-unit')) {
                const lessonId = pageId;
                checkLessonCompletion(lessonId); // C·∫≠p nh·∫≠t n√∫t "Ho√†n th√†nh"
                loadComments(lessonId); // T·∫£i v√† l·∫Øng nghe b√¨nh lu·∫≠n
            }

            // 6. (M·ªöI) T·∫£i d·ªØ li·ªáu ƒë·ªông cho c√°c trang t·ªïng quan (course pages)
            if (pageId === 'cambridge' || pageId === 'globalsuccess') {
                loadAllLessonCompletions(pageId);
            }
            
            // 7. (C·∫¨P NH·∫¨T) T·∫£i d·ªØ li·ªáu khi v√†o trang h·ªì s∆°
            if (pageId === 'profile') {
                loadProfileData(); // T·∫£i email, uid, k·∫øt qu·∫£ quiz V√Ä TI·∫æN ƒê·ªò B√ÄI H·ªåC
            }
            
            // 8. (M·ªöI) T·∫£i d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng
            if (pageId === 'leaderboard') {
                loadLeaderboard();
            }

            // 9. Cu·ªôn l√™n ƒë·∫ßu trang
            window.scrollTo(0, 0);
        }

        // --- 2. T√çNH NƒÇNG VIDEO MODAL & CUSTOM ALERT (Global) ---
        
        // M·ªöI: H√†m alert t√πy ch·ªânh, t√°i s·ª≠ d·ª•ng modal
        window.showCustomAlert = (message) => {
            modalVideoTitle.textContent = 'Th√¥ng b√°o';
            modalVideoIframe.style.display = 'none'; // ·∫®n video
            modalAlertContent.style.display = 'block'; // Hi·ªán n·ªôi dung alert
            modalAlertText.textContent = message;
            videoModal.style.display = 'flex';
        }
        
        window.openVideoModal = (title, youtubeId) => {
            modalVideoTitle.textContent = title;
            modalVideoIframe.style.display = 'block'; // Hi·ªán video
            modalAlertContent.style.display = 'none'; // ·∫®n n·ªôi dung alert
            
            // Th√™m ?autoplay=1 ƒë·ªÉ video t·ª± ƒë·ªông ch·∫°y
            modalVideoIframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
            videoModal.style.display = 'flex';
        }

        window.closeVideoModal = () => {
            // ƒê·∫∑t src v·ªÅ r·ªóng ƒë·ªÉ D·ª™NG video ph√°t trong n·ªÅn
            modalVideoIframe.src = '';
            videoModal.style.display = 'none';
        }

        // --- 3. T√çNH NƒÇNG AUTH (N·ªôi b·ªô, ƒë∆∞·ª£c g·ªçi b·ªüi Event Listeners) ---
        
        async function handleLogin(event) {
            event.preventDefault();
            const messageEl = document.getElementById('login-message');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            messageEl.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
                messageEl.textContent = 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn v·ªÅ trang ch·ªß...';
                messageEl.className = 'auth-message success';
                messageEl.style.display = 'block';

                setTimeout(() => {
                    window.showPage('home');
                    messageEl.style.display = 'none';
                    event.target.reset(); 
                }, 1500);

            } catch (error) {
                let errorMsg = 'L·ªói ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    errorMsg = 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Email kh√¥ng h·ª£p l·ªá.';
                }
                
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                messageEl.style.display = 'block';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const messageEl = document.getElementById('register-message');
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPass = document.getElementById('reg-confirm-password').value;

            messageEl.style.display = 'none';

            if (password !== confirmPass) {
                messageEl.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
                messageEl.className = 'auth-message error';
                messageEl.style.display = 'block';
                return;
            }
            
            try {
                // ƒêƒÉng k√Ω user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // (T√πy ch·ªçn) L∆∞u th√¥ng tin user (v√≠ d·ª•: email) v√†o 1 doc ri√™ng
                // const userDocRef = doc(db, "users", userCredential.user.uid);
                // await setDoc(userDocRef, { email: email, createdAt: new Date() });

                messageEl.textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang chuy·ªÉn v·ªÅ trang ch·ªß...';
                messageEl.className = 'auth-message success';
                messageEl.style.display = 'block';

                setTimeout(() => {
                    window.showPage('home');
                    messageEl.style.display = 'none';
                    event.target.reset();
                }, 1500);

            } catch (error)
{
                let errorMsg = 'L·ªói ƒëƒÉng k√Ω. Vui l√≤ng th·ª≠ l·∫°i.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Email kh√¥ng h·ª£p l·ªá.';
                }
                
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                messageEl.style.display = 'block';
            }
        }
        
        window.handleLogout = async (event) => {
            if (event) event.preventDefault(); // Cho ph√©p g·ªçi t·ª´ profileLogoutBtn
            try {
                await signOut(auth);
                window.showPage('home');
            } catch (error) {
                console.error("L·ªói ƒëƒÉng xu·∫•t: ", error);
            }
        }

        // --- 4. T√çNH NƒÇNG QUIZ (Global) ---
        
        const quizzes = {
            'unit1': {
                title: 'ƒê·ªÅ ki·ªÉm tra 15 ph√∫t - Unit 1',
                questions: [
                    { q: 'We ___ new students.', options: ['are', 'is', 'am', 'be'], answer: 0 },
                    { q: 'She ___ breakfast at 7 AM.', options: ['have', 'has', 'is', 'are'], answer: 1 },
                    { q: 'My new school is ___ a quiet street.', options: ['in', 'at', 'on', 'with'], answer: 2 }
                ]
            },
            'midterm1': {
                title: 'ƒê·ªÅ thi gi·ªØa k·ª≥ 1',
                questions: [
                    { q: 'What ___ your name?', options: ['are', 'is', 'am', 'be'], answer: 1 },
                    { q: 'How old ___ you?', options: ['is', 'are', 'am', 'be'], answer: 1 }
                ]
            },
            'vocab1-2': {
                title: 'ƒê·ªÅ ki·ªÉm tra t·ª´ v·ª±ng - Unit 1 & 2',
                questions: [
                    { q: 'T·ª´ n√†o c√≥ nghƒ©a l√† "th∆∞ vi·ªán"?', options: ['Classroom', 'Library', 'Gym', 'Garden'], answer: 1 },
                    { q: 'T·ª´ n√†o c√≥ nghƒ©a l√† "b√∫t ch√¨"?', options: ['Pen', 'Book', 'Pencil', 'Ruler'], answer: 2 }
                ]
            }
        };

        window.startQuiz = (quizId) => {
            if (!quizzes[quizId]) return;
            
            currentQuiz = quizzes[quizId];
            currentQuiz.id = quizId; 
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswerIndex = null;
            
            quizContentEl.style.display = 'block';
            quizResultEl.style.display = 'none';
            quizNextBtn.textContent = 'C√¢u ti·∫øp theo';
            
            window.showPage('quiz', 'tests');
            
            quizTitleEl.textContent = currentQuiz.title;
            renderQuestion();
        }

        function renderQuestion() {
            selectedAnswerIndex = null;
            const question = currentQuiz.questions[currentQuestionIndex];
            quizQuestionEl.textContent = question.q;
            quizOptionsEl.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.textContent = option;
                optionEl.classList.add('quiz-option');
                optionEl.onclick = () => selectAnswer(optionEl, index);
                quizOptionsEl.appendChild(optionEl);
            });
            
            quizNextBtn.disabled = true;
        }

        function selectAnswer(optionEl, index) {
            document.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
            optionEl.classList.add('selected');
            selectedAnswerIndex = index;
            quizNextBtn.disabled = false;
        }

        window.nextQuestion = () => {
            // Ki·ªÉm tra c√¢u tr·∫£ l·ªùi
            const question = currentQuiz.questions[currentQuestionIndex];
            const correct = (selectedAnswerIndex === question.answer);
            if (correct) {
                score++;
            }
            
            // Chuy·ªÉn c√¢u h·ªèi ti·∫øp theo
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuiz.questions.length) {
                renderQuestion();
                if (currentQuestionIndex === currentQuiz.questions.length - 1) {
                    quizNextBtn.textContent = 'Ho√†n th√†nh';
                }
            } else {
                showResults();
            }
        }

        function showResults() {
            quizContentEl.style.display = 'none';
            quizResultEl.style.display = 'block';
            const resultText = `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${score} / ${currentQuiz.questions.length} c√¢u!`;
            quizScoreEl.textContent = resultText;
            
            // G·ªçi h√†m l∆∞u k·∫øt qu·∫£ v√†o Firestore (private)
            saveQuizResult(currentQuiz.id, score, currentQuiz.questions.length, currentQuiz.title);
            
            // M·ªöI: C·∫≠p nh·∫≠t ƒëi·ªÉm l√™n b·∫£ng x·∫øp h·∫°ng (public)
            // Ch·ªâ c·ªông ƒëi·ªÉm n·∫øu user l√†m ƒë√∫ng > 0 c√¢u
            if (score > 0) {
                updateUserScore(score); 
            }
        }

        // H√†m l∆∞u k·∫øt qu·∫£ quiz v√†o Firestore (Private - cho trang Profile)
        async function saveQuizResult(quizId, score, total, title) {
            if (!currentUser) {
                console.log("Kh√¥ng th·ªÉ l∆∞u k·∫øt qu·∫£ (ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p).");
                return;
            }
            
            try {
                // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n private: /artifacts/{appId}/users/{userId}/quizResults/{quizId}
                // D√πng quizId l√†m ID c·ªßa doc ƒë·ªÉ d·ªÖ d√†ng ghi ƒë√®
                const docRef = doc(db, "artifacts", appId, "users", currentUser.uid, "quizResults", quizId);
                const data = {
                    quizId: quizId,
                    title: title,
                    score: score,
                    total: total,
                    timestamp: new Date() // L∆∞u l·∫°i th·ªùi gian l√†m b√†i
                };
                await setDoc(docRef, data); 
                console.log("ƒê√£ l∆∞u k·∫øt qu·∫£ quiz (private):", quizId);
            } catch (error) {
                console.error("L·ªói khi l∆∞u k·∫øt qu·∫£ quiz (private):", error);
            }
        }

        // (C·∫¨P NH·∫¨T) H√†m t·∫£i d·ªØ li·ªáu cho trang h·ªì s∆° (bao g·ªìm c·∫£ ti·∫øn ƒë·ªô b√†i h·ªçc)
        async function loadProfileData() {
            // 1. C·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n
            if (currentUser) {
                profileEmailEl.textContent = currentUser.email || 'Kh√¥ng c√≥ (T√†i kho·∫£n ·∫©n danh)';
                profileUserIdEl.textContent = currentUser.uid;
            }

            // 2. T·∫£i k·∫øt qu·∫£ quiz
            profileQuizResultsEl.innerHTML = '<p>ƒêang t·∫£i k·∫øt qu·∫£...</p>';

            if (!currentUser) {
                profileQuizResultsEl.innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ti·∫øn ƒë·ªô.</p>';
                profileLessonProgressEl.innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ti·∫øn ƒë·ªô.</p>';
                return;
            }

            // T·∫£i Quiz
            try {
                const collRef = collection(db, "artifacts", appId, "users", currentUser.uid, "quizResults");
                const querySnapshot = await getDocs(collRef);

                if (querySnapshot.empty) {
                    profileQuizResultsEl.innerHTML = '<p>Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                } else {
                    let html = '<ul style="list-style-type: none; padding-left: 0;">';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const timestamp = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000) : new Date();
                        
                        html += `<li style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${data.title || data.quizId}</strong>: ${data.score} / ${data.total}
                            <br>
                            <small style="color: #777;">L√†m ng√†y: ${timestamp.toLocaleString('vi-VN')}</small>
                        </li>`;
                    });
                    html += '</ul>';
                    profileQuizResultsEl.innerHTML = html;
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i k·∫øt qu·∫£ quiz:", error);
                profileQuizResultsEl.innerHTML = '<p style="color: red;">L·ªói khi t·∫£i k·∫øt qu·∫£ quiz.</p>';
            }
            
            // 3. (M·ªöI) T·∫£i ti·∫øn ƒë·ªô b√†i h·ªçc
            await loadProfileLessonProgress();
        }
        
        // (M·ªöI) H√†m t·∫£i ti·∫øn ƒë·ªô b√†i h·ªçc cho trang profile
        async function loadProfileLessonProgress() {
            const el = profileLessonProgressEl;
            el.innerHTML = '<p>ƒêang t·∫£i ti·∫øn ƒë·ªô...</p>';
            if (!currentUser) {
                el.innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ti·∫øn ƒë·ªô.</p>';
                return;
            }

            const collRef = collection(db, "artifacts", appId, "users", currentUser.uid, "lessonProgress");
            const q = query(collRef, where("completed", "==", true));
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    el.innerHTML = '<p>Ch∆∞a ho√†n th√†nh b√†i h·ªçc n√†o.</p>';
                    return;
                }

                let html = '<ul style="list-style-type: none; padding-left: 0;">';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const lessonId = doc.id; // L·∫•y ID c·ªßa doc (vd: 'cambridge-unit1')
                    const timestamp = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000) : new Date();
                    html += `<li style="padding: 10px; border-bottom: 1px solid #eee;">
                        <strong>${lessonId}</strong>
                        <br>
                        <small style="color: #777;">Ho√†n th√†nh: ${timestamp.toLocaleString('vi-VN')}</small>
                    </li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
            } catch (error) {
                console.error("L·ªói khi t·∫£i ti·∫øn ƒë·ªô h·ªì s∆°: ", error);
                el.innerHTML = '<p style="color: red;">L·ªói khi t·∫£i ti·∫øn ƒë·ªô b√†i h·ªçc.</p>';
            }
        }
        
        // --- 5. T√çNH NƒÇNG GAME (Chung) ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // C·∫¨P NH·∫¨T: H√†m startGame chung
        window.startGame = (gameId) => {
            if (gameId === 'flashcard') {
                window.showPage('game-flashcard', 'games');
                initFlashcardGame();
            }
            // M·ªöI: Th√™m 2 game m·ªõi
            if (gameId === 'wordconnect') {
                window.showPage('game-wordconnect', 'games');
                initWordConnectGame();
            }
            if (gameId === 'fillblank') {
                window.showPage('game-fillblank', 'games');
                initFillBlankGame();
            }
        }

        // --- 5.1 T√çNH NƒÇNG GAME FLASHCARD (Global) ---
        
        window.initFlashcardGame = () => {
            flashcardGrid.innerHTML = '';
            flippedCards = [];
            lockBoard = false;
            flipCount = 0;
            matchedPairs = 0;
            flipsEl.textContent = '0';
            
            let gameCards = [...cardData]; // T·∫°o b·∫£n sao ƒë·ªÉ shuffle
            shuffleArray(gameCards);
            
            gameCards.forEach(item => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('flashcard');
                cardElement.dataset.id = item.id;
                
                cardElement.innerHTML = `
                    <div class="flashcard-inner">
                        <div class="flashcard-front">?</div>
                        <div class="flashcard-back">${item.text}</div>
                    </div>
                `;
                
                cardElement.addEventListener('click', () => flipCard(cardElement));
                flashcardGrid.appendChild(cardElement);
            });
        }

        function flipCard(cardElement) {
            if (lockBoard || cardElement.classList.contains('flipped') || flippedCards.length === 2) return;

            cardElement.classList.add('flipped');
            flippedCards.push(cardElement);
            
            flipCount++;
            flipsEl.textContent = flipCount;

            if (flippedCards.length === 2) {
                lockBoard = true;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.dataset.id === card2.dataset.id;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            flippedCards[0].classList.add('matched');
            flippedCards[1].classList.add('matched');
            matchedPairs++;
            if (matchedPairs === cardData.length / 2) {
                setTimeout(() => {
                    // S·ª≠ d·ª•ng modal t√πy ch·ªânh
                    showCustomAlert(`Ho√†n th√†nh sau ${flipCount} l·∫ßn l·∫≠t!`);
                }, 500);
            }
            resetBoard();
        }

        function unflipCards() {
            setTimeout(() => {
                flippedCards[0].classList.remove('flipped');
                flippedCards[1].classList.remove('flipped');
                resetBoard();
            }, 1500);
        }
        
        function resetBoard() {
            [flippedCards, lockBoard] = [[], false];
        }
        
        // --- 5.2 (M·ªöI) T√çNH NƒÇNG GAME WORD CONNECT ---
        
        function initWordConnectGame(level = 0) {
            wcCurrentLevel = level;
            wcCurrentPath = [];
            wcFoundInLevel = [];
            wcIsDrawing = false;
            wcNextLevelBtn.style.display = 'none';
            wcLevelInfoEl.textContent = `Level ${wcCurrentLevel + 1}`;
            
            if (level >= wcGameData.length) {
                wcLevelInfoEl.textContent = "B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£!";
                wcGridEl.innerHTML = "<p>Ch√∫c m·ª´ng!</p>";
                wcFoundListEl.innerHTML = "";
                wcCurrentWordEl.textContent = "";
                return;
            }
            
            loadWordConnectLevel(wcCurrentLevel);
        }
        
        function loadWordConnectLevel(levelIndex) {
            const level = wcGameData[levelIndex];
            wcGridEl.innerHTML = '';
            wcFoundListEl.innerHTML = '';
            wcCurrentWordEl.textContent = '';
            wcFoundInLevel = [];
            
            // Grid size (v√≠ d·ª•: 9 ch·ªØ = 3x3, 16 ch·ªØ = 4x4)
            const gridSize = Math.sqrt(level.grid.length);
            wcGridEl.style.gridTemplateColumns = `repeat(${gridSize}, 80px)`;
            
            wcGridLetters = [...level.grid]; // L∆∞u l·∫°i th·ª© t·ª± ch·ªØ
            
            wcGridLetters.forEach((letter, index) => {
                const letterEl = document.createElement('div');
                letterEl.classList.add('wc-letter');
                letterEl.textContent = letter;
                letterEl.dataset.index = index;
                letterEl.dataset.letter = letter;
                wcGridEl.appendChild(letterEl);
            });
        }
        
        function handleWCGridMouseStart(e) {
            e.preventDefault();
            if (e.target.classList.contains('wc-letter')) {
                wcIsDrawing = true;
                const el = e.target;
                wcCurrentPath = [{
                    el: el,
                    letter: el.dataset.letter,
                    index: parseInt(el.dataset.index)
                }];
                el.classList.add('selected');
                updateWCCurrentWord();
            }
        }

        function handleWCGridMouseMove(e) {
            e.preventDefault();
            if (!wcIsDrawing) return;
            
            const el = document.elementFromPoint(
                e.clientX || e.touches[0].clientX, 
                e.clientY || e.touches[0].clientY
            );
            
            if (el && el.classList.contains('wc-letter') && !el.classList.contains('selected')) {
                // TODO: Ki·ªÉm tra xem c√≥ ph·∫£i l√† √¥ li·ªÅn k·ªÅ kh√¥ng (b·ªè qua ƒë·ªÉ ƒë∆°n gi·∫£n)
                wcCurrentPath.push({
                    el: el,
                    letter: el.dataset.letter,
                    index: parseInt(el.dataset.index)
                });
                el.classList.add('selected');
                updateWCCurrentWord();
            }
        }
        
        function handleWCGridMouseEnd(e) {
            e.preventDefault();
            if (!wcIsDrawing) return;
            wcIsDrawing = false;
            checkWCWord();
            resetWCPath();
        }

        function updateWCCurrentWord() {
            wcCurrentWordEl.textContent = wcCurrentPath.map(item => item.letter).join('');
        }
        
        function resetWCPath() {
            wcCurrentPath.forEach(item => item.el.classList.remove('selected'));
            wcCurrentPath = [];
            // C·∫≠p nh·∫≠t t·ª´
            setTimeout(() => {
                wcCurrentWordEl.textContent = '';
            }, 200);
        }
        
        function checkWCWord() {
            const word = wcCurrentWordEl.textContent;
            const levelWords = wcGameData[wcCurrentLevel].words;
            
            if (word.length < 2) return;
            
            // Ki·ªÉm tra xem t·ª´ c√≥ h·ª£p l·ªá V√Ä ch∆∞a t√¨m th·∫•y
            if (levelWords.includes(word) && !wcFoundInLevel.includes(word)) {
                wcFoundInLevel.push(word);
                // Hi·ªÉn th·ªã t·ª´ ƒë√£ t√¨m th·∫•y
                const li = document.createElement('li');
                li.textContent = word;
                wcFoundListEl.appendChild(li);
                
                // Ki·ªÉm tra ho√†n th√†nh level
                if (wcFoundInLevel.length === levelWords.length) {
                    showCustomAlert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh level!");
                    wcNextLevelBtn.style.display = 'block';
                }
            }
        }
        
        function shuffleWCGrid() {
            // Tr·ªôn m·∫£ng wcGridLetters
            shuffleArray(wcGridLetters);
            // C·∫≠p nh·∫≠t l·∫°i c√°c √¥
            const letters = wcGridEl.querySelectorAll('.wc-letter');
            letters.forEach((el, index) => {
                const newLetter = wcGridLetters[index];
                el.textContent = newLetter;
                el.dataset.letter = newLetter;
            });
        }
        
        // --- 5.3 (M·ªöI) T√çNH NƒÇNG GAME FILL BLANK ---
        
        function initFillBlankGame() {
            fbCurrentQuestion = 0;
            fbScore = 0;
            fbGameAreaEl.style.display = 'block';
            fbResultsEl.style.display = 'none';
            fbCheckBtn.textContent = 'Ki·ªÉm tra';
            fbCheckBtn.onclick = checkFillBlankAnswer; // G√°n l·∫°i s·ª± ki·ªán ki·ªÉm tra
            loadFillBlankQuestion(fbCurrentQuestion);
        }
        
        function loadFillBlankQuestion(index) {
            if (index >= fbGameData.length) {
                showFillBlankResults();
                return;
            }
            
            const q = fbGameData[index];
            fbProgressEl.textContent = `C√¢u ${index + 1} / ${fbGameData.length}`;
            fbSentenceStartEl.textContent = q.start;
            fbSentenceEndEl.textContent = q.end;
            fbInputEl.value = '';
            fbFeedbackEl.textContent = '';
            fbFeedbackEl.className = 'fb-feedback';
            fbInputEl.disabled = false;
            fbCheckBtn.disabled = false;
        }
        
        function checkFillBlankAnswer() {
            const userAnswer = fbInputEl.value.trim().toLowerCase();
            const correctAnswer = fbGameData[fbCurrentQuestion].answer.toLowerCase();
            
            if (userAnswer === correctAnswer) {
                fbFeedbackEl.textContent = 'Ch√≠nh x√°c!';
                fbFeedbackEl.className = 'fb-feedback correct';
                fbScore++;
            } else {
                fbFeedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${fbGameData[fbCurrentQuestion].answer}`;
                fbFeedbackEl.className = 'fb-feedback wrong';
            }
            
            fbInputEl.disabled = true;
            fbCheckBtn.disabled = true;
            
            // Chuy·ªÉn sang c√¢u ti·∫øp theo
            setTimeout(() => {
                fbCurrentQuestion++;
                loadFillBlankQuestion(fbCurrentQuestion);
            }, 2000); // Ch·ªù 2 gi√¢y
        }
        
        function showFillBlankResults() {
            fbGameAreaEl.style.display = 'none';
            fbResultsEl.style.display = 'block';
            fbResultsScoreEl.textContent = `B·∫°n ƒë√∫ng ${fbScore} / ${fbGameData.length} c√¢u.`;
            
            // M·ªöI: C·∫≠p nh·∫≠t ƒëi·ªÉm l√™n b·∫£ng x·∫øp h·∫°ng (public)
            if (fbScore > 0) {
                updateUserScore(fbScore);
            }
        }

        // --- 6. (M·ªöI) T√çNH NƒÇNG TI·∫æN ƒê·ªò B√ÄI H·ªåC ---
        
        // ƒê√°nh d·∫•u ho√†n th√†nh
        window.markLessonComplete = async (lessonId) => {
            if (!currentUser) {
                showCustomAlert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn ƒë·ªô!");
                return;
            }
            
            const buttonEl = document.querySelector(`#page-${lessonId} .btn-complete`);
            if (buttonEl.classList.contains('completed')) return; // ƒê√£ ho√†n th√†nh

            // ƒê∆∞·ªùng d·∫´n private: /artifacts/{appId}/users/{userId}/lessonProgress/{lessonId}
            const docRef = doc(db, "artifacts", appId, "users", currentUser.uid, "lessonProgress", lessonId);
            
            try {
                await setDoc(docRef, {
                    completed: true,
                    timestamp: new Date(),
                    lessonId: lessonId // L∆∞u l·∫°i ID ƒë·ªÉ d·ªÖ truy v·∫•n ·ªü profile
                });
                buttonEl.textContent = 'ƒê√£ ho√†n th√†nh';
                buttonEl.classList.add('completed');
                buttonEl.disabled = true;
                
                // C·∫≠p nh·∫≠t icon ·ªü trang course
                const iconEl = document.getElementById(`icon-${lessonId}`);
                if (iconEl) {
                    iconEl.textContent = '‚úì';
                }
            } catch (error) {
                console.error("L·ªói khi l∆∞u ti·∫øn ƒë·ªô: ", error);
                showCustomAlert("ƒê√£ x·∫£y ra l·ªói khi l∆∞u ti·∫øn ƒë·ªô.");
            }
        }
        
        // Ki·ªÉm tra tr·∫°ng th√°i ho√†n th√†nh khi t·∫£i trang
        async function checkLessonCompletion(lessonId) {
            const buttonEl = document.querySelector(`#page-${lessonId} .btn-complete`);
            if (!buttonEl) return;
            
            // Reset tr·∫°ng th√°i n√∫t
            buttonEl.textContent = 'Ho√†n th√†nh b√†i h·ªçc';
            buttonEl.classList.remove('completed');
            buttonEl.disabled = false;

            if (!currentUser) return; // Ch∆∞a ƒëƒÉng nh·∫≠p, kh√¥ng c·∫ßn ki·ªÉm tra
            
            const docRef = doc(db, "artifacts", appId, "users", currentUser.uid, "lessonProgress", lessonId);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().completed) {
                    buttonEl.textContent = 'ƒê√£ ho√†n th√†nh';
                    buttonEl.classList.add('completed');
                    buttonEl.disabled = true;
                }
            } catch (error) {
                console.error("L·ªói khi ki·ªÉm tra ti·∫øn ƒë·ªô: ", error);
            }
        }
        
        // T·∫£i t·∫•t c·∫£ tr·∫°ng th√°i ho√†n th√†nh cho trang t·ªïng quan (Cambridge, Global Success)
        async function loadAllLessonCompletions(courseType) {
            // X√≥a c√°c icon c≈©
            document.querySelectorAll(`#page-${courseType} .completion-icon`).forEach(icon => {
                icon.textContent = '';
            });

            if (!currentUser) return; // Kh√¥ng hi·ªÉn th·ªã check n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p

            // L·∫•y t·∫•t c·∫£ doc t·ª´ collection 'lessonProgress'
            const collRef = collection(db, "artifacts", appId, "users", currentUser.uid, "lessonProgress");
            const q = query(collRef, where("completed", "==", true));
            
            try {
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    const lessonId = doc.id; // ID l√† 'cambridge-unit1', v.v.
                    // Ch·ªâ c·∫≠p nh·∫≠t icon n·∫øu n√≥ t·ªìn t·∫°i tr√™n trang hi·ªán t·∫°i
                    const iconEl = document.getElementById(`icon-${lessonId}`);
                    if (iconEl) {
                        iconEl.textContent = '‚úì'; // Th√™m d·∫•u check
                    }
                });
            } catch (error) {
                console.error("L·ªói khi t·∫£i to√†n b·ªô ti·∫øn ƒë·ªô: ", error);
            }
        }

        // --- 7. (M·ªöI) T√çNH NƒÇNG B√åNH LU·∫¨N ---

        // T·∫£i v√† l·∫Øng nghe b√¨nh lu·∫≠n (real-time)
        async function loadComments(lessonId) {
            const commentListEl = document.getElementById(`comment-list-${lessonId}`);
            if (!commentListEl) return;

            commentListEl.innerHTML = "<p>ƒêang t·∫£i b√¨nh lu·∫≠n...</p>";
            
            // ƒê∆∞·ªùng d·∫´n public: /artifacts/{appId}/public/data/lessonComments
            const collRef = collection(db, "artifacts", appId, "public", "data", "lessonComments");
            
            // T·∫°o query ƒë·ªÉ l·ªçc theo lessonId
            // KH√îNG D√ôNG orderBy v√¨ c√≥ th·ªÉ y√™u c·∫ßu index
            const q = query(collRef, where("lessonId", "==", lessonId));
            
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    commentListEl.innerHTML = "<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>";
                    return;
                }
                
                let comments = [];
                querySnapshot.forEach((doc) => {
                    comments.push(doc.data());
                });
                
                // S·∫Øp x·∫øp th·ªß c√¥ng trong JS (v√¨ orderBy c√≥ th·ªÉ g√¢y l·ªói index)
                comments.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                commentListEl.innerHTML = ''; // X√≥a n·ªôi dung "ƒêang t·∫£i..."
                comments.forEach(comment => {
                    renderComment(lessonId, comment);
                });
                
                // T·ª± ƒë·ªông cu·ªôn xu·ªëng cu·ªëi
                commentListEl.scrollTop = commentListEl.scrollHeight;

            }, (error) => {
                console.error("L·ªói khi t·∫£i b√¨nh lu·∫≠n: ", error);
                commentListEl.innerHTML = "<p style='color:red;'>Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n.</p>";
            });

            // L∆∞u l·∫°i h√†m unsub ƒë·ªÉ d·ªçn d·∫πp khi chuy·ªÉn trang
            lessonUnsubscribers[lessonId] = unsubscribe;
        }

        // Hi·ªÉn th·ªã 1 b√¨nh lu·∫≠n
        function renderComment(lessonId, data) {
            const commentListEl = document.getElementById(`comment-list-${lessonId}`);
            if (!commentListEl) return;
            
            const item = document.createElement('div');
            item.className = 'comment-item';
            
            const timestamp = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000) : new Date();
            // L·∫•y t√™n user (ph·∫ßn tr∆∞·ªõc @) t·ª´ email, ho·∫∑c 6 k√Ω t·ª± ƒë·∫ßu c·ªßa UID, ho·∫∑c '·∫©n danh'
            const emailName = data.email ? data.email.split('@')[0] : (data.userId ? data.userId.substring(0, 6) : 'Anonymous');
            
            // XSS mitigation (ƒë∆°n gi·∫£n): thay th·∫ø < >
            const safeText = data.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            item.innerHTML = `
                <strong>${emailName}</strong>
                <p>${safeText}</p>
                <small>${timestamp.toLocaleString('vi-VN')}</small>
            `;
            commentListEl.appendChild(item);
        }

        // G·ª≠i b√¨nh lu·∫≠n
        window.postComment = async (lessonId) => {
            const inputEl = document.getElementById(`comment-input-${lessonId}`);
            const formEl = document.getElementById(`comment-form-${lessonId}`);
            const text = inputEl.value.trim();
            
            // X√≥a th√¥ng b√°o l·ªói c≈© (n·∫øu c√≥)
            const oldMsg = formEl.querySelector('.auth-message');
            if (oldMsg) oldMsg.style.display = 'none';

            if (!text) return; // Kh√¥ng g·ª≠i n·∫øu r·ªóng
            
            if (!currentUser || currentUser.isAnonymous) {
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói ngay tr√™n form
                let msgEl = formEl.querySelector('.auth-message');
                if (!msgEl) {
                    msgEl = document.createElement('div');
                    msgEl.className = 'auth-message error'; // D√πng l·∫°i CSS c·ªßa form auth
                    formEl.prepend(msgEl); // Th√™m v√†o ƒë·∫ßu form
                }
                msgEl.textContent = 'B·∫°n c·∫ßn ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω ƒë·ªÉ b√¨nh lu·∫≠n!';
                msgEl.style.display = 'block';
                return;
            }
            
            // ƒê∆∞·ªùng d·∫´n public
            const collRef = collection(db, "artifacts", appId, "public", "data", "lessonComments");
            
            try {
                // T·∫Øt n√∫t g·ª≠i
                formEl.querySelector('button').disabled = true;
                
                await addDoc(collRef, {
                    lessonId: lessonId,
                    text: text,
                    userId: currentUser.uid,
                    email: currentUser.email || null, // L∆∞u email (n·∫øu c√≥)
                    timestamp: new Date()
                });
                inputEl.value = ''; // X√≥a input
                
            } catch (error) {
                console.error("L·ªói khi g·ª≠i b√¨nh lu·∫≠n: ", error);
                // Hi·ªÉn th·ªã l·ªói
                let msgEl = formEl.querySelector('.auth-message');
                if (!msgEl) {
                    msgEl = document.createElement('div');
                    msgEl.className = 'auth-message error';
                    formEl.prepend(msgEl);
                }
                msgEl.textContent = 'L·ªói khi g·ª≠i b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.';
                msgEl.style.display = 'block';
            } finally {
                // M·ªü l·∫°i n√∫t g·ª≠i
                formEl.querySelector('button').disabled = false;
            }
        }
        
        // --- 8. (M·ªöI) T√çNH NƒÇNG AI - T·ª™ V·ª∞NG M·ªñI NG√ÄY ---

        // H√†m g·ªçi API v·ªõi exponential backoff
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            let delay = 1000; // 1 gi√¢y
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Ch·ªâ retry l·ªói 429 (Too Many Requests)
                        if (response.status === 429) {
                            throw new Error('Rate limit exceeded');
                        }
                        // Kh√¥ng retry c√°c l·ªói kh√°c (vd: 400, 500)
                        return response; 
                    }
                    return response; // Th√†nh c√¥ng
                } catch (error) {
                    // Ch·ªâ log l·ªói retry, kh√¥ng log l·ªói cu·ªëi c√πng
                    if (i < maxRetries - 1) {
                         // Kh√¥ng log l·ªói ra console
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // TƒÉng g·∫•p ƒë√¥i th·ªùi gian ch·ªù
                    } else {
                        throw error; // N√©m l·ªói cu·ªëi c√πng
                    }
                }
            }
        }


        // H√†m l·∫•y t·ª´ v·ª±ng (Gemini)
        async function fetchWordOfTheDay() {
            if (isFetchingWord) return; // Kh√¥ng g·ªçi n·∫øu ƒëang g·ªçi
            isFetchingWord = true;
            
            // C·∫≠p nh·∫≠t UI sang tr·∫°ng th√°i loading
            wordLoadingEl.style.display = 'block';
            wordDisplayEl.style.display = 'none';
            wordErrorEl.style.display = 'none';
            newWordBtn.disabled = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = "B·∫°n l√† gi√°o vi√™n ti·∫øng Anh cho h·ªçc sinh l·ªõp 5. H√£y cung c·∫•p m·ªôt t·ª´ v·ª±ng ti·∫øng Anh (term), ƒë·ªãnh nghƒ©a ti·∫øng Vi·ªát (definition), v√† m·ªôt c√¢u v√≠ d·ª• ti·∫øng Anh c√≥ k√®m d·ªãch ti·∫øng Vi·ªát (example). Ch·ªâ tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng JSON.";
            const userQuery = "M·ªôt t·ª´ v·ª±ng ti·∫øng Anh ph·ªï bi·∫øn, ph√π h·ª£p cho h·ªçc sinh l·ªõp 5.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "term": { "type": "STRING" },
                            "definition": { "type": "STRING" },
                            "example": { "type": "STRING" }
                        },
                        required: ["term", "definition", "example"]
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const data = JSON.parse(jsonText);
                    
                    // C·∫≠p nh·∫≠t UI
                    updateWordUI(data.term, data.definition, data.example);
                    // T·∫°o h√¨nh ·∫£nh
                    await generateImageForWord(data.term);
                    
                } else {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI.");
                }

            } catch (error) {
                console.error("L·ªói khi l·∫•y t·ª´ v·ª±ng: ", error);
                wordErrorEl.style.display = 'block';
                wordLoadingEl.style.display = 'none';
            } finally {
                isFetchingWord = false;
                newWordBtn.disabled = false;
            }
        }
        
        // C·∫≠p nh·∫≠t UI cho t·ª´ v·ª±ng
        function updateWordUI(term, definition, example) {
            wordTermEl.textContent = term.charAt(0).toUpperCase() + term.slice(1); // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
            wordDefinitionEl.textContent = definition;
            wordExampleEl.textContent = example;
            
            wordLoadingEl.style.display = 'none';
            wordDisplayEl.style.display = 'grid'; // Chuy·ªÉn sang grid
        }
        
        // H√†m t·∫°o h√¨nh ·∫£nh (Imagen)
        async function generateImageForWord(term) {
            // Hi·ªÉn th·ªã loading cho h√¨nh ·∫£nh
            wordImageEl.src = ""; // X√≥a ·∫£nh c≈©
            wordImageEl.alt = "ƒêang t·∫°o h√¨nh ·∫£nh...";
            // (Ch√∫ng ta c√≥ th·ªÉ th√™m 1 spinner nh·ªè v√†o .word-image-container n·∫øu mu·ªën)

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            // Prompt chi ti·∫øt h∆°n ƒë·ªÉ c√≥ h√¨nh ·∫£nh ƒë·∫πp
            const prompt = `M·ªôt h√¨nh ·∫£nh minh h·ªça ƒë∆°n gi·∫£n, th√¢n thi·ªán v·ªõi tr·∫ª em, phong c√°ch ho·∫°t h√¨nh (cartoon style) cho t·ª´ "${term}".`;

            const payload = {
                instances: { prompt: prompt },
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    wordImageEl.src = imageUrl;
                    wordImageEl.alt = `H√¨nh ·∫£nh minh h·ªça cho t·ª´ "${term}"`;
                } else {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c h√¨nh ·∫£nh t·ª´ AI.");
                }
            } catch (error) {
                console.error("L·ªói khi t·∫°o h√¨nh ·∫£nh: ", error);
                wordImageEl.src = `https://placehold.co/300x250/f0f0f0/aaa?text=L·ªói+t·∫°o+·∫£nh`;
                wordImageEl.alt = "L·ªói khi t·∫°o h√¨nh ·∫£nh";
            }
        }


        // --- 9. (M·ªöI) T√çNH NƒÇNG B·∫¢NG X·∫æP H·∫†NG (Vi·∫øt ƒëi·ªÉm) ---

        /**
         * C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm c·ªßa ng∆∞·ªùi d√πng tr√™n b·∫£ng x·∫øp h·∫°ng (public).
         * @param {number} scoreToAdd S·ªë ƒëi·ªÉm mu·ªën c·ªông th√™m.
         */
        async function updateUserScore(scoreToAdd) {
            if (!currentUser || currentUser.isAnonymous) {
                // Kh√¥ng l∆∞u ƒëi·ªÉm cho kh√°ch ho·∫∑c ng∆∞·ªùi d√πng ·∫©n danh
                console.log("Kh√¥ng l∆∞u ƒëi·ªÉm (kh√°ch/·∫©n danh).");
                return; 
            }
            
            if (scoreToAdd <= 0) return; // Kh√¥ng l√†m g√¨ n·∫øu ƒëi·ªÉm l√† 0

            // ƒê∆∞·ªùng d·∫´n public: /artifacts/{appId}/public/data/leaderboard/{userId}
            const docRef = doc(db, "artifacts", appId, "public", "data", "leaderboard", currentUser.uid);

            try {
                // S·ª≠ d·ª•ng setDoc v·ªõi { merge: true } v√† increment
                // ƒë·ªÉ t·∫°o m·ªõi ho·∫∑c c·∫≠p nh·∫≠t t√†i li·ªáu
                await setDoc(docRef, {
                    totalScore: increment(scoreToAdd), // C·ªông d·ªìn ƒëi·ªÉm
                    userId: currentUser.uid,
                    // L∆∞u email ƒë·ªÉ hi·ªÉn th·ªã (ch·ªâ l∆∞u ph·∫ßn tr∆∞·ªõc @)
                    displayName: currentUser.email ? currentUser.email.split('@')[0] : currentUser.uid.substring(0, 6),
                    lastUpdated: new Date()
                }, { merge: true }); // Merge: true ƒë·ªÉ kh√¥ng ghi ƒë√® c√°c tr∆∞·ªùng kh√°c n·∫øu doc t·ªìn t·∫°i

                console.log(`ƒê√£ c·∫≠p nh·∫≠t ${scoreToAdd} ƒëi·ªÉm cho user ${currentUser.uid} (public)`);
                
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t ƒëi·ªÉm (leaderboard):", error);
            }
        }
        
        // --- 10. (M·ªöI) T√çNH NƒÇNG B·∫¢NG X·∫æP H·∫†NG (ƒê·ªçc ƒëi·ªÉm) ---

        async function loadLeaderboard() {
            leaderboardContainerEl.innerHTML = '<p id="leaderboard-loading">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>';
            
            // ƒê∆∞·ªùng d·∫´n public: /artifacts/{appId}/public/data/leaderboard
            const collRef = collection(db, "artifacts", appId, "public", "data", "leaderboard");
            
            // T·∫°o query: L·∫•y t·∫•t c·∫£
            // Ch√∫ng ta s·∫Ω kh√¥ng d√πng orderBy("totalScore", "desc") v√¨ n√≥ y√™u c·∫ßu index
            // Thay v√†o ƒë√≥, ch√∫ng ta s·∫Ω s·∫Øp x·∫øp th·ªß c√¥ng b·∫±ng JS
            const q = query(collRef); 

            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    leaderboardContainerEl.innerHTML = '<p>Ch∆∞a c√≥ ai tr√™n b·∫£ng x·∫øp h·∫°ng. H√£y ch∆°i game ƒë·ªÉ tr·ªü th√†nh ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>';
                    return;
                }
                
                let leaderboardData = [];
                querySnapshot.forEach((doc) => {
                    leaderboardData.push(doc.data());
                });
                
                // S·∫Øp x·∫øp th·ªß c√¥ng b·∫±ng JavaScript (gi·∫£m d·∫ßn)
                leaderboardData.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                
                // L·∫•y 10 ng∆∞·ªùi ƒë·ª©ng ƒë·∫ßu
                const top10 = leaderboardData.slice(0, 10);

                // Render b·∫£ng
                let html = `
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>T√™n ng∆∞·ªùi ch∆°i</th>
                                <th>T·ªïng ƒëi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                top10.forEach((data, index) => {
                    const rank = index + 1;
                    const name = data.displayName || data.userId.substring(0, 6) || 'Anonymous';
                    const score = data.totalScore || 0;
                    
                    html += `
                        <tr>
                            <td>${rank}</td>
                            <td>${name}</td>
                            <td>${score}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                leaderboardContainerEl.innerHTML = html;

            } catch (error) {
                console.error("L·ªói khi t·∫£i b·∫£ng x·∫øp h·∫°ng:", error);
                leaderboardContainerEl.innerHTML = '<p style="color: red;">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            }
        }


        // --- 11. KH·ªûI T·∫†O APP KHI DOM ƒê√É T·∫¢I ---
        
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Kh·ªüi t·∫°o Firebase
            try {
                // firebaseConfig ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü tr√™n
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng.");

                // L·∫Øng nghe thay ƒë·ªïi tr·∫°ng th√°i Auth
                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p (c√≥ email)
                        currentUser = user;
                        loginLink.style.display = 'none';
                        registerLink.style.display = 'none';
                        profileLink.style.display = 'block';
                        logoutLink.style.display = 'block';
                    } else {
                        // Ng∆∞·ªùi d√πng ·∫©n danh ho·∫∑c ƒë√£ ƒëƒÉng xu·∫•t
                        currentUser = user; // (c√≥ th·ªÉ l√† user ·∫©n danh, ho·∫∑c null)
                        loginLink.style.display = 'block';
                        registerLink.style.display = 'block';
                        profileLink.style.display = 'none';
                        logoutLink.style.display = 'none';
                    }
                    
                    // (M·ªöI) T·∫£i l·∫°i d·ªØ li·ªáu trang khi auth thay ƒë·ªïi (v√≠ d·ª•: ƒëƒÉng nh·∫≠p/ƒëƒÉng xu·∫•t)
                    // C·∫ßn t·∫£i l·∫°i ti·∫øn ƒë·ªô v√† b√¨nh lu·∫≠n
                    window.showPage(currentPage);
                });

                // ƒêƒÉng nh·∫≠p ban ƒë·∫ßu
                // token ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü tr√™n
                if (token) {
                    await signInWithCustomToken(auth, token);
                    console.log("ƒêƒÉng nh·∫≠p b·∫±ng Custom Token th√†nh c√¥ng.");
                } else {
                    await signInAnonymously(auth);
                    console.log("ƒêƒÉng nh·∫≠p ·∫©n danh th√†nh c√¥ng.");
                }

            } catch (error) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase: ", error);
                // L·ªói n√†y th∆∞·ªùng x·∫£y ra n·∫øu firebaseConfig kh√¥ng h·ª£p l·ªá
                // Th√¥ng b√°o l·ªói ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ph·∫ßn ki·ªÉm tra config
            }

            // G√°n c√°c Element cho bi·∫øn
            videoModal = document.getElementById('video-modal');
            modalVideoTitle = document.getElementById('modal-video-title');
            modalVideoIframe = document.getElementById('modal-video-iframe');
            // M·ªöI: G√°n bi·∫øn cho alert
            modalAlertContent = document.getElementById('modal-alert-content');
            modalAlertText = document.getElementById('modal-alert-text');


            // G√°n element cho Auth & Profile
            loginLink = document.getElementById('login-link');
            registerLink = document.getElementById('register-link');
            profileLink = document.getElementById('profile-link');
            logoutLink = document.getElementById('logout-link');
            profileEmailEl = document.getElementById('profile-email');
            profileUserIdEl = document.getElementById('profile-userid');
            profileLogoutBtn = document.getElementById('profile-logout-btn');
            profileQuizResultsEl = document.getElementById('profile-quiz-results');
            // M·ªöI: G√°n bi·∫øn cho ti·∫øn ƒë·ªô b√†i h·ªçc profile
            profileLessonProgressEl = document.getElementById('profile-lesson-progress');

            // G√°n element cho Quiz
            quizTitleEl = document.getElementById('quiz-title');
            quizQuestionEl = document.getElementById('quiz-question');
            quizOptionsEl = document.getElementById('quiz-options');
            quizNextBtn = document.getElementById('quiz-next-btn');
            quizContentEl = document.getElementById('quiz-content');
            quizResultEl = document.getElementById('quiz-result');
            quizScoreEl = document.getElementById('quiz-score');
            
            // G√°n element cho Game
            flashcardGrid = document.getElementById('flashcard-grid');
            flipsEl = document.getElementById('flashcard-flips');
            
            // M·ªöI: G√°n element cho Game Word Connect
            wcGridEl = document.getElementById('wc-grid');
            wcFoundWordsEl = document.getElementById('wc-found-words');
            wcFoundListEl = document.getElementById('wc-found-list');
            wcCurrentWordEl = document.getElementById('wc-current-word');
            wcShuffleBtn = document.getElementById('wc-shuffle-btn');
            wcNextLevelBtn = document.getElementById('wc-next-level-btn');
            wcLevelInfoEl = document.getElementById('wc-level-info');

            // M·ªöI: G√°n element cho Game Fill Blank
            fbSentenceStartEl = document.getElementById('fb-sentence-start');
            fbSentenceEndEl = document.getElementById('fb-sentence-end');
            fbInputEl = document.getElementById('fb-input');
            fbCheckBtn = document.getElementById('fb-check-btn');
            fbFeedbackEl = document.getElementById('fb-feedback');
            fbProgressEl = document.getElementById('fb-progress');
            fbGameAreaEl = document.getElementById('fb-game-area');
            fbResultsEl = document.getElementById('fb-results');
            fbResultsScoreEl = document.getElementById('fb-results-score');
            fbRestartBtn = document.getElementById('fb-restart-btn');

            // M·ªöI: G√°n element cho t√≠nh nƒÉng AI
            wordLoadingEl = document.getElementById('word-loading');
            wordDisplayEl = document.getElementById('word-display');
            wordImageEl = document.getElementById('word-image');
            wordTermEl = document.getElementById('word-term');
            wordDefinitionEl = document.getElementById('word-definition');
            wordExampleEl = document.getElementById('word-example');
            wordErrorEl = document.getElementById('word-error');
            newWordBtn = document.getElementById('new-word-btn');
            
            // M·ªöI: G√°n element cho B·∫£ng x·∫øp h·∫°ng
            leaderboardContainerEl = document.getElementById('leaderboard-table-container');
            leaderboardLoadingEl = document.getElementById('leaderboard-loading');

            // Th√™m tr√¨nh x·ª≠ l√Ω s·ª± ki·ªán
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            
            // M·ªöI: Th√™m s·ª± ki·ªán cho game
            wcGridEl.addEventListener('mousedown', handleWCGridMouseStart);
            document.addEventListener('mousemove', handleWCGridMouseMove);
            document.addEventListener('mouseup', handleWCGridMouseEnd);
            // Th√™m s·ª± ki·ªán touch
            wcGridEl.addEventListener('touchstart', handleWCGridMouseStart, { passive: false });
            document.addEventListener('touchmove', handleWCGridMouseMove, { passive: false });
            document.addEventListener('touchend', handleWCGridMouseEnd);
            
            wcShuffleBtn.addEventListener('click', shuffleWCGrid);
            wcNextLevelBtn.addEventListener('click', () => initWordConnectGame(wcCurrentLevel + 1));
            
            fbCheckBtn.addEventListener('click', checkFillBlankAnswer);
            fbRestartBtn.addEventListener('click', initFillBlankGame);

            // M·ªöI: Th√™m s·ª± ki·ªán cho n√∫t AI
            newWordBtn.addEventListener('click', fetchWordOfTheDay);

            // Hi·ªÉn th·ªã trang ch·ªß ban ƒë·∫ßu
            window.showPage('home');
            
            // M·ªöI: T·∫£i t·ª´ v·ª±ng l·∫ßn ƒë·∫ßu khi v√†o trang
            fetchWordOfTheDay();
        });

    </script>

</body>
</html>
